<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <title>CosmoDance Chat</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: radial-gradient(circle at top, #ff4fd1 0, #2b1142 45%, #050014 100%);
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
      }
      .chat-wrapper {
        width: 100%;
        max-width: 520px;
        height: 90vh;
        max-height: 760px;
        background: rgba(6, 2, 26, 0.9);
        border-radius: 24px;
        box-shadow: 0 18px 45px rgba(0, 0, 0, 0.6);
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }
      .chat-header {
        padding: 14px 20px;
        background: linear-gradient(90deg, #ff4fd1, #ff9b5d);
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .chat-header-left {
        display: flex;
        flex-direction: column;
      }
      .chat-title {
        font-weight: 700;
        font-size: 16px;
      }
      .chat-subtitle {
        font-size: 12px;
        opacity: 0.9;
      }
      .chat-logo {
        font-weight: 800;
        letter-spacing: 0.08em;
      }
      .chat-body {
        flex: 1;
        padding: 14px 16px 8px;
        overflow-y: auto;
      }
      .chat-footer {
        padding: 10px 12px 14px;
        border-top: 1px solid rgba(255, 255, 255, 0.08);
        background: rgba(6, 2, 26, 0.95);
      }
      .input-row {
        display: flex;
        gap: 8px;
      }
      .chat-input {
        flex: 1;
        padding: 10px 12px;
        border-radius: 999px;
        border: none;
        outline: none;
        font-size: 14px;
        background: rgba(255, 255, 255, 0.06);
        color: #fff;
      }
      .chat-input::placeholder {
        color: rgba(255, 255, 255, 0.5);
      }
      .send-btn {
        padding: 10px 18px;
        border-radius: 999px;
        border: none;
        cursor: pointer;
        font-weight: 600;
        font-size: 14px;
        background: linear-gradient(90deg, #ff4fd1, #ff9b5d);
        color: #fff;
        white-space: nowrap;
      }
      .send-btn:disabled {
        opacity: 0.6;
        cursor: default;
      }
      .messages {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .msg-row {
        display: flex;
      }
      .msg-row.user {
        justify-content: flex-end;
      }
      .msg-row.assistant {
        justify-content: flex-start;
      }
      .bubble {
        max-width: 80%;
        padding: 10px 12px;
        border-radius: 16px;
        font-size: 14px;
        line-height: 1.4;
        white-space: pre-wrap;
        word-wrap: break-word;
      }
      .bubble.assistant {
        background: rgba(34, 29, 76, 0.95);
      }
      .bubble.user {
        background: linear-gradient(135deg, #ff4fd1, #ff9b5d);
      }
      .bubble.system {
        background: rgba(255, 255, 255, 0.06);
        font-size: 12px;
        opacity: 0.9;
      }
      .typing-dots {
        display: inline-flex;
        gap: 3px;
        align-items: center;
      }
      .typing-dots span {
        width: 4px;
        height: 4px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.8);
        animation: blink 1s infinite ease-in-out;
      }
      .typing-dots span:nth-child(2) {
        animation-delay: 0.15s;
      }
      .typing-dots span:nth-child(3) {
        animation-delay: 0.3s;
      }
      @keyframes blink {
        0%,
        80%,
        100% {
          opacity: 0.2;
          transform: translateY(0);
        }
        40% {
          opacity: 1;
          transform: translateY(-2px);
        }
      }
      .top-controls {
        padding: 4px 16px 0;
        display: flex;
        justify-content: flex-end;
        font-size: 11px;
        opacity: 0.7;
      }
      .link-reset {
        border: none;
        background: transparent;
        color: rgba(255, 255, 255, 0.8);
        cursor: pointer;
        text-decoration: underline;
        padding: 0;
        font-size: 11px;
      }
      .status-bar {
        margin-top: 4px;
        font-size: 11px;
        opacity: 0.7;
        text-align: center;
      }
      @media (max-width: 600px) {
        .chat-wrapper {
          height: 100vh;
          max-height: none;
          border-radius: 0;
        }
      }
    </style>
  </head>
  <body>
    <div class="chat-wrapper">
      <div class="chat-header">
        <div class="chat-header-left">
          <div class="chat-title">CosmoDance Chat</div>
          <div class="chat-subtitle">–û–Ω–ª–∞–π–Ω-–ø–æ–º–æ—â–Ω–∏–∫ —Å—Ç—É–¥–∏–∏ —Ç–∞–Ω—Ü–µ–≤</div>
        </div>
        <div class="chat-logo">COSMO</div>
      </div>

      <div class="top-controls">
        <button class="link-reset" id="resetBtn">–ù–∞—á–∞—Ç—å —Å–Ω–∞—á–∞–ª–∞</button>
      </div>

      <div class="chat-body">
        <div class="messages" id="messages"></div>
      </div>

      <div class="chat-footer">
        <div class="input-row">
          <input
            id="input"
            class="chat-input"
            type="text"
            autocomplete="off"
            placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–≤–æ–π –≤–æ–ø—Ä–æ—Å –æ —Å—Ç—É–¥–∏–∏‚Ä¶"
          />
          <button id="sendBtn" class="send-btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
        <div class="status-bar" id="statusBar">
          –î–∏–∞–ª–æ–≥ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è, –ø–æ–∫–∞ –≤—ã –Ω–µ –Ω–∞–∂–º—ë—Ç–µ ¬´–ù–∞—á–∞—Ç—å —Å–Ω–∞—á–∞–ª–∞¬ª –∏–ª–∏ –Ω–µ
          –±—É–¥–µ—Ç –¥–ª–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø–µ—Ä–µ—Ä—ã–≤–∞.
        </div>
      </div>
    </div>

    <script>
      // --------- –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ ---------
      const TYPING_SPEED = 40; // –º—Å –Ω–∞ —Å–∏–º–≤–æ–ª ‚Äî –º–µ–¥–ª–µ–Ω–Ω–µ–µ, –∫–∞–∫ —á–µ–ª–æ–≤–µ–∫
      const INACTIVITY_LIMIT_MS = 10 * 60 * 1000; // 10 –º–∏–Ω—É—Ç
      const STORAGE_KEY_HISTORY = "cosmo_chat_history";
      const STORAGE_KEY_LAST_ACTIVITY = "cosmo_chat_last_activity";

      const messagesEl = document.getElementById("messages");
      const inputEl = document.getElementById("input");
      const sendBtn = document.getElementById("sendBtn");
      const resetBtn = document.getElementById("resetBtn");
      const statusBar = document.getElementById("statusBar");

      let history = [];
      let isSending = false;
      let typingTimer = null;
      let inactivityTimer = null;

      // --------- helpers ---------
      function saveHistory() {
        try {
          localStorage.setItem(STORAGE_KEY_HISTORY, JSON.stringify(history));
          localStorage.setItem(
            STORAGE_KEY_LAST_ACTIVITY,
            String(Date.now())
          );
        } catch (e) {
          console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é", e);
        }
      }

      function clearHistory() {
        history = [];
        try {
          localStorage.removeItem(STORAGE_KEY_HISTORY);
          localStorage.removeItem(STORAGE_KEY_LAST_ACTIVITY);
        } catch {}
      }

      function loadHistory() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY_HISTORY);
          const ts = Number(localStorage.getItem(STORAGE_KEY_LAST_ACTIVITY) || "0");
          if (!raw) return [];
          const now = Date.now();
          if (ts && now - ts > INACTIVITY_LIMIT_MS) {
            // —Å–ª–∏—à–∫–æ–º —Å—Ç–∞—Ä—ã–π –¥–∏–∞–ª–æ–≥
            clearHistory();
            return [];
          }
          const parsed = JSON.parse(raw);
          return Array.isArray(parsed) ? parsed : [];
        } catch (e) {
          console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é", e);
          return [];
        }
      }

      function scrollToBottom() {
        setTimeout(() => {
          messagesEl.parentElement.scrollTop = messagesEl.parentElement.scrollHeight;
        }, 10);
      }

      function createBubble(role, text, extraClass = "") {
        const row = document.createElement("div");
        row.className = `msg-row ${role}`;
        const bubble = document.createElement("div");
        bubble.className = `bubble ${role} ${extraClass}`;
        bubble.textContent = text;
        row.appendChild(bubble);
        messagesEl.appendChild(row);
        scrollToBottom();
        return bubble;
      }

      function renderHistory() {
        messagesEl.innerHTML = "";
        if (history.length === 0) {
          // —Å—Ç–∞—Ä—Ç–æ–≤–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –±–æ—Ç–∞
          const startText =
            "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! üëã –Ø –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç —Å—Ç—É–¥–∏–∏ —Ç–∞–Ω—Ü–µ–≤ CosmoDance.\n\n" +
            "–û—Ç–≤–µ—á–∞—é –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ —Ñ–∏–ª–∏–∞–ª–∞—Ö, –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è—Ö, —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–∏ –∏ –∑–∞–ø–∏—Å–∏ –Ω–∞ –∑–∞–Ω—è—Ç–∏—è. " +
            "–ù–∞–ø–∏—à–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, —á—Ç–æ –≤—ã —Ö–æ—Ç–µ–ª–∏ –±—ã —É–∑–Ω–∞—Ç—å –∏–ª–∏ —á–µ–º —è –º–æ–≥—É –ø–æ–º–æ—á—å üôÇ";
          const row = document.createElement("div");
          row.className = "msg-row assistant";
          const b = document.createElement("div");
          b.className = "bubble assistant";
          b.textContent = startText;
          row.appendChild(b);
          messagesEl.appendChild(row);
          scrollToBottom();
          return;
        }

        for (const msg of history) {
          const role = msg.role === "assistant" ? "assistant" : "user";
          createBubble(role, msg.content);
        }
      }

      function setSendingState(flag) {
        isSending = flag;
        sendBtn.disabled = flag;
        inputEl.disabled = flag;
      }

      function resetInactivityTimer(reasonOnFinish) {
        if (inactivityTimer) clearTimeout(inactivityTimer);
        inactivityTimer = setTimeout(() => {
          if (history.length === 0) return;
          endDialog(reasonOnFinish || "10 –º–∏–Ω—É—Ç –±–µ–∑–¥–µ–π—Å—Ç–≤–∏—è");
        }, INACTIVITY_LIMIT_MS);
      }

      async function endDialog(reason) {
        try {
          // –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç—á—ë—Ç
          await fetch("/report", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ history, reason }),
          });
        } catch (e) {
          console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—á—ë—Ç", e);
        }

        clearHistory();
        renderHistory();
        statusBar.textContent =
          "–î–∏–∞–ª–æ–≥ –Ω–∞—á–∞—Ç –∑–∞–Ω–æ–≤–æ. –í—ã –º–æ–∂–µ—Ç–µ –∑–∞–¥–∞—Ç—å –Ω–æ–≤—ã–π –≤–æ–ø—Ä–æ—Å.";
      }

      // --------- –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è ---------
      async function sendMessage() {
        const text = (inputEl.value || "").trim();
        if (!text || isSending) return;

        // –¥–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const userMsg = { role: "user", content: text };
        history.push(userMsg);
        createBubble("user", text);
        inputEl.value = "";
        saveHistory();
        resetInactivityTimer("–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–∫—Ä—ã–ª –¥–∏–∞–ª–æ–≥ –≤—Ä—É—á–Ω—É—é");

        setSendingState(true);

        // —Å–æ–∑–¥–∞—ë–º "–ø–∏—à–µ—Ç..." –æ—Ç –±–æ—Ç–∞
        const typingRow = document.createElement("div");
        typingRow.className = "msg-row assistant";
        const typingBubble = document.createElement("div");
        typingBubble.className = "bubble assistant";
        const dots = document.createElement("div");
        dots.className = "typing-dots";
        dots.innerHTML = "<span></span><span></span><span></span>";
        typingBubble.appendChild(dots);
        typingRow.appendChild(typingBubble);
        messagesEl.appendChild(typingRow);
        scrollToBottom();

        try {
          const response = await fetch("/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ history }),
          });

          if (!response.ok) {
            throw new Error("HTTP " + response.status);
          }

          const data = await response.json();
          const replyText =
            (data && data.reply) ||
            "–ò–∑–≤–∏–Ω–∏—Ç–µ, –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å.";

          // —É–±–∏—Ä–∞–µ–º "–ø–∏—à–µ—Ç..."
          messagesEl.removeChild(typingRow);

          const botMsg = { role: "assistant", content: replyText };
          history.push(botMsg);
          saveHistory();

          // —ç—Ñ—Ñ–µ–∫—Ç –ø–µ—á–∞—Ç–∞–Ω–∏—è
          const bubble = createBubble("assistant", "");
          let idx = 0;
          if (typingTimer) clearInterval(typingTimer);
          typingTimer = setInterval(() => {
            bubble.textContent = replyText.slice(0, idx);
            idx++;
            if (idx > replyText.length) {
              clearInterval(typingTimer);
            }
            scrollToBottom();
          }, TYPING_SPEED);
        } catch (e) {
          console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –≤ /chat:", e);
          messagesEl.removeChild(typingRow);
          createBubble(
            "assistant",
            "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –∏–ª–∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
          );
        } finally {
          setSendingState(false);
          saveHistory();
          resetInactivityTimer("–ø—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–∞—è –ø–∞—É–∑–∞");
        }
      }

      // --------- –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ ---------
      sendBtn.addEventListener("click", () => {
        sendMessage();
      });

      inputEl.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      resetBtn.addEventListener("click", () => {
        if (history.length === 0) return;
        endDialog("–∫–Ω–æ–ø–∫–∞ ¬´–ù–∞—á–∞—Ç—å —Å–Ω–∞—á–∞–ª–∞¬ª");
      });

      window.addEventListener("beforeunload", () => {
        // —Ñ–∏–∫—Å–∏—Ä—É–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ ‚Äî –ø–æ –Ω–µ–º—É –ø–æ—Ç–æ–º —Ä–µ—à–∏–º, –∂–∏–≤ –¥–∏–∞–ª–æ–≥ –∏–ª–∏ –Ω–µ—Ç
        try {
          localStorage.setItem(
            STORAGE_KEY_LAST_ACTIVITY,
            String(Date.now())
          );
        } catch {}
      });

      // --------- –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---------
      history = loadHistory();
      renderHistory();
      resetInactivityTimer("10 –º–∏–Ω—É—Ç –±–µ–∑–¥–µ–π—Å—Ç–≤–∏—è");
      inputEl.focus();
    </script>
  </body>
</html>
