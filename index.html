<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CosmoDance AI Assistant ü§ñ</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üíÉ</text></svg>">
  <style>
    :root {
      --primary: #8a2be2;
      --secondary: #ff6b9d;
      --dark: #0f0f1e;
      --darker: #070710;
      --light: #f8f9fa;
      --gray: #6c757d;
      --success: #20c997;
      --danger: #ff6b6b;
      --warning: #ffc107;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: linear-gradient(135deg, var(--darker) 0%, var(--dark) 100%);
      color: var(--light);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
      line-height: 1.6;
    }
    
    .chat-container {
      width: 100%;
      max-width: 900px;
      height: 90vh;
      background: rgba(15, 15, 30, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 24px;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(138, 43, 226, 0.2);
      display: flex;
      flex-direction: column;
    }
    
    /* Header */
    .header {
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      padding: 20px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .logo-icon {
      font-size: 28px;
      animation: dance 2s infinite;
    }
    
    @keyframes dance {
      0%, 100% { transform: rotate(0deg); }
      25% { transform: rotate(-10deg); }
      75% { transform: rotate(10deg); }
    }
    
    .logo-text h1 {
      font-size: 22px;
      font-weight: 700;
      background: linear-gradient(90deg, #fff, #ffd6e7);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .logo-text p {
      font-size: 12px;
      opacity: 0.9;
      margin-top: 2px;
    }
    
    .status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      background: rgba(0, 0, 0, 0.3);
      padding: 6px 12px;
      border-radius: 20px;
    }
    
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--success);
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    /* Messages */
    .messages-container {
      flex: 1;
      overflow-y: auto;
      padding: 25px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    
    .message {
      max-width: 80%;
      animation: slideIn 0.3s ease;
    }
    
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .message.user {
      align-self: flex-end;
    }
    
    .message.bot {
      align-self: flex-start;
    }
    
    .message-content {
      padding: 16px 20px;
      border-radius: 20px;
      position: relative;
      word-wrap: break-word;
      white-space: pre-wrap;
    }
    
    .message.user .message-content {
      background: linear-gradient(135deg, var(--primary), #6a11cb);
      color: white;
      border-bottom-right-radius: 4px;
    }
    
    .message.bot .message-content {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(138, 43, 226, 0.3);
      border-bottom-left-radius: 4px;
    }
    
    .message-time {
      font-size: 11px;
      opacity: 0.6;
      margin-top: 6px;
      text-align: right;
    }
    
    .typing-indicator {
      display: flex;
      gap: 4px;
      padding: 10px 20px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 20px;
      align-self: flex-start;
      margin-bottom: 10px;
    }
    
    .typing-dot {
      width: 8px;
      height: 8px;
      background: var(--primary);
      border-radius: 50%;
      animation: typing 1.4s infinite;
    }
    
    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }
    
    @keyframes typing {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-8px); }
    }
    
    /* Input */
    .input-container {
      padding: 20px 30px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      background: rgba(7, 7, 16, 0.8);
      display: flex;
      gap: 12px;
      align-items: center;
    }
    
    .input-wrapper {
      flex: 1;
      position: relative;
    }
    
    #userInput {
      width: 100%;
      padding: 16px 20px;
      padding-right: 50px;
      background: rgba(255, 255, 255, 0.05);
      border: 2px solid rgba(138, 43, 226, 0.3);
      border-radius: 50px;
      color: white;
      font-size: 15px;
      outline: none;
      transition: all 0.3s;
    }
    
    #userInput:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(138, 43, 226, 0.2);
    }
    
    #userInput::placeholder {
      color: rgba(255, 255, 255, 0.4);
    }
    
    .char-count {
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 12px;
      opacity: 0.6;
    }
    
    #sendBtn {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      border: none;
      color: white;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      transition: all 0.3s;
      flex-shrink: 0;
    }
    
    #sendBtn:hover:not(:disabled) {
      transform: scale(1.05);
      box-shadow: 0 0 20px rgba(138, 43, 226, 0.4);
    }
    
    #sendBtn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    /* Controls */
    .controls {
      display: flex;
      justify-content: center;
      gap: 15px;
      padding: 15px 30px;
      background: rgba(7, 7, 16, 0.6);
      border-top: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    .control-btn {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: rgba(255, 255, 255, 0.7);
      padding: 10px 20px;
      border-radius: 50px;
      cursor: pointer;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s;
    }
    
    .control-btn:hover {
      background: rgba(138, 43, 226, 0.2);
      color: white;
      border-color: var(--primary);
    }
    
    /* Suggestions */
    .suggestions {
      padding: 20px 30px;
      border-top: 1px solid rgba(255, 255, 255, 0.05);
      background: rgba(7, 7, 16, 0.4);
    }
    
    .suggestions-title {
      font-size: 13px;
      opacity: 0.7;
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .suggestions-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    
    .suggestion-btn {
      background: rgba(138, 43, 226, 0.15);
      border: 1px solid rgba(138, 43, 226, 0.3);
      color: rgba(255, 255, 255, 0.9);
      padding: 10px 18px;
      border-radius: 50px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s;
      flex: 1;
      min-width: 120px;
      text-align: center;
    }
    
    .suggestion-btn:hover {
      background: rgba(138, 43, 226, 0.3);
      transform: translateY(-2px);
    }
    
    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
    }
    
    ::-webkit-scrollbar-thumb {
      background: rgba(138, 43, 226, 0.5);
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: rgba(138, 43, 226, 0.7);
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }
      
      .chat-container {
        height: 95vh;
        border-radius: 20px;
      }
      
      .header {
        padding: 15px 20px;
      }
      
      .messages-container {
        padding: 15px;
      }
      
      .input-container, .controls, .suggestions {
        padding: 15px 20px;
      }
      
      .message {
        max-width: 90%;
      }
      
      .suggestions-buttons {
        flex-direction: column;
      }
      
      .suggestion-btn {
        min-width: 100%;
      }
    }
    
    /* Welcome message */
    .welcome-message {
      background: linear-gradient(135deg, rgba(138, 43, 226, 0.1), rgba(255, 107, 157, 0.1));
      border: 1px solid rgba(138, 43, 226, 0.2);
      border-radius: 20px;
      padding: 25px;
      margin-bottom: 20px;
      animation: fadeIn 0.5s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .welcome-title {
      font-size: 20px;
      margin-bottom: 10px;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .welcome-features {
      list-style: none;
      margin: 15px 0;
    }
    
    .welcome-features li {
      padding: 8px 0;
      padding-left: 25px;
      position: relative;
    }
    
    .welcome-features li:before {
      content: "‚ú®";
      position: absolute;
      left: 0;
    }
    
    /* Error */
    .error-message {
      background: rgba(255, 107, 107, 0.1);
      border: 1px solid rgba(255, 107, 107, 0.3);
      border-radius: 12px;
      padding: 12px 16px;
      margin: 10px 0;
      font-size: 13px;
      display: none;
    }
  </style>
</head>
<body>
  <div class="chat-container">
    <!-- Header -->
    <div class="header">
      <div class="logo">
        <div class="logo-icon">üíÉ</div>
        <div class="logo-text">
          <h1>CosmoDance AI Assistant</h1>
          <p>–í–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –ø–æ —Ç–∞–Ω—Ü–∞–º</p>
        </div>
      </div>
      <div class="status">
        <div class="status-dot"></div>
        <span id="statusText">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</span>
      </div>
    </div>
    
    <!-- Messages -->
    <div class="messages-container" id="messages">
      <div class="welcome-message">
        <h2 class="welcome-title">üëã –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é –≤ CosmoDance!</h2>
        <p>–Ø –≤–∞—à AI-–ø–æ–º–æ—â–Ω–∏–∫, –≥–æ—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã –æ –Ω–∞—à–µ–π —Å—Ç—É–¥–∏–∏ —Ç–∞–Ω—Ü–µ–≤.</p>
        
        <ul class="welcome-features">
          <li>üìÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –≥—Ä—É–ø–ø –∏ –∑–∞–Ω—è—Ç–∏—è</li>
          <li>üí∞ –¶–µ–Ω—ã –∏ –∞–±–æ–Ω–µ–º–µ–Ω—Ç—ã</li>
          <li>üìç –§–∏–ª–∏–∞–ª—ã –∏ –∫–∞–∫ –¥–æ–±—Ä–∞—Ç—å—Å—è</li>
          <li>üë∂ –ó–∞–Ω—è—Ç–∏—è –¥–ª—è –¥–µ—Ç–µ–π –∏ –≤–∑—Ä–æ—Å–ª—ã—Ö</li>
          <li>üé≠ –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–∞–Ω—Ü–µ–≤</li>
          <li>üìù –ó–∞–ø–∏—Å—å –Ω–∞ –ø—Ä–æ–±–Ω–æ–µ –∑–∞–Ω—è—Ç–∏–µ</li>
        </ul>
        
        <p>–ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É –Ω–∏–∂–µ ‚¨áÔ∏è</p>
      </div>
    </div>
    
    <!-- Error -->
    <div class="error-message" id="errorMessage"></div>
    
    <!-- Typing -->
    <div class="typing-indicator" id="typingIndicator" style="display: none;">
      <div class="typing-dot"></div>
      <div class="typing-dot"></div>
      <div class="typing-dot"></div>
    </div>
    
    <!-- Suggestions -->
    <div class="suggestions" id="suggestions">
      <div class="suggestions-title">–ß–∞—Å—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã:</div>
      <div class="suggestions-buttons">
        <button class="suggestion-btn" data-question="–†–∞—Å—Å–∫–∞–∂–∏ –æ —Å—Ç—É–¥–∏–∏ CosmoDance">–û —Å—Ç—É–¥–∏–∏</button>
        <button class="suggestion-btn" data-question="–ö–∞–∫–∏–µ —Ñ–∏–ª–∏–∞–ª—ã –µ—Å—Ç—å?">–§–∏–ª–∏–∞–ª—ã</button>
        <button class="suggestion-btn" data-question="–°–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç –∞–±–æ–Ω–µ–º–µ–Ω—Ç?">–¶–µ–Ω—ã</button>
        <button class="suggestion-btn" data-question="–ö–∞–∫ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –ø—Ä–æ–±–Ω–æ–µ?">–ü—Ä–æ–±–Ω–æ–µ –∑–∞–Ω—è—Ç–∏–µ</button>
        <button class="suggestion-btn" data-question="–ö–∞–∫–∏–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–∞–Ω—Ü–µ–≤ –µ—Å—Ç—å?">–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è</button>
        <button class="suggestion-btn" data-question="–ï—Å—Ç—å –ª–∏ –∑–∞–Ω—è—Ç–∏—è –¥–ª—è –¥–µ—Ç–µ–π 5 –ª–µ—Ç?">–î–ª—è –¥–µ—Ç–µ–π</button>
      </div>
    </div>
    
    <!-- Input -->
    <div class="input-container">
      <div class="input-wrapper">
        <input 
          type="text" 
          id="userInput" 
          placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å –æ CosmoDance..."
          maxlength="500"
          disabled
        >
        <div class="char-count">
          <span id="charCount">0</span>/500
        </div>
      </div>
      <button id="sendBtn" disabled>‚û§</button>
    </div>
    
    <!-- Controls -->
    <div class="controls">
      <button class="control-btn" id="clearBtn">
        <span>üóëÔ∏è</span> –ù–æ–≤—ã–π –¥–∏–∞–ª–æ–≥
      </button>
      <button class="control-btn" id="copyBtn">
        <span>üìã</span> –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —á–∞—Ç
      </button>
      <button class="control-btn" id="historyBtn">
        <span>üìö</span> –ò—Å—Ç–æ—Ä–∏—è
      </button>
      <button class="control-btn" id="helpBtn">
        <span>‚ùì</span> –ü–æ–º–æ—â—å
      </button>
    </div>
  </div>

  <script>
    // ==================== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ====================
    const CONFIG = {
      API_URL: window.location.hostname.includes('render.com') 
        ? '/chat' 
        : 'http://localhost:10000/chat',
      TYPING_SPEED: 30,
      MAX_HISTORY: 50,
      SESSION_TIMEOUT: 30 * 60 * 1000, // 30 –º–∏–Ω—É—Ç
      STORAGE_KEY: 'cosmodance_chat_v3',
      SESSION_KEY: 'cosmodance_session'
    };

    // ==================== –°–û–°–¢–û–Ø–ù–ò–ï ====================
    let state = {
      messages: [],
      isTyping: false,
      conversationId: generateId(),
      sessionStart: Date.now(),
      requestCount: 0
    };

    // ==================== –≠–õ–ï–ú–ï–ù–¢–´ ====================
    const elements = {
      messages: document.getElementById('messages'),
      userInput: document.getElementById('userInput'),
      sendBtn: document.getElementById('sendBtn'),
      statusText: document.getElementById('statusText'),
      typingIndicator: document.getElementById('typingIndicator'),
      errorMessage: document.getElementById('errorMessage'),
      charCount: document.getElementById('charCount'),
      clearBtn: document.getElementById('clearBtn'),
      copyBtn: document.getElementById('copyBtn'),
      historyBtn: document.getElementById('historyBtn'),
      helpBtn: document.getElementById('helpBtn'),
      suggestions: document.getElementById('suggestions')
    };

    // ==================== –£–¢–ò–õ–ò–¢–´ ====================
    function generateId() {
      return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }

    function formatTime(date = new Date()) {
      return date.toLocaleTimeString('ru-RU', {
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // ==================== –£–ü–†–ê–í–õ–ï–ù–ò–ï –°–û–°–¢–û–Ø–ù–ò–ï–ú ====================
    function saveState() {
      try {
        const data = {
          messages: state.messages.slice(-CONFIG.MAX_HISTORY),
          conversationId: state.conversationId,
          sessionStart: state.sessionStart
        };
        localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify(data));
      } catch (e) {
        console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ:', e);
      }
    }

    function loadState() {
      try {
        const saved = localStorage.getItem(CONFIG.STORAGE_KEY);
        if (saved) {
          const data = JSON.parse(saved);
          
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ —É—Å—Ç–∞—Ä–µ–ª–∞ –ª–∏ —Å–µ—Å—Å–∏—è
          const sessionAge = Date.now() - data.sessionStart;
          if (sessionAge < CONFIG.SESSION_TIMEOUT) {
            state.messages = data.messages || [];
            state.conversationId = data.conversationId || generateId();
            state.sessionStart = data.sessionStart;
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
            state.messages.forEach(msg => addMessageToUI(msg));
            scrollToBottom();
            
            if (state.messages.length > 0) {
              elements.suggestions.style.display = 'none';
            }
          } else {
            clearState();
          }
        }
      } catch (e) {
        console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ:', e);
        clearState();
      }
    }

    function clearState() {
      state.messages = [];
      state.conversationId = generateId();
      state.sessionStart = Date.now();
      state.requestCount = 0;
      
      elements.messages.innerHTML = '';
      elements.suggestions.style.display = 'block';
      saveState();
      
      // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
      const welcomeMsg = document.querySelector('.welcome-message');
      if (welcomeMsg) {
        elements.messages.appendChild(welcomeMsg.cloneNode(true));
      }
      
      showStatus('–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ');
    }

    // ==================== UI –§–£–ù–ö–¶–ò–ò ====================
    function addMessageToUI(message) {
      const messageEl = document.createElement('div');
      messageEl.className = `message ${message.role}`;
      
      const contentEl = document.createElement('div');
      contentEl.className = 'message-content';
      contentEl.textContent = message.content;
      
      const timeEl = document.createElement('div');
      timeEl.className = 'message-time';
      timeEl.textContent = formatTime(new Date(message.timestamp));
      
      messageEl.appendChild(contentEl);
      messageEl.appendChild(timeEl);
      elements.messages.appendChild(messageEl);
      
      scrollToBottom();
    }

    function addMessage(role, content) {
      const message = {
        role,
        content,
        timestamp: Date.now(),
        id: generateId()
      };
      
      state.messages.push(message);
      addMessageToUI(message);
      saveState();
    }

    function showTyping(show) {
      state.isTyping = show;
      elements.typingIndicator.style.display = show ? 'flex' : 'none';
      scrollToBottom();
    }

    function showStatus(text, type = 'info') {
      elements.statusText.textContent = text;
      const dot = elements.statusText.previousElementSibling;
      
      dot.style.background = 
        type === 'error' ? 'var(--danger)' :
        type === 'warning' ? 'var(--warning)' :
        type === 'success' ? 'var(--success)' : '#20c997';
    }

    function showError(text, duration = 5000) {
      elements.errorMessage.textContent = text;
      elements.errorMessage.style.display = 'block';
      
      setTimeout(() => {
        elements.errorMessage.style.display = 'none';
      }, duration);
    }

    function scrollToBottom() {
      setTimeout(() => {
        elements.messages.scrollTop = elements.messages.scrollHeight;
      }, 100);
    }

    function updateCharCount() {
      const length = elements.userInput.value.length;
      elements.charCount.textContent = length;
      
      if (length > 400) {
        elements.charCount.style.color = 'var(--warning)';
      } else if (length > 450) {
        elements.charCount.style.color = 'var(--danger)';
      } else {
        elements.charCount.style.color = 'rgba(255, 255, 255, 0.6)';
      }
    }

    // ==================== API –í–ó–ê–ò–ú–û–î–ï–ô–°–¢–í–ò–ï ====================
    async function checkHealth() {
      try {
        const response = await fetch('/health', { timeout: 5000 });
        if (response.ok) {
          const data = await response.json();
          showStatus(`–û–Ω–ª–∞–π–Ω ‚Ä¢ v${data.version}`, 'success');
          elements.userInput.disabled = false;
          elements.sendBtn.disabled = false;
          elements.userInput.placeholder = '–ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å –æ CosmoDance...';
          return true;
        }
      } catch (e) {
        console.warn('Health check failed:', e);
      }
      
      showStatus('–°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω', 'error');
      elements.userInput.disabled = true;
      elements.sendBtn.disabled = true;
      elements.userInput.placeholder = '–°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ...';
      return false;
    }

    async function sendMessage() {
      const text = elements.userInput.value.trim();
      if (!text || state.isTyping) return;
      
      // –û—á–∏—â–∞–µ–º input
      elements.userInput.value = '';
      updateCharCount();
      
      // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      addMessage('user', text);
      elements.suggestions.style.display = 'none';
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–∞–±–æ—Ä–∞
      showTyping(true);
      showStatus('–ë–æ—Ç –¥—É–º–∞–µ—Ç...', 'warning');
      
      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å
      state.requestCount++;
      
      try {
        const response = await fetch(CONFIG.API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            message: text,
            conversationId: state.conversationId
          })
        });
        
        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.error || '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
        }
        
        // –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≤—ã–≤–æ–¥ –æ—Ç–≤–µ—Ç–∞
        showTyping(false);
        await typeMessage(data.reply);
        
        showStatus('–û–Ω–ª–∞–π–Ω', 'success');
        
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', error);
        showTyping(false);
        
        let errorText = '–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.';
        
        if (error.message.includes('timeout')) {
          errorText = '–í—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –∏—Å—Ç–µ–∫–ª–æ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.';
        } else if (error.message.includes('quota')) {
          errorText = '–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —á–µ—Ä–µ–∑ —á–∞—Å.';
        }
        
        addMessage('bot', errorText);
        showError(errorText);
        showStatus('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', 'error');
      }
    }

    async function typeMessage(text) {
      return new Promise(resolve => {
        const message = {
          role: 'bot',
          content: '',
          timestamp: Date.now(),
          id: generateId()
        };
        
        state.messages.push(message);
        
        const messageEl = document.createElement('div');
        messageEl.className = 'message bot';
        
        const contentEl = document.createElement('div');
        contentEl.className = 'message-content';
        
        const timeEl = document.createElement('div');
        timeEl.className = 'message-time';
        timeEl.textContent = formatTime(new Date(message.timestamp));
        
        messageEl.appendChild(contentEl);
        messageEl.appendChild(timeEl);
        elements.messages.appendChild(messageEl);
        
        let i = 0;
        const len = text.length;
        
        function typeNext() {
          if (i >= len) {
            message.content = text;
            saveState();
            resolve();
            return;
          }
          
          // –î–æ–±–∞–≤–ª—è–µ–º —Å–∏–º–≤–æ–ª—ã –≥—Ä—É–ø–ø–∞–º–∏ –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏
          const chunkSize = Math.random() > 0.8 ? 2 : 1;
          const end = Math.min(i + chunkSize, len);
          contentEl.textContent += text.substring(i, end);
          i = end;
          
          // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫–∞–∂–¥—ã–µ 10 —Å–∏–º–≤–æ–ª–æ–≤
          if (i % 10 === 0 || i >= len) {
            scrollToBottom();
          }
          
          setTimeout(typeNext, CONFIG.TYPING_SPEED);
        }
        
        typeNext();
      });
    }

    // ==================== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô ====================
    elements.sendBtn.addEventListener('click', sendMessage);

    elements.userInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    elements.userInput.addEventListener('input', debounce(updateCharCount, 100));

    elements.clearBtn.addEventListener('click', () => {
      if (state.messages.length > 0 && confirm('–ù–∞—á–∞—Ç—å –Ω–æ–≤—ã–π –¥–∏–∞–ª–æ–≥? –¢–µ–∫—É—â–∞—è –∏—Å—Ç–æ—Ä–∏—è –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–∞.')) {
        clearState();
        showError('–î–∏–∞–ª–æ–≥ –æ—á–∏—â–µ–Ω', 3000);
      }
    });

    elements.copyBtn.addEventListener('click', async () => {
      const chatText = state.messages.map(m => 
        `${m.role === 'user' ? '–í—ã' : '–ë–æ—Ç'}: ${m.content}`
      ).join('\n\n');
      
      try {
        await navigator.clipboard.writeText(chatText);
        showError('–ß–∞—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä!', 2000);
      } catch {
        showError('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å', 3000);
      }
    });

    elements.historyBtn.addEventListener('click', () => {
      const count = state.messages.length;
      showError(`–í –∏—Å—Ç–æ—Ä–∏–∏ ${count} —Å–æ–æ–±—â–µ–Ω–∏–π`, 3000);
    });

    elements.helpBtn.addEventListener('click', () => {
      addMessage('user', '–ß—Ç–æ —Ç—ã —É–º–µ–µ—à—å?');
      setTimeout(() => {
        addMessage('bot', '–Ø –º–æ–≥—É:\n‚Ä¢ –†–∞—Å—Å–∫–∞–∑–∞—Ç—å –æ —Å—Ç—É–¥–∏–∏ CosmoDance\n‚Ä¢ –ü–æ–∫–∞–∑–∞—Ç—å —Ñ–∏–ª–∏–∞–ª—ã –∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ\n‚Ä¢ –°–æ–æ–±—â–∏—Ç—å —Ü–µ–Ω—ã –∏ –∞–±–æ–Ω–µ–º–µ–Ω—Ç—ã\n‚Ä¢ –ü–æ–º–æ—á—å –≤—ã–±—Ä–∞—Ç—å –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ\n‚Ä¢ –û—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ —á–∞—Å—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã\n‚Ä¢ –ü–æ–¥—Å–∫–∞–∑–∞—Ç—å –∫–∞–∫ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è');
      }, 500);
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤
    document.querySelectorAll('.suggestion-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        elements.userInput.value = btn.dataset.question;
        updateCharCount();
        sendMessage();
      });
    });

    // ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ====================
    async function init() {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–¥–æ—Ä–æ–≤—å–µ —Å–µ—Ä–≤–µ—Ä–∞
      await checkHealth();
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
      loadState();
      
      // –ê–≤—Ç–æ—Ñ–æ–∫—É—Å
      elements.userInput.focus();
      
      // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è
      setInterval(checkHealth, 60000); // –ö–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
      
      // –ê–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö —Å–µ—Å—Å–∏–π
      setInterval(() => {
        const sessionAge = Date.now() - state.sessionStart;
        if (sessionAge > CONFIG.SESSION_TIMEOUT && state.messages.length > 0) {
          clearState();
          showError('–°–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –ù–∞—á–∏–Ω–∞–µ–º –Ω–æ–≤—ã–π –¥–∏–∞–ª–æ–≥.', 5000);
        }
      }, 60000);
    }

    // –ó–∞–ø—É—Å–∫
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
