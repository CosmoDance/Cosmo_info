<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <title>CosmoDance –ø–æ–º–æ—â–Ω–∏–∫</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: #050618;
        color: #fff;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
      }

      .chat-container {
        width: 100%;
        max-width: 480px;
        height: 90vh;
        max-height: 760px;
        background: #050618;
        border-radius: 24px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.6);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        border: 1px solid rgba(255, 255, 255, 0.08);
      }

      .chat-header {
        padding: 16px 20px;
        background: linear-gradient(135deg, #2563eb, #7c3aed);
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .chat-avatar {
        width: 40px;
        height: 40px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.15);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 20px;
      }

      .chat-header-text {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      .chat-header-title {
        font-weight: 600;
        font-size: 16px;
      }

      .chat-header-sub {
        font-size: 13px;
        opacity: 0.9;
      }

      .chat-messages {
        flex: 1;
        padding: 16px 16px 0 16px;
        overflow-y: auto;
        background: radial-gradient(circle at top, #1e293b 0, #020617 55%);
      }

      .msg {
        max-width: 90%;
        padding: 10px 14px;
        border-radius: 16px;
        margin-bottom: 10px;
        font-size: 14px;
        line-height: 1.4;
        white-space: pre-wrap;
        word-wrap: break-word;
      }

      .msg-bot {
        background: rgba(15, 23, 42, 0.95);
        border-radius: 16px 16px 16px 4px;
      }

      .msg-user {
        background: #2563eb;
        border-radius: 16px 16px 4px 16px;
        margin-left: auto;
      }

      .typing {
        display: inline-flex;
        gap: 4px;
      }

      .typing-dot {
        width: 6px;
        height: 6px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.7);
        animation: typing 1s infinite ease-in-out;
      }

      .typing-dot:nth-child(2) {
        animation-delay: 0.15s;
      }

      .typing-dot:nth-child(3) {
        animation-delay: 0.3s;
      }

      @keyframes typing {
        0%,
        80%,
        100% {
          opacity: 0.3;
          transform: translateY(0);
        }
        40% {
          opacity: 1;
          transform: translateY(-2px);
        }
      }

      .chat-input-area {
        padding: 10px;
        border-top: 1px solid rgba(148, 163, 184, 0.3);
        background: rgba(15, 23, 42, 0.95);
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .chat-input-row {
        display: flex;
        gap: 8px;
      }

      textarea {
        flex: 1;
        resize: none;
        border-radius: 16px;
        border: 1px solid rgba(148, 163, 184, 0.5);
        padding: 10px 12px;
        font-size: 14px;
        background: rgba(15, 23, 42, 0.9);
        color: #e5e7eb;
        max-height: 90px;
      }

      textarea:focus {
        outline: none;
        border-color: #60a5fa;
      }

      button {
        border: none;
        cursor: pointer;
        border-radius: 999px;
        padding: 0 18px;
        font-size: 14px;
        font-weight: 500;
        display: flex;
        align-items: center;
        justify-content: center;
        white-space: nowrap;
      }

      .btn-send {
        background: #22c55e;
        color: #022c22;
      }

      .btn-send:disabled {
        opacity: 0.5;
        cursor: default;
      }

      .btn-reset {
        background: transparent;
        color: #9ca3af;
        font-size: 12px;
        align-self: flex-end;
      }

      .hint {
        font-size: 11px;
        color: #94a3b8;
        text-align: left;
        padding: 0 2px;
      }
    </style>
  </head>
  <body>
    <div class="chat-container">
      <div class="chat-header">
        <div class="chat-avatar">C</div>
        <div class="chat-header-text">
          <div class="chat-header-title">CosmoDance –ø–æ–º–æ—â–Ω–∏–∫</div>
          <div class="chat-header-sub">
            –û—Ç–≤–µ—á–∞—é –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ —Å—Ç—É–¥–∏–∏ –∏ –∑–∞–ø–∏—Å–∏ –Ω–∞ –∑–∞–Ω—è—Ç–∏—è
          </div>
        </div>
      </div>

      <div id="chatMessages" class="chat-messages"></div>

      <div class="chat-input-area">
        <div class="chat-input-row">
          <textarea
            id="userInput"
            rows="1"
            placeholder="–ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å –æ CosmoDance‚Ä¶"
          ></textarea>
          <button id="sendBtn" class="btn-send">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
        <div class="chat-input-row" style="justify-content: space-between">
          <div class="hint">
            –î–∏–∞–ª–æ–≥ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è, –ø–æ–∫–∞ –≤–∫–ª–∞–¥–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∞. –ù–∞–∂–º–∏—Ç–µ
            ¬´–ù–æ–≤—ã–π –¥–∏–∞–ª–æ–≥¬ª, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Å–Ω–∞—á–∞–ª–∞.
          </div>
          <button id="resetBtn" class="btn-reset">–ù–æ–≤—ã–π –¥–∏–∞–ª–æ–≥</button>
        </div>
      </div>
    </div>

    <script>
      // --------- –ù–ê–°–¢–†–û–ô–ö–ò ---------

      const API_URL = "/chat";
      const TYPING_SPEED = 40; // –º—Å –Ω–∞ —Å–∏–º–≤–æ–ª ‚Äî –º–µ–¥–ª–µ–Ω–Ω–µ–µ, –ø–æ—Ö–æ–∂ –Ω–∞ —á–µ–ª–æ–≤–µ–∫–∞
      const STORAGE_KEY = "cosmoChatHistory";

      // --------- –°–û–°–¢–û–Ø–ù–ò–ï ---------

      /**
       * messages: –º–∞—Å—Å–∏–≤ –≤–∏–¥–∞ [{ role: "user"|"assistant", content: "..." }, ...]
       */
      let messages = [];
      let isSending = false;
      let typingTimer = null;

      const $messages = document.getElementById("chatMessages");
      const $input = document.getElementById("userInput");
      const $sendBtn = document.getElementById("sendBtn");
      const $resetBtn = document.getElementById("resetBtn");

      // --------- –†–ê–ë–û–¢–ê –° sessionStorage ---------

      function loadHistory() {
        try {
          const raw = sessionStorage.getItem(STORAGE_KEY);
          if (raw) {
            const parsed = JSON.parse(raw);
            if (Array.isArray(parsed)) {
              messages = parsed;
            }
          }
        } catch (e) {
          console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é:", e);
        }

        if (messages.length === 0) {
          // –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
          messages.push({
            role: "assistant",
            content:
              "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç —Å—Ç—É–¥–∏–∏ CosmoDance. " +
              "–ü–æ–º–æ–≥—É –ø–æ–¥–æ–±—Ä–∞—Ç—å –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏ –≥—Ä—É–ø–ø—ã –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é, —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å " +
              "–ø—Ä–æ —Ñ–∏–ª–∏–∞–ª—ã, —Ü–µ–Ω—ã –∏ –∑–∞–ø–∏—Å–∞—Ç—å –Ω–∞ –ø—Ä–æ–±–Ω–æ–µ –∑–∞–Ω—è—Ç–∏–µ. –ù–∞–ø–∏—à–∏—Ç–µ, —á–µ–º —è –º–æ–≥—É –ø–æ–º–æ—á—å üôÇ",
          });
        }

        renderMessages();
      }

      function saveHistory() {
        try {
          sessionStorage.setItem(STORAGE_KEY, JSON.stringify(messages));
        } catch (e) {
          console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é:", e);
        }
      }

      // --------- –û–¢–†–ò–°–û–í–ö–ê ---------

      function renderMessages(showTypingPlaceholder = false) {
        $messages.innerHTML = "";

        for (const msg of messages) {
          const div = document.createElement("div");
          div.classList.add("msg");
          div.classList.add(msg.role === "assistant" ? "msg-bot" : "msg-user");
          div.textContent = msg.content;
          $messages.appendChild(div);
        }

        if (showTypingPlaceholder) {
          const typingDiv = document.createElement("div");
          typingDiv.classList.add("msg", "msg-bot");
          typingDiv.innerHTML =
            '<span class="typing">' +
            '<span class="typing-dot"></span>' +
            '<span class="typing-dot"></span>' +
            '<span class="typing-dot"></span>' +
            "</span>";
          typingDiv.id = "typing-placeholder";
          $messages.appendChild(typingDiv);
        }

        // –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑
        $messages.scrollTop = $messages.scrollHeight;
      }

      function removeTypingPlaceholder() {
        const el = document.getElementById("typing-placeholder");
        if (el && el.parentNode) {
          el.parentNode.removeChild(el);
        }
      }

      // --------- –û–¢–ü–†–ê–í–ö–ê –°–û–û–ë–©–ï–ù–ò–Ø ---------

      async function sendMessage() {
        if (isSending) return;

        const text = $input.value.trim();
        if (!text) return;

        isSending = true;
        $sendBtn.disabled = true;

        messages.push({ role: "user", content: text });
        saveHistory();
        renderMessages(true);
        $input.value = "";

        try {
          const payload = {
            history: messages,
            userMessage: text,
          };

          const resp = await fetch(API_URL, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(payload),
          });

          const data = await resp.json();
          removeTypingPlaceholder();

          const reply =
            (data && data.reply) ||
            "–ò–∑–≤–∏–Ω–∏—Ç–µ, –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.";

          typeBotReply(reply);
        } catch (e) {
          console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ:", e);
          removeTypingPlaceholder();
          typeBotReply(
            "–ò–∑–≤–∏–Ω–∏—Ç–µ, —Å–µ–π—á–∞—Å –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç—Å—è –æ—Ç–≤–µ—Ç–∏—Ç—å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑ —á—É—Ç—å –ø–æ–∑–∂–µ."
          );
        } finally {
          isSending = false;
          $sendBtn.disabled = false;
          $input.focus();
        }
      }

      // --------- –ê–ù–ò–ú–ê–¶–ò–Ø –ü–ï–ß–ê–¢–ò ---------

      function typeBotReply(fullText) {
        // —Å–æ–∑–¥–∞—ë–º –ø—É—Å—Ç–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –±–æ—Ç–∞
        const msg = { role: "assistant", content: "" };
        messages.push(msg);
        saveHistory();
        renderMessages(false);

        const index = messages.length - 1;
        let i = 0;

        if (typingTimer) {
          clearInterval(typingTimer);
          typingTimer = null;
        }

        typingTimer = setInterval(() => {
          if (i >= fullText.length) {
            clearInterval(typingTimer);
            typingTimer = null;
            saveHistory();
            renderMessages(false);
            return;
          }

          messages[index].content += fullText[i];
          i += 1;
          renderMessages(false);
        }, TYPING_SPEED);
      }

      // --------- –ù–û–í–´–ô –î–ò–ê–õ–û–ì ---------

      function resetDialog() {
        if (typingTimer) {
          clearInterval(typingTimer);
          typingTimer = null;
        }
        messages = [];
        sessionStorage.removeItem(STORAGE_KEY);
        loadHistory();
      }

      // --------- –°–õ–£–®–ê–¢–ï–õ–ò ---------

      $sendBtn.addEventListener("click", sendMessage);

      $input.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      $resetBtn.addEventListener("click", resetDialog);

      // --------- –°–¢–ê–†–¢ ---------

      loadHistory();
    </script>
  </body>
</html>
