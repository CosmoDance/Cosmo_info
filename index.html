<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <title>CosmoDance Chat</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        padding: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: #05000c;
        color: #ffffff;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        min-height: 100vh;
      }

      .chat-wrapper {
        width: 100%;
        max-width: 480px;
        height: 100vh;
        max-height: 900px;
        display: flex;
        flex-direction: column;
        background: radial-gradient(circle at top left, #ff5af1, #2d005a 55%);
      }

      .chat-header {
        padding: 16px 20px 12px;
        background: linear-gradient(90deg, #ff5af1, #7a5cff);
        color: #fff;
        font-weight: 600;
        font-size: 18px;
        position: relative;
      }

      .chat-header small {
        display: block;
        font-weight: 400;
        font-size: 12px;
        opacity: 0.8;
        margin-top: 4px;
      }

      .chat-header .badge {
        position: absolute;
        right: 16px;
        top: 16px;
        font-size: 12px;
        padding: 4px 8px;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.4);
      }

      .chat-body {
        flex: 1;
        padding: 12px 14px 8px;
        overflow-y: auto;
        background: radial-gradient(circle at top left, #2c0050, #05000c 55%);
      }

      .message-row {
        display: flex;
        margin-bottom: 10px;
      }

      .message-row.user {
        justify-content: flex-end;
      }

      .message-bubble {
        max-width: 80%;
        padding: 10px 12px;
        border-radius: 16px;
        font-size: 14px;
        line-height: 1.4;
        white-space: pre-wrap;
        word-wrap: break-word;
      }

      .message-row.bot .message-bubble {
        background: rgba(17, 24, 39, 0.9);
        border: 1px solid rgba(255, 255, 255, 0.08);
      }

      .message-row.user .message-bubble {
        background: linear-gradient(135deg, #ff5af1, #ff8ad9);
        color: #120018;
      }

      .message-row.error .message-bubble {
        background: #b91c1c;
      }

      .typing-indicator {
        display: inline-block;
      }

      .typing-indicator span {
        display: inline-block;
        width: 4px;
        height: 4px;
        margin: 0 1px;
        border-radius: 50%;
        background: #f9fafb;
        opacity: 0.6;
        animation: blink 1s infinite ease-in-out;
      }

      .typing-indicator span:nth-child(2) {
        animation-delay: 0.2s;
      }

      .typing-indicator span:nth-child(3) {
        animation-delay: 0.4s;
      }

      @keyframes blink {
        0%,
        100% {
          opacity: 0.2;
        }
        50% {
          opacity: 1;
        }
      }

      .chat-footer {
        padding: 8px 12px 10px;
        background: rgba(10, 0, 22, 0.9);
        border-top: 1px solid rgba(255, 255, 255, 0.08);
      }

      .input-row {
        display: flex;
        gap: 8px;
      }

      .input-row input {
        flex: 1;
        padding: 10px 12px;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.15);
        background: rgba(6, 0, 16, 0.9);
        color: #f9fafb;
        font-size: 14px;
        outline: none;
      }

      .input-row input::placeholder {
        color: rgba(209, 213, 219, 0.7);
      }

      .input-row button {
        padding: 10px 18px;
        border-radius: 999px;
        border: none;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        background: linear-gradient(135deg, #ff5af1, #ff8ad9);
        color: #120018;
      }

      .footer-controls {
        display: flex;
        justify-content: space-between;
        margin-top: 6px;
        font-size: 11px;
        color: rgba(229, 231, 235, 0.8);
      }

      .footer-controls button {
        background: none;
        border: none;
        color: rgba(229, 231, 235, 0.8);
        font-size: 11px;
        text-decoration: underline;
        cursor: pointer;
        padding: 0;
      }

      @media (max-width: 600px) {
        .chat-wrapper {
          max-height: 100vh;
        }
      }
    </style>
  </head>
  <body>
    <div class="chat-wrapper">
      <div class="chat-header">
        CosmoDance Chat
        <small>–û–Ω–ª–∞–π–Ω-–ø–æ–º–æ—â–Ω–∏–∫ —Å—Ç—É–¥–∏–∏ —Ç–∞–Ω—Ü–µ–≤</small>
        <div class="badge">COSMO</div>
      </div>

      <div id="chatBody" class="chat-body"></div>

      <div class="chat-footer">
        <div class="input-row">
          <input
            id="userInput"
            type="text"
            placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–≤–æ–π –≤–æ–ø—Ä–æ—Å –æ —Å—Ç—É–¥–∏–∏..."
          />
          <button id="sendBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
        <div class="footer-controls">
          <span>–î–∏–∞–ª–æ–≥ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è, –ø–æ–∫–∞ –≤—ã –Ω–µ –Ω–∞–∂–º—ë—Ç–µ ¬´–ù–∞—á–∞—Ç—å —Å–Ω–∞—á–∞–ª–∞¬ª.</span>
          <button id="resetBtn">–ù–∞—á–∞—Ç—å —Å–Ω–∞—á–∞–ª–∞</button>
        </div>
      </div>
    </div>

    <script>
      // ---------------- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ----------------
      const TYPING_SPEED = 40; // –º—Å –Ω–∞ —Å–∏–º–≤–æ–ª ‚Äî –º–µ–¥–ª–µ–Ω–Ω–µ–µ, "–∫–∞–∫ —á–µ–ª–æ–≤–µ–∫"
      const STORAGE_KEY = "cosmo_chat_history_v1";

      // ---------------- –°–æ—Å—Ç–æ—è–Ω–∏–µ ----------------
      /** @type {{role: "user"|"assistant", content: string}[]} */
      let history = [];

      const chatBody = document.getElementById("chatBody");
      const userInput = document.getElementById("userInput");
      const sendBtn = document.getElementById("sendBtn");
      const resetBtn = document.getElementById("resetBtn");

      // ---------------- –†–∞–±–æ—Ç–∞ —Å localStorage ----------------
      function loadHistory() {
        try {
          const raw = window.localStorage.getItem(STORAGE_KEY);
          if (!raw) return [];
          const parsed = JSON.parse(raw);
          if (!Array.isArray(parsed)) return [];
          return parsed;
        } catch (e) {
          console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é –∏–∑ localStorage:", e);
          return [];
        }
      }

      function saveHistory() {
        try {
          window.localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
        } catch (e) {
          console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –≤ localStorage:", e);
        }
      }

      // ---------------- –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π ----------------
      function appendMessage(role, text, kind = "normal") {
        const row = document.createElement("div");
        row.classList.add("message-row");

        if (role === "user") row.classList.add("user");
        else if (role === "assistant") row.classList.add("bot");
        if (kind === "error") row.classList.add("error");

        const bubble = document.createElement("div");
        bubble.classList.add("message-bubble");
        bubble.textContent = text;

        row.appendChild(bubble);
        chatBody.appendChild(row);
        chatBody.scrollTop = chatBody.scrollHeight;
        return bubble;
      }

      function appendTypingBubble() {
        const row = document.createElement("div");
        row.classList.add("message-row", "bot");
        const bubble = document.createElement("div");
        bubble.classList.add("message-bubble");

        const dots = document.createElement("div");
        dots.classList.add("typing-indicator");
        dots.innerHTML = "<span></span><span></span><span></span>";

        bubble.appendChild(dots);
        row.appendChild(bubble);
        chatBody.appendChild(row);
        chatBody.scrollTop = chatBody.scrollHeight;
        return { row, bubble };
      }

      async function typeTextIntoBubble(bubble, text) {
        bubble.textContent = "";
        let i = 0;
        return new Promise((resolve) => {
          const interval = setInterval(() => {
            bubble.textContent += text[i];
            i += 1;
            chatBody.scrollTop = chatBody.scrollHeight;
            if (i >= text.length) {
              clearInterval(interval);
              resolve();
            }
          }, TYPING_SPEED);
        });
      }

      function renderFullHistory() {
        chatBody.innerHTML = "";
        for (const msg of history) {
          appendMessage(msg.role, msg.content);
        }
        chatBody.scrollTop = chatBody.scrollHeight;
      }

      // ---------------- –õ–æ–≥–∏–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ ----------------
      async function sendMessage() {
        const text = (userInput.value || "").trim();
        if (!text) return;

        // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        history.push({ role: "user", content: text });
        saveHistory();
        appendMessage("user", text);
        userInput.value = "";

        // –ü–∏—à–µ–º "–±–æ—Ç –ø–µ—á–∞—Ç–∞–µ—Ç"
        const typing = appendTypingBubble();

        try {
          const payload = {
            message: text,
            history: history.map((m) => ({
              role: m.role === "assistant" ? "assistant" : "user",
              content: m.content,
            })),
          };

          const resp = await fetch("/chat", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(payload),
          });

          if (!resp.ok) {
            throw new Error("–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞ " + resp.status);
          }

          const data = await resp.json();
          const reply = (data && data.reply) || "";

          // –£–±–∏—Ä–∞–µ–º "–ø–µ—á–∞—Ç–∞–µ—Ç"
          typing.row.remove();

          if (!reply) {
            const msg =
              "–ò–∑–≤–∏–Ω–∏—Ç–µ, —É –º–µ–Ω—è –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å –ø–æ-–¥—Ä—É–≥–æ–º—É.";
            history.push({ role: "assistant", content: msg });
            saveHistory();
            appendMessage("assistant", msg, "error");
            return;
          }

          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Ç–≤–µ—Ç —Å –ø–µ—á–∞—Ç–∞–Ω–∏–µ–º
          const bubble = appendMessage("assistant", "");
          await typeTextIntoBubble(bubble, reply);
          history.push({ role: "assistant", content: reply });
          saveHistory();
        } catch (e) {
          console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ /chat:", e);
          typing.row.remove();
          const msg =
            "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –∏–ª–∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.";
          appendMessage("assistant", msg, "error");
        }
      }

      // ---------------- –°–±—Ä–æ—Å –¥–∏–∞–ª–æ–≥–∞ ----------------
      function resetChat() {
        history = [];
        saveHistory();
        // –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        const welcome =
          "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! üëã –Ø –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç —Å—Ç—É–¥–∏–∏ —Ç–∞–Ω—Ü–µ–≤ CosmoDance.\n\n" +
          "–û—Ç–≤–µ—á–∞—é –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ —Ñ–∏–ª–∏–∞–ª–∞—Ö, –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è—Ö, —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–∏ –∏ –∑–∞–ø–∏—Å–∏ –Ω–∞ –∑–∞–Ω—è—Ç–∏—è.\n" +
          "–ù–∞–ø–∏—à–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, —á—Ç–æ –≤—ã —Ö–æ—Ç–µ–ª–∏ –±—ã —É–∑–Ω–∞—Ç—å –∏–ª–∏ —á–µ–º —è –º–æ–≥—É –ø–æ–º–æ—á—å üòä";
        history.push({ role: "assistant", content: welcome });
        saveHistory();
        renderFullHistory();
      }

      // ---------------- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ----------------
      (function init() {
        history = loadHistory();
        if (!history || history.length === 0) {
          resetChat();
        } else {
          renderFullHistory();
        }

        sendBtn.addEventListener("click", sendMessage);
        userInput.addEventListener("keydown", (e) => {
          if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
          }
        });
        resetBtn.addEventListener("click", () => {
          if (confirm("–ù–∞—á–∞—Ç—å –¥–∏–∞–ª–æ–≥ —Å–Ω–∞—á–∞–ª–∞? –ò—Å—Ç–æ—Ä–∏—è –±—É–¥–µ—Ç –æ—á–∏—â–µ–Ω–∞.")) {
            resetChat();
          }
        });
      })();
    </script>
  </body>
</html>
