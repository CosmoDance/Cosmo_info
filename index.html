<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>CosmoDance –ø–æ–º–æ—â–Ω–∏–∫</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
    }

    body {
      background: radial-gradient(circle at top, #252d5a 0, #050816 45%, #02030a 100%);
      color: #ffffff;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 16px;
    }

    .chat-wrapper {
      width: 100%;
      max-width: 480px;
      background: rgba(5, 9, 25, 0.9);
      border-radius: 24px;
      box-shadow: 0 18px 45px rgba(0, 0, 0, 0.7);
      border: 1px solid rgba(255, 255, 255, 0.08);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .chat-header {
      background: linear-gradient(135deg, #1f7afc 0%, #5936ff 50%, #9536ff 100%);
      padding: 16px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .header-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.15);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 20px;
    }

    .header-text {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .header-title {
      font-weight: 700;
      font-size: 16px;
    }

    .header-subtitle {
      font-size: 13px;
      opacity: 0.9;
    }

    .chat-body {
      padding: 16px;
      padding-bottom: 8px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      overflow-y: auto;
      max-height: 70vh;
    }

    .bubble {
      max-width: 90%;
      padding: 10px 12px;
      border-radius: 16px;
      font-size: 14px;
      line-height: 1.4;
      white-space: pre-line;
    }

    .bubble.assistant {
      align-self: flex-start;
      background: rgba(32, 35, 64, 0.95);
      border-bottom-left-radius: 4px;
    }

    .bubble.user {
      align-self: flex-end;
      background: #1f7afc;
      border-bottom-right-radius: 4px;
    }

    .typing-indicator {
      align-self: flex-start;
      display: inline-flex;
      gap: 4px;
      padding: 8px 10px;
      border-radius: 16px;
      background: rgba(32, 35, 64, 0.95);
      margin-top: 4px;
      margin-bottom: 4px;
    }

    .typing-indicator span {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.7);
      animation: blink 1s infinite ease-in-out;
    }

    .typing-indicator span:nth-child(2) {
      animation-delay: 0.2s;
    }

    .typing-indicator span:nth-child(3) {
      animation-delay: 0.4s;
    }

    @keyframes blink {
      0%, 80%, 100% { opacity: 0.2; transform: translateY(0); }
      40% { opacity: 1; transform: translateY(-2px); }
    }

    .chat-footer {
      padding: 10px 12px;
      border-top: 1px solid rgba(255, 255, 255, 0.08);
      display: flex;
      gap: 8px;
      background: rgba(5, 9, 25, 0.95);
    }

    .chat-input {
      flex: 1;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.16);
      background: rgba(8, 11, 30, 0.9);
      color: #fff;
      padding: 8px 14px;
      font-size: 14px;
      outline: none;
    }

    .chat-input::placeholder {
      color: rgba(255, 255, 255, 0.45);
    }

    .chat-send {
      border-radius: 999px;
      background: #1f7afc;
      border: none;
      color: white;
      padding: 0 16px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
    }

    .chat-send:disabled {
      opacity: 0.6;
      cursor: default;
    }

    .chat-toolbar {
      display: flex;
      justify-content: flex-end;
      padding: 4px 14px 8px;
      gap: 8px;
      font-size: 11px;
      opacity: 0.7;
    }

    .chat-toolbar button {
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      background: transparent;
      color: #fff;
      padding: 2px 8px;
      font-size: 11px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="chat-wrapper">
    <div class="chat-header">
      <div class="header-avatar">C</div>
      <div class="header-text">
        <div class="header-title">CosmoDance –ø–æ–º–æ—â–Ω–∏–∫</div>
        <div class="header-subtitle">–û—Ç–≤–µ—á–∞—é –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ —Å—Ç—É–¥–∏–∏ –∏ –∑–∞–ø–∏—Å—è—Ö –Ω–∞ –∑–∞–Ω—è—Ç–∏—è üí´</div>
      </div>
    </div>

    <div id="chatBody" class="chat-body"></div>

    <div class="chat-toolbar">
      <button id="newChatBtn">–ù–æ–≤—ã–π –¥–∏–∞–ª–æ–≥</button>
    </div>

    <div class="chat-footer">
      <input
        id="chatInput"
        class="chat-input"
        placeholder="–ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å –æ CosmoDance‚Ä¶"
      />
      <button id="sendBtn" class="chat-send">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
  </div>

  <script>
    const API_URL = "/chat"; // —Å–µ—Ä–≤–µ—Ä –æ—Ç–¥–∞—ë—Ç /chat
    const STORAGE_KEY = "cosmoDanceChatHistory";
    const TYPING_SPEED = 40; // –º—Å –Ω–∞ —Å–∏–º–≤–æ–ª ‚Äî –º–µ–¥–ª–µ–Ω–Ω–µ–µ, –±–ª–∏–∂–µ –∫ —á–µ–ª–æ–≤–µ–∫—É

    const chatBody = document.getElementById("chatBody");
    const chatInput = document.getElementById("chatInput");
    const sendBtn = document.getElementById("sendBtn");
    const newChatBtn = document.getElementById("newChatBtn");

    /** 
     * messages: [{ role: "user" | "assistant", content: "..." }]
     * –≠—Ç–æ –∏—Å—Ç–æ—Ä–∏—è, –∫–æ—Ç–æ—Ä—É—é –º—ã –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä.
     */
    let messages = [];

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï –ò–°–¢–û–†–ò–ò –ò–ó localStorage ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */

    function loadHistory() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;
        const parsed = JSON.parse(raw);
        if (Array.isArray(parsed)) {
          messages = parsed;
          renderAllMessages();
        }
      } catch (e) {
        console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å —Å—á–∏—Ç–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞:", e);
      }
    }

    function saveHistory() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(messages));
      } catch (e) {
        console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞:", e);
      }
    }

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –û–¢–†–ò–°–û–í–ö–ê –ß–ê–¢–ê ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */

    function createBubble(text, role) {
      const div = document.createElement("div");
      div.classList.add("bubble", role);
      div.textContent = text;
      return div;
    }

    function renderAllMessages() {
      chatBody.innerHTML = "";
      for (const msg of messages) {
        const bubble = createBubble(msg.content, msg.role === "user" ? "user" : "assistant");
        chatBody.appendChild(bubble);
      }
      chatBody.scrollTop = chatBody.scrollHeight;
    }

    function addUserMessage(text) {
      messages.push({ role: "user", content: text });
      const bubble = createBubble(text, "user");
      chatBody.appendChild(bubble);
      chatBody.scrollTop = chatBody.scrollHeight;
      saveHistory();
    }

    function addAssistantMessageInstant(text) {
      messages.push({ role: "assistant", content: text });
      const bubble = createBubble(text, "assistant");
      chatBody.appendChild(bubble);
      chatBody.scrollTop = chatBody.scrollHeight;
      saveHistory();
    }

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –ò–ù–î–ò–ö–ê–¢–û–† –ü–ï–ß–ê–¢–ò ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */

    let typingEl = null;

    function showTypingIndicator() {
      if (typingEl) return;
      typingEl = document.createElement("div");
      typingEl.className = "typing-indicator";
      typingEl.innerHTML = "<span></span><span></span><span></span>";
      chatBody.appendChild(typingEl);
      chatBody.scrollTop = chatBody.scrollHeight;
    }

    function hideTypingIndicator() {
      if (!typingEl) return;
      typingEl.remove();
      typingEl = null;
    }

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –ê–ù–ò–ú–ê–¶–ò–Ø ¬´–ë–û–¢ –ü–ï–ß–ê–¢–ê–ï–¢¬ª ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */

    async function typeAssistantReply(text) {
      const bubble = createBubble("", "assistant");
      chatBody.appendChild(bubble);
      chatBody.scrollTop = chatBody.scrollHeight;

      let current = "";
      for (let i = 0; i < text.length; i++) {
        const ch = text[i];
        current += ch;
        bubble.textContent = current;
        chatBody.scrollTop = chatBody.scrollHeight;
        await new Promise((r) => setTimeout(r, TYPING_SPEED));
      }

      // —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Ç–æ–≥–æ–≤—ã–π —Ç–µ–∫—Å—Ç –≤ –∏—Å—Ç–æ—Ä–∏—é
      messages.push({ role: "assistant", content: text });
      saveHistory();
    }

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –û–¢–ü–†–ê–í–ö–ê –°–û–û–ë–©–ï–ù–ò–Ø –ù–ê –°–ï–†–í–ï–† ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */

    async function sendMessage() {
      const text = chatInput.value.trim();
      if (!text) return;

      addUserMessage(text);
      chatInput.value = "";
      chatInput.focus();

      sendBtn.disabled = true;
      showTypingIndicator();

      try {
        const resp = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ messages }),
        });

        const data = await resp.json();
        hideTypingIndicator();

        const reply = data.reply || "–ò–∑–≤–∏–Ω–∏—Ç–µ, –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç.";
        await typeAssistantReply(reply);
      } catch (e) {
        console.error(e);
        hideTypingIndicator();
        addAssistantMessageInstant(
          "–ò–∑–≤–∏–Ω–∏—Ç–µ, —É –º–µ–Ω—è —Å–µ–π—á–∞—Å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ø–∞—É–∑–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑ —á—É—Ç—å –ø–æ–∑–∂–µ."
        );
      } finally {
        sendBtn.disabled = false;
      }
    }

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –ù–û–í–´–ô –î–ò–ê–õ–û–ì ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */

    function resetChat() {
      messages = [];
      localStorage.removeItem(STORAGE_KEY);
      chatBody.innerHTML = "";
      // –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –±–æ—Ç–∞
      const welcome =
        "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç —Å—Ç—É–¥–∏–∏ CosmoDance.\n" +
        "–ú–æ–≥—É –ø–æ–º–æ—á—å –≤—ã–±—Ä–∞—Ç—å –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ, –ø–æ–¥—Å–∫–∞–∑–∞—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∏ –∞–¥—Ä–µ—Å–∞ —Ñ–∏–ª–∏–∞–ª–æ–≤. " +
        "–ù–∞–ø–∏—à–∏—Ç–µ, —á—Ç–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ —É–∑–Ω–∞—Ç—å üôÇ";
      messages.push({ role: "assistant", content: welcome });
      const bubble = createBubble(welcome, "assistant");
      chatBody.appendChild(bubble);
      chatBody.scrollTop = chatBody.scrollHeight;
      saveHistory();
    }

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */

    sendBtn.addEventListener("click", sendMessage);

    chatInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    newChatBtn.addEventListener("click", () => {
      resetChat();
    });

    // —Å—Ç–∞—Ä—Ç: –≥—Ä—É–∑–∏–º –∏—Å—Ç–æ—Ä–∏—é, –µ—Å–ª–∏ –µ—Å—Ç—å, –∏–Ω–∞—á–µ —Å—Ç–∞—Ä—Ç–æ–≤–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
    loadHistory();
    if (messages.length === 0) {
      resetChat();
    } else {
      // –µ—Å–ª–∏ –∏—Å—Ç–æ—Ä–∏—è –µ—Å—Ç—å ‚Äî –ø—Ä–æ—Å—Ç–æ —É–±–µ–¥–∏–º—Å—è, —á—Ç–æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –Ω–µ –¥—É–±–ª–∏—Ä—É–µ–º
      renderAllMessages();
    }
  </script>
</body>
</html>
