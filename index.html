<script>
  // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ URL API
  const API_URL = (() => {
    const hostname = window.location.hostname;
    const protocol = window.location.protocol;
    
    if (hostname === 'localhost' || hostname === '127.0.0.1') {
      return `${protocol}//localhost:10000/chat`;
    }
    
    // –î–ª—è GitHub Pages –∏–ª–∏ –¥—Ä—É–≥–æ–≥–æ —Ö–æ—Å—Ç–∏–Ω–≥–∞
    if (hostname.includes('github.io') || hostname.includes('netlify.app')) {
      return 'https://–≤–∞—à-—Å–µ—Ä–≤–µ—Ä.onrender.com/chat'; // –£–∫–∞–∂–∏—Ç–µ —Ä–µ–∞–ª—å–Ω—ã–π URL –±—ç–∫–µ–Ω–¥–∞
    }
    
    return '/chat'; // –î–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞ –Ω–∞ –æ–¥–Ω–æ–º –¥–æ–º–µ–Ω–µ
  })();

  const TYPING_SPEED = 40;
  const INACTIVITY_LIMIT_MS = 10 * 60 * 1000;
  const MAX_MESSAGE_LENGTH = 1000;

  const messagesEl = document.getElementById("messages");
  const userInput = document.getElementById("userInput");
  const sendBtn = document.getElementById("sendBtn");
  const resetBtn = document.getElementById("resetBtn");
  const statusEl = document.getElementById("status");

  let history = [];
  let isBotTyping = false;
  let typingTimeout = null;
  let scrollScheduled = false;

  const STORAGE_KEY = "cosmo_chat_history_v2";
  const STORAGE_LAST_ACTIVITY = "cosmo_chat_last_activity";

  // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞
  function scrollToBottom() {
    if (!scrollScheduled) {
      scrollScheduled = true;
      requestAnimationFrame(() => {
        messagesEl.scrollTop = messagesEl.scrollHeight;
        scrollScheduled = false;
      });
    }
  }

  function saveHistory() {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
      localStorage.setItem(STORAGE_LAST_ACTIVITY, String(Date.now()));
    } catch (e) {
      console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é:", e);
    }
  }

  function loadHistory() {
    try {
      const last = localStorage.getItem(STORAGE_LAST_ACTIVITY);
      if (last) {
        const diff = Date.now() - Number(last);
        if (diff > INACTIVITY_LIMIT_MS) {
          localStorage.removeItem(STORAGE_KEY);
          localStorage.removeItem(STORAGE_LAST_ACTIVITY);
          return;
        }
      }

      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return;
      
      const arr = JSON.parse(raw);
      if (Array.isArray(arr)) {
        // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –ø–æ—Å–ª–µ–¥–Ω–∏–º–∏ 20 —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
        history = arr.slice(-20);
        history.forEach((m) => {
          addMessageBubble(m.role, m.content, false);
        });
        scrollToBottom();
      }
    } catch (e) {
      console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é:", e);
    }
  }

  function setStatus(text) {
    statusEl.textContent = text;
  }

  function addMessageBubble(role, text, save = true) {
    const div = document.createElement("div");
    if (role === "system") {
      div.className = "bubble system";
    } else {
      div.className = "bubble " + (role === "user" ? "user" : "bot");
    }
    div.textContent = text;
    messagesEl.appendChild(div);
    
    if (save && (role === "user" || role === "assistant")) {
      history.push({
        role: role === "assistant" ? "assistant" : "user",
        content: text,
      });
      
      // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é 30 —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
      if (history.length > 30) {
        history = history.slice(-30);
      }
      
      saveHistory();
    }
  }

  function showTypingIndicator() {
    removeTypingIndicator();
    const div = document.createElement("div");
    div.className = "typing-indicator";
    div.id = "typingIndicator";
    div.textContent = "CosmoDance –±–æ—Ç –ø–µ—á–∞—Ç–∞–µ—Ç...";
    messagesEl.appendChild(div);
    scrollToBottom();
  }

  function removeTypingIndicator() {
    const el = document.getElementById("typingIndicator");
    if (el) el.remove();
  }

  async function sendMessage() {
    if (isBotTyping) return;

    const text = userInput.value.trim();
    if (!text) return;
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª–∏–Ω—ã —Å–æ–æ–±—â–µ–Ω–∏—è
    if (text.length > MAX_MESSAGE_LENGTH) {
      addMessageBubble(
        "system", 
        `–°–æ–æ–±—â–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ (${text.length} —Å–∏–º–≤–æ–ª–æ–≤). –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–æ–∫—Ä–∞—Ç–∏—Ç–µ –¥–æ ${MAX_MESSAGE_LENGTH} —Å–∏–º–≤–æ–ª–æ–≤.`, 
        false
      );
      return;
    }

    addMessageBubble("user", text, true);
    userInput.value = "";
    scrollToBottom();

    // –ë–ª–æ–∫–∏—Ä—É–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
    isBotTyping = true;
    sendBtn.disabled = true;
    userInput.disabled = true;
    sendBtn.textContent = "–û—Ç–ø—Ä–∞–≤–∫–∞...";
    setStatus("CosmoDance –±–æ—Ç –ø–µ—á–∞—Ç–∞–µ—Ç‚Ä¶");
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–∞–±–æ—Ä–∞
    showTypingIndicator();

    try {
      const payload = {
        message: text,
        history: history,
      };

      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 —Å–µ–∫—É–Ω–¥ —Ç–∞–π–º–∞—É—Ç

      const response = await fetch(API_URL, {
        method: "POST",
        headers: { 
          "Content-Type": "application/json",
          "Accept": "application/json"
        },
        body: JSON.stringify(payload),
        signal: controller.signal
      });

      clearTimeout(timeoutId);

      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }

      const data = await response.json();
      const reply = (data && data.reply) || "–ò–∑–≤–∏–Ω–∏—Ç–µ, –æ—Ç–≤–µ—Ç –Ω–µ –ø–æ–ª—É—á–µ–Ω.";

      // –£–±–∏—Ä–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Ç–≤–µ—Ç
      removeTypingIndicator();
      await showBotReplyAnimated(reply);
      
    } catch (e) {
      console.error("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:", e);
      
      removeTypingIndicator();
      
      let errorMessage = "–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–ø—Ä–æ—Å–∞. ";
      
      if (e.name === 'AbortError') {
        errorMessage = "–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.";
      } else if (e.message.includes('Failed to fetch')) {
        errorMessage = "–ù–µ—Ç —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.";
      }
      
      addMessageBubble("assistant", errorMessage, true);
      
    } finally {
      // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
      isBotTyping = false;
      sendBtn.disabled = false;
      userInput.disabled = false;
      sendBtn.textContent = "–û—Ç–ø—Ä–∞–≤–∏—Ç—å";
      userInput.focus();
      setStatus("–û–Ω–ª–∞–π–Ω");
      scrollToBottom();
    }
  }

  async function showBotReplyAnimated(text) {
    // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–π —Ç–∞–π–º–µ—Ä
    clearTimeout(typingTimeout);
    typingTimeout = null;
    
    // –°–æ–∑–¥–∞–µ–º –ø—É–∑—ã—Ä—å –¥–ª—è –±–æ—Ç–∞
    const bubble = document.createElement("div");
    bubble.className = "bubble bot";
    bubble.textContent = "";
    messagesEl.appendChild(bubble);
    scrollToBottom();

    let i = 0;
    const len = text.length;

    await new Promise((resolve) => {
      function typeNext() {
        if (i >= len) {
          typingTimeout = null;
          resolve();
          return;
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Å–∏–º–≤–æ–ª—ã –≥—Ä—É–ø–ø–∞–º–∏ –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è
        const chunkSize = Math.random() > 0.7 ? 2 : 1; // –ò–Ω–æ–≥–¥–∞ –ø–æ 2 —Å–∏–º–≤–æ–ª–∞
        const end = Math.min(i + chunkSize, len);
        bubble.textContent += text.substring(i, end);
        i = end;
        
        // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –Ω–µ –∫–∞–∂–¥—ã–π —Ä–∞–∑, –∞ –∏–Ω–æ–≥–¥–∞
        if (i % 20 === 0 || i >= len) {
          scrollToBottom();
        }
        
        typingTimeout = setTimeout(typeNext, TYPING_SPEED);
      }
      typeNext();
    });

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç
    history.push({ role: "assistant", content: text });
    saveHistory();
    scrollToBottom();
  }

  function resetChat() {
    if (isBotTyping) {
      if (!confirm("–ë–æ—Ç —Å–µ–π—á–∞—Å –æ—Ç–≤–µ—á–∞–µ—Ç. –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –Ω–∞—á–∞—Ç—å –Ω–æ–≤—ã–π –¥–∏–∞–ª–æ–≥?")) {
        return;
      }
    }
    
    history = [];
    isBotTyping = false;
    clearTimeout(typingTimeout);
    typingTimeout = null;
    messagesEl.innerHTML = "";
    
    try {
      localStorage.removeItem(STORAGE_KEY);
      localStorage.removeItem(STORAGE_LAST_ACTIVITY);
    } catch (e) {
      console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—á–∏—Å—Ç–∏—Ç—å —Ö—Ä–∞–Ω–∏–ª–∏—â–µ:", e);
    }
    
    setStatus("–û–Ω–ª–∞–π–Ω");
    addMessageBubble(
      "system",
      "üëã –ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø —á–∞—Ç-–±–æ—Ç —Å—Ç—É–¥–∏–∏ —Ç–∞–Ω—Ü–µ–≤ CosmoDance.\n\n" +
      "–Ø –ø–æ–º–æ–≥—É –≤–∞–º —Å:\n" +
      "‚Ä¢ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ–º –∑–∞–Ω—è—Ç–∏–π\n" +
      "‚Ä¢ –°—Ç–æ–∏–º–æ—Å—Ç—å—é –∏ –∞–±–æ–Ω–µ–º–µ–Ω—Ç–∞–º–∏\n" +
      "‚Ä¢ –í—ã–±–æ—Ä–æ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è\n" +
      "‚Ä¢ –ó–∞–ø–∏—Å—å—é –Ω–∞ –ø—Ä–æ–±–Ω–æ–µ –∑–∞–Ω—è—Ç–∏–µ\n" +
      "‚Ä¢ –û—Ç–≤–µ—Ç–∞–º–∏ –Ω–∞ —á–∞—Å—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã\n\n" +
      "–ó–∞–¥–∞–π—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å –æ —Å—Ç—É–¥–∏–∏ CosmoDance!",
      false
    );
    
    userInput.focus();
    scrollToBottom();
  }

  // ----- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π -----

  sendBtn.addEventListener("click", sendMessage);

  userInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
    
    // Ctrl+Enter –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
    if (e.key === "Enter" && e.ctrlKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  // –ê–≤—Ç–æ—Ñ–æ–∫—É—Å –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
  userInput.addEventListener("focus", () => {
    userInput.style.borderColor = "#6b4bff";
  });
  
  userInput.addEventListener("blur", () => {
    userInput.style.borderColor = "rgba(255, 255, 255, 0.14)";
  });

  resetBtn.addEventListener("click", resetChat);

  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–±—Ä–æ—Å –ø—Ä–∏ –¥–æ–ª–≥–æ–º –±–µ–∑–¥–µ–π—Å—Ç–≤–∏–∏
  function checkInactivity() {
    try {
      const last = localStorage.getItem(STORAGE_LAST_ACTIVITY);
      if (last) {
        const diff = Date.now() - Number(last);
        if (diff > INACTIVITY_LIMIT_MS && history.length > 0) {
          console.log("–ê–≤—Ç–æ—Å–±—Ä–æ—Å –∏–∑-–∑–∞ –±–µ–∑–¥–µ–π—Å—Ç–≤–∏—è");
          resetChat();
        }
      }
    } catch (e) {
      // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏
    }
  }

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
  window.addEventListener('DOMContentLoaded', () => {
    loadHistory();
    checkInactivity();
    
    if (history.length === 0) {
      resetChat();
    } else {
      setStatus("–û–Ω–ª–∞–π–Ω");
      userInput.focus();
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–µ—Ä–∞
    fetch(API_URL.replace('/chat', '/health')).catch(() => {
      setStatus("–°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω");
      sendBtn.disabled = true;
      userInput.placeholder = "–°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.";
    });
  });
</script>
