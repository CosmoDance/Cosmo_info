import path from "path";
import { fileURLToPath } from "url";

import express from "express";
import cors from "cors";
import dotenv from "dotenv";
import OpenAI from "openai";

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

dotenv.config();

// ---------- ÐÐÐ¡Ð¢Ð ÐžÐ™ÐšÐ Ð¡Ð•Ð Ð’Ð•Ð Ð ----------
const app = express();
app.use(cors());
app.use(express.json({ limit: "2mb" })); // Ð¿Ñ€Ð¸Ð½Ð¸Ð¼Ð°ÐµÐ¼ JSON Ð´Ð¾ 2 ÐœÐ‘

// ---------- ÐšÐ›Ð˜Ð•ÐÐ¢ OPENAI ----------
const client = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});

// ---------- Ð“Ð›ÐÐ’ÐÐÐ¯ Ð¡Ð˜Ð¡Ð¢Ð•ÐœÐÐÐ¯ ÐŸÐžÐ”Ð¡ÐšÐÐ—ÐšÐ ----------
const SYSTEM_PROMPT = `
Ð¢Ñ‹ â€” Ð´Ñ€ÑƒÐ¶ÐµÐ»ÑŽÐ±Ð½Ñ‹Ð¹, Ð²Ð½Ð¸Ð¼Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¹ Ð°ÑÑÐ¸ÑÑ‚ÐµÐ½Ñ‚ ÑÑ‚ÑƒÐ´Ð¸Ð¸ Ñ‚Ð°Ð½Ñ†ÐµÐ² CosmoDance.

Ð¢Ð²Ð¾Ñ Ð·Ð°Ð´Ð°Ñ‡Ð°:
- Ð¿Ð¾Ð¼Ð¾Ð³Ð°Ñ‚ÑŒ Ñ Ð²Ñ‹Ð±Ð¾Ñ€Ð¾Ð¼ Ñ„Ð¸Ð»Ð¸Ð°Ð»Ð°, Ð½Ð°Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ, Ð³Ñ€ÑƒÐ¿Ð¿Ñ‹ Ð¸ Ñ€Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸Ñ;
- Ð¾Ð±ÑŠÑÑÐ½ÑÑ‚ÑŒ ÑƒÑÐ»Ð¾Ð²Ð¸Ñ Ð°Ð±Ð¾Ð½ÐµÐ¼ÐµÐ½Ñ‚Ð¾Ð² Ð¸ Ð¿Ñ€Ð¾Ð±Ð½Ñ‹Ñ… Ð·Ð°Ð½ÑÑ‚Ð¸Ð¹;
- Ð¿Ð¾Ð¼Ð¾Ð³Ð°Ñ‚ÑŒ Ñ€Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑÐ¼ Ñ Ð²Ñ‹Ð±Ð¾Ñ€Ð¾Ð¼ Ð·Ð°Ð½ÑÑ‚Ð¸Ð¹ Ð´Ð»Ñ Ð´ÐµÑ‚ÐµÐ¹ (ÑƒÑ‡Ð¸Ñ‚Ñ‹Ð²Ð°Ð¹ Ð²Ð¾Ð·Ñ€Ð°ÑÑ‚, Ð¾Ð¿Ñ‹Ñ‚, Ñ†ÐµÐ»Ð¸);
- Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°Ñ‚ÑŒ, ÑƒÑÐ¿Ð¾ÐºÐ°Ð¸Ð²Ð°Ñ‚ÑŒ, Ð¼Ð¾Ñ‚Ð¸Ð²Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ñ‡ÐµÐ»Ð¾Ð²ÐµÐºÐ° Ð¿Ñ€Ð¸Ð¹Ñ‚Ð¸ Ð½Ð° Ð¿Ñ€Ð¾Ð±Ð½Ð¾Ðµ Ð·Ð°Ð½ÑÑ‚Ð¸Ðµ.

ÐŸÑ€Ð°Ð²Ð¸Ð»Ð°:
- Ð’ÑÐµÐ³Ð´Ð° Ð¾Ñ‚Ð²ÐµÑ‡Ð°Ð¹ Ð²ÐµÐ¶Ð»Ð¸Ð²Ð¾ Ð¸ Ð½Ð° "Ð’Ñ‹".
- ÐÐµ Ð²Ñ‹Ñ…Ð¾Ð´Ð¸ Ð·Ð° Ñ€Ð°Ð¼ÐºÐ¸ Ñ‚ÐµÐ¼ Ð¿Ñ€Ð¾ ÑÑ‚ÑƒÐ´Ð¸ÑŽ, Ñ‚Ð°Ð½Ñ†Ñ‹ Ð¸ Ð¾Ñ€Ð³Ð°Ð½Ð¸Ð·Ð°Ñ†Ð¸Ð¾Ð½Ð½Ñ‹Ðµ Ð²Ð¾Ð¿Ñ€Ð¾ÑÑ‹.
- Ð•ÑÐ»Ð¸ Ð²Ð¾Ð¿Ñ€Ð¾Ñ Ð²Ð¾Ð¾Ð±Ñ‰Ðµ Ð½Ðµ Ð¿Ñ€Ð¾ ÑÑ‚ÑƒÐ´Ð¸ÑŽ, Ð¼ÑÐ³ÐºÐ¾ ÑÐºÐ°Ð¶Ð¸, Ñ‡Ñ‚Ð¾ Ð¾Ñ‚Ð²ÐµÑ‡Ð°ÐµÑˆÑŒ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¿Ð¾ ÑÑ‚ÑƒÐ´Ð¸Ð¸ CosmoDance.
- Ð•ÑÐ»Ð¸ Ð½ÑƒÐ¶Ð½Ð° Ð¿Ð¾Ð¼Ð¾Ñ‰ÑŒ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð°, Ð¿Ð¸ÑˆÐ¸:
  "ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð¾ÑÑ‚Ð°Ð²ÑŒÑ‚Ðµ Ð½Ð¾Ð¼ÐµÑ€ Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½Ð°, Ð¸ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€ ÑÑ‚ÑƒÐ´Ð¸Ð¸ ÑÐ²ÑÐ¶ÐµÑ‚ÑÑ Ñ Ð²Ð°Ð¼Ð¸ Ð² Ñ€Ð°Ð±Ð¾Ñ‡ÐµÐµ Ð²Ñ€ÐµÐ¼Ñ."

Ð£Ñ‡Ñ‚Ð¸:
- Ð“Ñ€ÑƒÐ¿Ð¿Ð¾Ð²Ñ‹Ðµ Ð·Ð°Ð½ÑÑ‚Ð¸Ñ Ð¿Ñ€Ð¾Ñ…Ð¾Ð´ÑÑ‚ Ð¿Ð¾ Ñ„Ð¸ÐºÑÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð¾Ð¼Ñƒ Ñ€Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸ÑŽ, Ð° Ð½Ðµ "Ð² Ð»ÑŽÐ±Ð¾Ðµ ÑƒÐ´Ð¾Ð±Ð½Ð¾Ðµ Ð²Ñ€ÐµÐ¼Ñ".
- Ð˜Ð½Ð´Ð¸Ð²Ð¸Ð´ÑƒÐ°Ð»ÑŒÐ½Ñ‹Ðµ Ð·Ð°Ð½ÑÑ‚Ð¸Ñ Ð¼Ð¾Ð¶Ð½Ð¾ ÑÐ¾Ð³Ð»Ð°ÑÐ¾Ð²Ð°Ñ‚ÑŒ Ð¿Ð¾ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸ Ñ Ñ‚Ñ€ÐµÐ½ÐµÑ€Ð¾Ð¼.
- Ð•ÑÐ»Ð¸ Ñ‡ÐµÐ»Ð¾Ð²ÐµÐº Ð²Ð¾Ð»Ð½ÑƒÐµÑ‚ÑÑ Ð¸Ð·-Ð·Ð° Ð²Ð¾Ð·Ñ€Ð°ÑÑ‚Ð° Ð¸Ð»Ð¸ ÑƒÑ€Ð¾Ð²Ð½Ñ â€” Ð¾Ð±ÑŠÑÑÐ½Ð¸, Ñ‡Ñ‚Ð¾ Ð³Ñ€ÑƒÐ¿Ð¿Ñ‹ Ð¿Ð¾Ð´Ð±Ð¸Ñ€Ð°ÑŽÑ‚ÑÑ Ð¿Ð¾ ÑƒÑ€Ð¾Ð²Ð½ÑŽ,
  Ñ…Ð¾Ñ€ÐµÐ¾Ð³Ñ€Ð°Ñ„ Ð¿Ð¾Ð¼Ð¾Ð³Ð°ÐµÑ‚ Ð°Ð´Ð°Ð¿Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒÑÑ Ð¸ Ð¼Ð¾Ð¶Ð½Ð¾ ÑÐ¿Ð¾ÐºÐ¾Ð¹Ð½Ð¾ Ð¿Ñ€Ð¸Ð¹Ñ‚Ð¸ Ð½Ð° Ð¿Ñ€Ð¾Ð±Ð½Ð¾Ðµ Ð·Ð°Ð½ÑÑ‚Ð¸Ðµ.
`;

// Ð—Ð´ÐµÑÑŒ Ð±ÑƒÐ´ÐµÑ‚ Ð»ÐµÐ¶Ð°Ñ‚ÑŒ Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ð½Ð°Ñ Ð±Ð°Ð·Ð° (FAQ + Ñ€Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ, ÐºÐ¾Ñ‚Ð¾Ñ€Ð¾Ðµ Ñ‚Ñ‹ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÑˆÑŒ Ñ‡ÐµÑ€ÐµÐ· upload.js)
let KNOWLEDGE_BASE = null;

// ---------- ÐžÐ¢Ð”ÐÐ¢Ð¬ Ð¡Ð¢Ð ÐÐÐ˜Ð¦Ð£ Ð§ÐÐ¢Ð ----------
app.get("/", (req, res) => {
  res.sendFile(path.join(__dirname, "index.html"), {
    headers: { "Content-Type": "text/html; charset=utf-8" },
  });
});

// ÐÐµÐ±Ð¾Ð»ÑŒÑˆÐ¾Ð¹ health-Ñ‡ÐµÐº, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¿Ñ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ Ð¶Ð¸Ð² Ð»Ð¸ ÑÐµÑ€Ð²ÐµÑ€
app.get("/health", (req, res) => {
  res.json({ ok: true });
});

// ---------- ÐŸÐ Ð˜ÐÐ¯Ð¢Ð¬ Ð‘ÐÐ—Ð£ Ð—ÐÐÐÐ˜Ð™ ÐžÐ¢ upload.js ----------
app.post("/upload", (req, res) => {
  try {
    const body = req.body;

    if (!body) {
      return res.status(400).json({
        status: "error",
        message: "ÐŸÑƒÑÑ‚Ð¾Ðµ Ñ‚ÐµÐ»Ð¾ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ° Ð¿Ñ€Ð¸ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐµ Ð±Ð°Ð·Ñ‹",
      });
    }

    KNOWLEDGE_BASE = body;

    let count = null;
    if (Array.isArray(body)) {
      count = body.length;
    } else if (body.items && Array.isArray(body.items)) {
      count = body.items.length;
    } else if (body.groups && Array.isArray(body.groups)) {
      count = body.groups.length;
    }

    console.log("Ð‘Ð°Ð·Ð° Ð·Ð½Ð°Ð½Ð¸Ð¹ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð°, Ð·Ð°Ð¿Ð¸ÑÐµÐ¹:", count ?? "Ð½ÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ð¾");

    // Ð’ÐÐ–ÐÐž: Ð·Ð´ÐµÑÑŒ Ð¼Ñ‹ Ð²ÑÐµÐ³Ð´Ð° Ð¾Ñ‚Ð²ÐµÑ‡Ð°ÐµÐ¼ 200, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ñ„Ñ€Ð¾Ð½Ñ‚ Ð½Ðµ Ð²Ð¸Ð´ÐµÐ» ÑÐµÑ‚ÐµÐ²Ð¾Ð¹ Ð¾ÑˆÐ¸Ð±ÐºÐ¸
    return res.json({
      status: "ok",
      message: "Ð‘Ð°Ð·Ð° Ð¿Ñ€Ð¸Ð½ÑÑ‚Ð° Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ",
      count,
    });
  } catch (e) {
    console.error("ÐžÑˆÐ¸Ð±ÐºÐ° Ð² /upload:", e);
    // Ð´Ð°Ð¶Ðµ Ð¿Ñ€Ð¸ Ð¾ÑˆÐ¸Ð±ÐºÐµ Ð¾Ñ‚Ð´Ð°Ñ‘Ð¼ 200, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ñ„Ñ€Ð¾Ð½Ñ‚ Ð½Ðµ Ð¿Ð°Ð´Ð°Ð»
    return res.json({
      status: "error",
      message: "ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐµ Ð±Ð°Ð·Ñ‹ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€",
    });
  }
});

// ---------- ÐŸÐžÐ”Ð“ÐžÐ¢ÐžÐ’ÐšÐ Ð¢Ð•ÐšÐ¡Ð¢Ð Ð‘ÐÐ—Ð« Ð”Ð›Ð¯ ÐœÐžÐ”Ð•Ð›Ð˜ ----------
function buildKnowledgeText() {
  if (!KNOWLEDGE_BASE) return "";

  // Ð’Ð°Ñ€Ð¸Ð°Ð½Ñ‚ 1: Ð¼Ð°ÑÑÐ¸Ð² Q/A
  if (Array.isArray(KNOWLEDGE_BASE)) {
    const lines = KNOWLEDGE_BASE.map((item, i) => {
      const q = item.question || item.q || "";
      const a = item.answer || item.a || "";
      return `Q${i + 1}: ${q}\nA${i + 1}: ${a}`;
    });
    return (
      "\n\nÐ’Ð¾Ñ‚ Ð±Ð°Ð·Ð° Ð·Ð½Ð°Ð½Ð¸Ð¹ CosmoDance (Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ ÐµÑ‘ ÐºÐ°Ðº Ð³Ð»Ð°Ð²Ð½Ñ‹Ð¹ Ð¸ÑÑ‚Ð¾Ñ‡Ð½Ð¸Ðº Ñ„Ð°ÐºÑ‚Ð¾Ð², Ð½Ðµ Ð²Ñ‹Ð´ÑƒÐ¼Ñ‹Ð²Ð°Ð¹):\n" +
      lines.join("\n\n")
    );
  }

  // Ð’Ð°Ñ€Ð¸Ð°Ð½Ñ‚ 2: Ð¾Ð±ÑŠÐµÐºÑ‚ c Ð¿Ð¾Ð»ÐµÐ¼ items
  if (KNOWLEDGE_BASE.items && Array.isArray(KNOWLEDGE_BASE.items)) {
    const lines = KNOWLEDGE_BASE.items.map((item, i) => {
      const q = item.question || item.q || "";
      const a = item.answer || item.a || "";
      return `Q${i + 1}: ${q}\nA${i + 1}: ${a}`;
    });
    return (
      "\n\nÐ’Ð¾Ñ‚ Ð±Ð°Ð·Ð° Ð·Ð½Ð°Ð½Ð¸Ð¹ CosmoDance (Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ ÐµÑ‘ ÐºÐ°Ðº Ð³Ð»Ð°Ð²Ð½Ñ‹Ð¹ Ð¸ÑÑ‚Ð¾Ñ‡Ð½Ð¸Ðº Ñ„Ð°ÐºÑ‚Ð¾Ð², Ð½Ðµ Ð²Ñ‹Ð´ÑƒÐ¼Ñ‹Ð²Ð°Ð¹):\n" +
      lines.join("\n\n")
    );
  }

  // Ð’Ð°Ñ€Ð¸Ð°Ð½Ñ‚ 3: Ð¾Ð±ÑŠÐµÐºÑ‚ Ñ Ð¿Ð¾Ð»ÐµÐ¼ groups (Ð½Ð°ÑˆÐµ Ñ€Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ð²ÑÐµÑ… Ñ„Ð¸Ð»Ð¸Ð°Ð»Ð¾Ð²)
  if (KNOWLEDGE_BASE.groups && Array.isArray(KNOWLEDGE_BASE.groups)) {
    const lines = KNOWLEDGE_BASE.groups.map((g, i) => {
      const branch = g.branch || "";
      const name = g.group_name || "";
      const teacher = g.teacher || "";
      const level = g.level || "";
      const schedule = g.schedule || {};
      const scheduleStr = Object.entries(schedule)
        .filter(([, val]) => val)
        .map(([day, val]) => `${day}: ${val}`)
        .join("; ");
      return `Ð“Ñ€ÑƒÐ¿Ð¿Ð° ${i + 1}: Ñ„Ð¸Ð»Ð¸Ð°Ð» ${branch}, Ð½Ð°Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ "${name}", ÑƒÑ€Ð¾Ð²ÐµÐ½ÑŒ: ${level || "Ð»ÑŽÐ±Ð¾Ð¹"}, Ð¿Ñ€ÐµÐ¿Ð¾Ð´Ð°Ð²Ð°Ñ‚ÐµÐ»ÑŒ: ${teacher || "ÑƒÑ‚Ð¾Ñ‡Ð½ÑÐµÑ‚ÑÑ"}, Ñ€Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ: ${scheduleStr}`;
    });

    return (
      "\n\nÐ’Ð¾Ñ‚ Ñ€Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ð³Ñ€ÑƒÐ¿Ð¿ CosmoDance Ð¿Ð¾ Ñ„Ð¸Ð»Ð¸Ð°Ð»Ð°Ð¼. Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ ÐµÐ³Ð¾, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ñ‚Ð¾Ñ‡Ð½Ð¾ Ð¿Ð¾Ð´Ð±Ð¸Ñ€Ð°Ñ‚ÑŒ Ð³Ñ€ÑƒÐ¿Ð¿Ñ‹ Ð¸ Ñ€Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ:\n" +
      lines.join("\n\n")
    );
  }

  // ÐÐ° Ð²ÑÑÐºÐ¸Ð¹ ÑÐ»ÑƒÑ‡Ð°Ð¹ â€” Ð¿Ñ€Ð¾ÑÑ‚Ð¾ ÑÐµÑ€Ð¸Ð°Ð»Ð¸Ð·ÑƒÐµÐ¼ ÐºÐ°Ðº Ñ‚ÐµÐºÑÑ‚
  try {
    return (
      "\n\nÐ’Ð¾Ñ‚ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð°Ñ Ð±Ð°Ð·Ð° Ð·Ð½Ð°Ð½Ð¸Ð¹ CosmoDance (JSON):\n" +
      JSON.stringify(KNOWLEDGE_BASE, null, 2)
    );
  } catch {
    return "";
  }
}

// ---------- ÐžÐ¡ÐÐžÐ’ÐÐžÐ™ Ð§ÐÐ¢ /chat ----------
app.post("/chat", async (req, res) => {
  try {
    const body = req.body || {};
    const userMessageRaw = body.userMessage || body.message || "";

    const userMessage = String(userMessageRaw).trim();

    if (!userMessage) {
      return res.json({
        ok: false,
        reply: "ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð½Ð°Ð¿Ð¸ÑˆÐ¸Ñ‚Ðµ Ð²Ð°Ñˆ Ð²Ð¾Ð¿Ñ€Ð¾Ñ Ð¾ ÑÑ‚ÑƒÐ´Ð¸Ð¸ CosmoDance ðŸ™‚",
      });
    }

    // Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚ Ð±Ð°Ð·Ñ‹
    const knowledgeText = buildKnowledgeText();

    // ÐÐµÐ¼Ð½Ð¾Ð³Ð¾ Ñ…Ð¸Ð½Ñ‚Ð¾Ð² Ð¼Ð¾Ð´ÐµÐ»Ð¸, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¾Ð½Ð° Ð»ÑƒÑ‡ÑˆÐµ Ð¿Ð°Ñ€ÑÐ¸Ð»Ð° "5 Ð»ÐµÑ‚ Ð·Ð²Ñ‘Ð·Ð´Ð½Ð°Ñ" Ð¸ Ñ‚.Ð¿.
    const EXTRA_INSTRUCTIONS = `
ÐžÐ±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°Ð¹ ÐºÐ¾Ñ€Ð¾Ñ‚ÐºÐ¸Ðµ Ð¾Ñ‚Ð²ÐµÑ‚Ñ‹ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ, Ð³Ð´Ðµ Ð¾Ð½ Ð¼Ð¾Ð¶ÐµÑ‚ Ð½Ð°Ð¿Ð¸ÑÐ°Ñ‚ÑŒ Ð½ÐµÑÐºÐ¾Ð»ÑŒÐºÐ¾ Ñ„Ð°ÐºÑ‚Ð¾Ð² Ð² Ð¾Ð´Ð½Ð¾Ð¹ Ñ„Ñ€Ð°Ð·Ðµ
(Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€: "5 Ð»ÐµÑ‚ Ð·Ð²ÐµÐ·Ð´Ð½Ð°Ñ", "Ð´Ð»Ñ Ñ€ÐµÐ±ÐµÐ½ÐºÐ° 7 Ð»ÐµÑ‚, Ð”Ñ‹Ð±ÐµÐ½ÐºÐ¾").
Ð¡Ð°Ð¼Ð¾ÑÑ‚Ð¾ÑÑ‚ÐµÐ»ÑŒÐ½Ð¾ Ð²Ñ‹Ð´ÐµÐ»ÑÐ¹ Ð¾Ñ‚Ñ‚ÑƒÐ´Ð°:
- Ñ„Ð¸Ð»Ð¸Ð°Ð» (Ð—Ð²Ñ‘Ð·Ð´Ð½Ð°Ñ / ÐžÐ·ÐµÑ€ÐºÐ¸ / Ð”Ñ‹Ð±ÐµÐ½ÐºÐ¾ / ÐšÑƒÐ¿Ñ‡Ð¸Ð½Ð¾, ÑƒÑ‡Ð¸Ñ‚Ñ‹Ð²Ð°Ð¹ Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚Ñ‹ Ð½Ð°Ð¿Ð¸ÑÐ°Ð½Ð¸Ñ Ð¸ Ð±ÐµÐ· "Ñ‘");
- Ð²Ð¾Ð·Ñ€Ð°ÑÑ‚ Ñ€ÐµÐ±ÐµÐ½ÐºÐ°, ÐµÑÐ»Ð¸ Ð¾Ð½ ÐµÑÑ‚ÑŒ;
- ÑƒÐºÐ°Ð·Ð°Ð½Ð¸Ðµ, Ð´Ð»Ñ ÐºÐ¾Ð³Ð¾ Ð·Ð°Ð½ÑÑ‚Ð¸Ðµ (Ñ€ÐµÐ±ÐµÐ½Ð¾Ðº / Ð²Ð·Ñ€Ð¾ÑÐ»Ñ‹Ð¹).

ÐÐµ Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€ÑÐ¹ Ð²Ð¾Ð¿Ñ€Ð¾ÑÑ‹, Ð½Ð° ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ ÑƒÐ¶Ðµ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½ ÑÐ²Ð½Ñ‹Ð¹ Ð¾Ñ‚Ð²ÐµÑ‚ Ð² Ñ‚ÐµÐºÑƒÑ‰ÐµÐ¼ Ð´Ð¸Ð°Ð»Ð¾Ð³Ðµ.
`;

    // Ð•ÑÐ»Ð¸ Ñ„Ñ€Ð¾Ð½Ñ‚ Ð¿Ñ€Ð¸ÑÑ‹Ð»Ð°ÐµÑ‚ Ð¸ÑÑ‚Ð¾Ñ€Ð¸ÑŽ â€” Ð´Ð¾Ð±Ð°Ð²Ð¸Ð¼, ÐµÑÐ»Ð¸ Ð½ÐµÑ‚ â€” Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ð¸Ð³Ð½Ð¾Ñ€Ð¸Ñ€ÑƒÐµÐ¼.
    const history = Array.isArray(body.history) ? body.history : [];

    const messages = [];

    messages.push({
      role: "system",
      content: SYSTEM_PROMPT + EXTRA_INSTRUCTIONS + knowledgeText,
    });

    // Ð˜ÑÑ‚Ð¾Ñ€Ð¸Ñ Ð² Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ðµ [{role:"user"/"assistant", content:"..."}]
    for (const m of history) {
      if (!m || !m.role || !m.content) continue;
      messages.push({
        role: m.role === "assistant" ? "assistant" : "user",
        content: String(m.content),
      });
    }

    messages.push({ role: "user", content: userMessage });

    const completion = await client.chat.completions.create({
      model: "gpt-4.1-mini",
      messages,
      temperature: 0.6,
      max_tokens: 800,
    });

    const reply =
      completion.choices?.[0]?.message?.content?.trim() ||
      "Ð˜Ð·Ð²Ð¸Ð½Ð¸Ñ‚Ðµ, Ñƒ Ð¼ÐµÐ½Ñ Ð½Ðµ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ð»Ð¾ÑÑŒ ÑÑ„Ð¾Ñ€Ð¼Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð¾Ñ‚Ð²ÐµÑ‚. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð·Ð°Ð´Ð°Ñ‚ÑŒ Ð²Ð¾Ð¿Ñ€Ð¾Ñ Ð¸Ð½Ð°Ñ‡Ðµ.";

    return res.json({
      ok: true,
      reply,
    });
  } catch (error) {
    console.error("ÐžÑˆÐ¸Ð±ÐºÐ° Ð² /chat:", error);

    // ÐšÐ Ð˜Ð¢Ð˜Ð§Ð•Ð¡ÐšÐžÐ• ÐœÐ•Ð¡Ð¢Ðž:
    // Ð·Ð´ÐµÑÑŒ Ð¼Ñ‹ ÐÐ• Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ 500, Ð° Ð²ÑÐµÐ³Ð´Ð° 200 Ñ "Ñ‚ÐµÑ…Ð½Ð¸Ñ‡ÐµÑÐºÐ¾Ð¹ Ð¿Ð°ÑƒÐ·Ð¾Ð¹"
    // Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ñ„Ñ€Ð¾Ð½Ñ‚ ÐÐ• Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°Ð» "ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð¾Ñ‚Ð²ÐµÑ‚ Ð¾Ñ‚ ÑÐµÑ€Ð²ÐµÑ€Ð°".
    return res.json({
      ok: false,
      reply:
        "Ð˜Ð·Ð²Ð¸Ð½Ð¸Ñ‚Ðµ, ÑÐµÐ¹Ñ‡Ð°Ñ Ñƒ Ð¼ÐµÐ½Ñ Ð½ÐµÐ±Ð¾Ð»ÑŒÑˆÐ°Ñ Ñ‚ÐµÑ…Ð½Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ð¿Ð°ÑƒÐ·Ð°. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð·Ð°Ð´Ð°Ñ‚ÑŒ Ð²Ð¾Ð¿Ñ€Ð¾Ñ ÐµÑ‰Ñ‘ Ñ€Ð°Ð· Ð¸Ð»Ð¸ Ñ‡ÑƒÑ‚ÑŒ Ð¿Ð¾Ð·Ð¶Ðµ. Ð•ÑÐ»Ð¸ Ð¾ÑˆÐ¸Ð±ÐºÐ° Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€ÑÐµÑ‚ÑÑ, Ð¼Ð¾Ð¶Ð½Ð¾ Ð½Ð°Ð¿Ð¸ÑÐ°Ñ‚ÑŒ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ñƒ ÑÑ‚ÑƒÐ´Ð¸Ð¸.",
    });
  }
});

// ---------- Ð—ÐÐŸÐ£Ð¡Ðš Ð¡Ð•Ð Ð’Ð•Ð Ð ----------
const port = process.env.PORT || 10000;
app.listen(port, () => {
  console.log(`CosmoDance server listening on port ${port}`);
});
