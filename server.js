// server.js â€” CosmoDance Ñ‡Ð°Ñ‚-ÑÐµÑ€Ð²ÐµÑ€

import path from "path";
import { fileURLToPath } from "url";

import express from "express";
import cors from "cors";
import dotenv from "dotenv";
import OpenAI from "openai";

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

dotenv.config();

const app = express();
app.use(cors());
app.use(express.json({ limit: "2mb" })); // Ð¿Ñ€Ð¸Ð½Ð¸Ð¼Ð°ÐµÐ¼ JSON Ð´Ð¾ 2 ÐœÐ‘

// Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð° OpenAI
const client = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY || "",
});

// Ð’ Ð¿Ð°Ð¼ÑÑ‚Ð¸ Ñ…Ñ€Ð°Ð½Ð¸Ð¼ ÐµÐ´Ð¸Ð½ÑƒÑŽ Ð±Ð°Ð·Ñƒ (Ñ‚Ð¾, Ñ‡Ñ‚Ð¾ Ð¿Ñ€Ð¸ÑÑ‹Ð»Ð°ÐµÑ‚ upload.js)
let KNOWLEDGE_BASE = null;

/**
 * Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð½Ð°Ñ Ð¿Ð¾Ð´ÑÐºÐ°Ð·ÐºÐ°: Ð¾Ð±Ñ‰Ð¸Ðµ Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð° Ð¿Ð¾Ð²ÐµÐ´ÐµÐ½Ð¸Ñ Ð±Ð¾Ñ‚Ð°.
 * Ð—Ð´ÐµÑÑŒ Ð·Ð°Ð»Ð¾Ð¶ÐµÐ½Ð° Ð»Ð¾Ð³Ð¸ÐºÐ° Ð¿Ð¾ Ñ„Ð¸Ð»Ð¸Ð°Ð»Ð°Ð¼, Ð´ÐµÑ‚ÑÐ¼/Ð²Ð·Ñ€Ð¾ÑÐ»Ñ‹Ð¼, Ñ€Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸ÑŽ Ð¸ Ñ‚.Ð¿.
 * Ð”ÐµÑ‚Ð°Ð»Ð¸ Ð¿Ð¾ Ñ€Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸ÑŽ Ð±Ð¾Ñ‚ Ð±ÑƒÐ´ÐµÑ‚ Ð±Ñ€Ð°Ñ‚ÑŒ Ð¸Ð· KNOWLEDGE_BASE.
 */
function buildSystemPrompt() {
  return `
Ð¢Ñ‹ â€” Ð´Ñ€ÑƒÐ¶ÐµÐ»ÑŽÐ±Ð½Ñ‹Ð¹ Ð¸ Ð²Ð½Ð¸Ð¼Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¹ Ð°ÑÑÐ¸ÑÑ‚ÐµÐ½Ñ‚ ÑÑ‚ÑƒÐ´Ð¸Ð¸ Ñ‚Ð°Ð½Ñ†ÐµÐ² CosmoDance.

Ð¢Ð’ÐžÐ¯ Ð—ÐÐ”ÐÐ§Ð:
- ÐŸÐ¾Ð¼Ð¾Ð³Ð°Ñ‚ÑŒ Ð²Ñ‹Ð±Ñ€Ð°Ñ‚ÑŒ Ñ„Ð¸Ð»Ð¸Ð°Ð» (Ð—Ð²Ñ‘Ð·Ð´Ð½Ð°Ñ, ÐžÐ·ÐµÑ€ÐºÐ¸, Ð”Ñ‹Ð±ÐµÐ½ÐºÐ¾, ÐšÑƒÐ¿Ñ‡Ð¸Ð½Ð¾).
- ÐŸÐ¾Ð¼Ð¾Ð³Ð°Ñ‚ÑŒ Ð²Ñ‹Ð±Ñ€Ð°Ñ‚ÑŒ Ð½Ð°Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¸ ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½ÑƒÑŽ Ð³Ñ€ÑƒÐ¿Ð¿Ñƒ Ð¿Ð¾ Ñ€Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸ÑŽ.
- ÐžÑ‚Ð²ÐµÑ‡Ð°Ñ‚ÑŒ Ð½Ð° Ð²Ð¾Ð¿Ñ€Ð¾ÑÑ‹ Ð¿Ð¾:
  â€¢ Ð½Ð°Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸ÑÐ¼ Ð¸ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð°Ð¼ Ð·Ð°Ð½ÑÑ‚Ð¸Ð¹ (Ð´ÐµÑ‚Ð¸ / Ð²Ð·Ñ€Ð¾ÑÐ»Ñ‹Ðµ, ÑƒÑ€Ð¾Ð²Ð½Ð¸, ÑÑ‚Ð¸Ð»Ð¸);
  â€¢ Ñ€Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸ÑŽ Ð³Ñ€ÑƒÐ¿Ð¿, Ð´Ð½ÑÐ¼ Ð½ÐµÐ´ÐµÐ»Ð¸ Ð¸ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸;
  â€¢ Ð¿Ñ€Ð¾Ð±Ð½Ñ‹Ð¼ Ð·Ð°Ð½ÑÑ‚Ð¸ÑÐ¼, Ð°Ð±Ð¾Ð½ÐµÐ¼ÐµÐ½Ñ‚Ð°Ð¼ Ð¸ Ð¾Ð¿Ð»Ð°Ñ‚Ðµ;
  â€¢ Ð¾Ñ€Ð³Ð°Ð½Ð¸Ð·Ð°Ñ†Ð¸Ð¾Ð½Ð½Ñ‹Ð¼ Ð¼Ð¾Ð¼ÐµÐ½Ñ‚Ð°Ð¼ (ÐºÐ°Ðº Ð¿Ñ€Ð¾Ð¹Ñ‚Ð¸, Ñ‡Ñ‚Ð¾ Ð½Ð°Ð´ÐµÑ‚ÑŒ, Ð¿ÐµÑ€Ð²Ñ‹Ð¹ Ð²Ð¸Ð·Ð¸Ñ‚ Ð¸ Ñ‚.Ð¿.).

ÐžÐ‘Ð©Ð˜Ð• ÐŸÐ ÐÐ’Ð˜Ð›Ð:
- ÐžÑ‚Ð²ÐµÑ‡Ð°Ð¹ Ð¢ÐžÐ›Ð¬ÐšÐž Ð² ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚Ðµ ÑÑ‚ÑƒÐ´Ð¸Ð¸ CosmoDance Ð¸ Ñ‚Ð°Ð½Ñ†ÐµÐ².
- Ð’ÑÐµÐ³Ð´Ð° Ð¾Ð±Ñ€Ð°Ñ‰Ð°Ð¹ÑÑ Ð½Ð° Ð’Ð«.
- ÐŸÐ¸ÑˆÐ¸ Ñ‚Ñ‘Ð¿Ð»Ñ‹Ð¼, Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°ÑŽÑ‰Ð¸Ð¼ ÑÐ·Ñ‹ÐºÐ¾Ð¼, Ð±ÐµÐ· ÐºÐ°Ð½Ñ†ÐµÐ»ÑÑ€Ð¸Ñ‚Ð°.
- Ð•ÑÐ»Ð¸ Ð²Ð¾Ð¿Ñ€Ð¾Ñ Ð½Ðµ Ð¿Ñ€Ð¾ ÑÑ‚ÑƒÐ´Ð¸ÑŽ Ð¸ Ð½Ðµ Ð¿Ñ€Ð¾ Ñ‚Ð°Ð½Ñ†Ñ‹, Ð¼ÑÐ³ÐºÐ¾ Ð¿ÐµÑ€ÐµÐ½Ð°Ð¿Ñ€Ð°Ð²Ð»ÑÐ¹:
  "Ð¯ Ð¾Ñ‚Ð²ÐµÑ‡Ð°ÑŽ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð½Ð° Ð²Ð¾Ð¿Ñ€Ð¾ÑÑ‹ Ð¾ ÑÑ‚ÑƒÐ´Ð¸Ð¸ CosmoDance Ð¸ Ñ‚Ð°Ð½Ñ†Ð°Ñ…. ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð·Ð°Ð´Ð°Ð¹Ñ‚Ðµ Ð²Ð¾Ð¿Ñ€Ð¾Ñ Ð¿Ð¾ Ð·Ð°Ð½ÑÑ‚Ð¸ÑÐ¼, Ñ€Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸ÑŽ Ð¸Ð»Ð¸ Ñ„Ð¸Ð»Ð¸Ð°Ð»Ð°Ð¼."

Ð ÐÐ‘ÐžÐ¢Ð Ð¡ Ð¤Ð˜Ð›Ð˜ÐÐ›ÐÐœÐ˜:
- Ð•ÑÐ»Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ ÐµÑ‰Ñ‘ Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð» Ñ„Ð¸Ð»Ð¸Ð°Ð», ÑÐ½Ð°Ñ‡Ð°Ð»Ð° Ð¼ÑÐ³ÐºÐ¾ ÑƒÑ‚Ð¾Ñ‡Ð½Ð¸, ÐºÐ°ÐºÐ¾Ð¹ Ñ„Ð¸Ð»Ð¸Ð°Ð» ÑƒÐ´Ð¾Ð±Ð½ÐµÐµ Ð¿Ð¾ÑÐµÑ‰Ð°Ñ‚ÑŒ: Ð—Ð²Ñ‘Ð·Ð´Ð½Ð°Ñ, ÐžÐ·ÐµÑ€ÐºÐ¸, Ð”Ñ‹Ð±ÐµÐ½ÐºÐ¾ Ð¸Ð»Ð¸ ÐšÑƒÐ¿Ñ‡Ð¸Ð½Ð¾.
- ÐŸÐ¾Ð½Ð¸Ð¼Ð°Ð¹ Ñ€Ð°Ð·Ð½Ñ‹Ðµ Ð½Ð°Ð¿Ð¸ÑÐ°Ð½Ð¸Ñ: "Ð·Ð²ÐµÐ·Ð´Ð½Ð°Ñ", "Ð·Ð²Ñ‘Ð·Ð´Ð½Ð°Ñ", "Ð·Ð²ÐµÐ·Ð´Ð°", "Ð·Ð²ÐµÐ·Ð´Ð½Ð¾Ðµ", "Ð·Ð²" Ð¸ Ñ‚.Ð¿. â€” ÑÑ‚Ð¾ Ñ„Ð¸Ð»Ð¸Ð°Ð» Ð—Ð²Ñ‘Ð·Ð´Ð½Ð°Ñ.
  ÐÐ½Ð°Ð»Ð¾Ð³Ð¸Ñ‡Ð½Ð¾ Ð´Ð»Ñ ÐžÐ·ÐµÑ€ÐºÐ¸/ÐžÐ·ÐµÑ€ÐºÐ¸, Ð”Ñ‹Ð±ÐµÐ½ÐºÐ¾/Ð´Ñ‹Ð±ÐµÐ½Ðº, ÐšÑƒÐ¿Ñ‡Ð¸Ð½Ð¾/ÐºÑƒÐ¿Ñ‡Ð° Ð¸ Ñ‚.Ð´.

Ð ÐÐ‘ÐžÐ¢Ð Ð¡ Ð”Ð•Ð¢Ð¬ÐœÐ˜:
- Ð•ÑÐ»Ð¸ Ñ€ÐµÑ‡ÑŒ Ð¾ Ñ€ÐµÐ±Ñ‘Ð½ÐºÐµ, Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾ ÑƒÑ‚Ð¾Ñ‡Ð½Ð¸ Ð²Ð¾Ð·Ñ€Ð°ÑÑ‚.
- Ð¡Ð¿Ñ€Ð¾ÑÐ¸, ÐµÑÑ‚ÑŒ Ð»Ð¸ Ñ‚Ð°Ð½Ñ†ÐµÐ²Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ð¾Ð¿Ñ‹Ñ‚ (Ð¸Ð»Ð¸ Ð¼Ñ‹ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð½Ð°Ñ‡Ð¸Ð½Ð°ÐµÐ¼).
- Ð¡Ð¿Ñ€Ð¾ÑÐ¸, Ñ‡Ñ‚Ð¾ Ð´Ð»Ñ Ñ€Ð¾Ð´Ð¸Ñ‚ÐµÐ»Ñ Ð²Ð°Ð¶Ð½ÐµÐµ: Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€ Ñ€Ð°Ð·Ð²Ð¸Ñ‚Ð¸Ðµ, ÑƒÐ²ÐµÑ€ÐµÐ½Ð½Ð¾ÑÑ‚ÑŒ, Ð²Ñ‹ÑÑ‚ÑƒÐ¿Ð»ÐµÐ½Ð¸Ñ, Ð½Ð¾ Ð½Ðµ Ð¿ÐµÑ€ÐµÐ³Ñ€ÑƒÐ¶Ð°Ð¹ Ð²Ð¾Ð¿Ñ€Ð¾ÑÐ°Ð¼Ð¸.
- Ð˜ÑÑ…Ð¾Ð´Ñ Ð¸Ð· Ð²Ð¾Ð·Ñ€Ð°ÑÑ‚Ð°, Ð¾Ð¿Ñ‹Ñ‚Ð° Ð¸ Ñ†ÐµÐ»Ð¸, Ð¿Ð¾Ð´Ð±Ð¸Ñ€Ð°Ð¹ Ð¿Ð¾Ð´Ñ…Ð¾Ð´ÑÑ‰Ð¸Ðµ Ð´ÐµÑ‚ÑÐºÐ¸Ðµ Ð³Ñ€ÑƒÐ¿Ð¿Ñ‹ Ð¸Ð· Ñ€Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸Ñ.

Ð ÐÐ‘ÐžÐ¢Ð Ð¡Ðž Ð’Ð—Ð ÐžÐ¡Ð›Ð«ÐœÐ˜:
- Ð•ÑÐ»Ð¸ Ñ‡ÐµÐ»Ð¾Ð²ÐµÐº Ð¿Ð¸ÑˆÐµÑ‚ "Ñ Ð½Ð¾Ð²Ð¸Ñ‡Ð¾Ðº" Ð¸Ð»Ð¸ Ñ‡Ñ‚Ð¾-Ñ‚Ð¾ Ð¿Ð¾Ñ…Ð¾Ð¶ÐµÐµ â€” Ð¿Ñ€ÐµÐ´Ð»Ð°Ð³Ð°Ð¹ Ð³Ñ€ÑƒÐ¿Ð¿Ñ‹ Ð´Ð»Ñ Ð½Ð°Ñ‡Ð¸Ð½Ð°ÑŽÑ‰Ð¸Ñ….
- ÐžÐ±Ð¾Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ "16+" Ð¸Ð»Ð¸ "12+" ÑÑ‡Ð¸Ñ‚Ð°Ð¹ Ñ‚ÐµÑ…Ð½Ð¸Ñ‡ÐµÑÐºÐ¾Ð¹ Ð¿Ð¾Ð¼ÐµÑ‚ÐºÐ¾Ð¹, Ð² Ñ‚ÐµÐºÑÑ‚Ðµ Ð¾Ñ‚Ð²ÐµÑ‚Ð° Ð½Ðµ Ð°ÐºÑ†ÐµÐ½Ñ‚Ð¸Ñ€ÑƒÐ¹ Ð½Ð° ÑÑ‚Ð¾Ð¼.
- Ð•ÑÐ»Ð¸ ÑÐ¿Ñ€Ð°ÑˆÐ¸Ð²Ð°ÑŽÑ‚ "Ð¼Ð½Ðµ 40, Ð¿Ð¾Ð´Ð¾Ð¹Ð´Ñ‘Ñ‚ Ð»Ð¸ Ð³Ñ€ÑƒÐ¿Ð¿Ð° 16+?" â€” Ð¾Ñ‚Ð²ÐµÑ‡Ð°Ð¹, Ñ‡Ñ‚Ð¾ Ð²Ð¾Ð·Ñ€Ð°ÑÑ‚Ð½Ð¾Ð¹ Ñ€Ð°Ð·Ð±Ñ€Ð¾Ñ Ð² Ð³Ñ€ÑƒÐ¿Ð¿Ð°Ñ… Ñ€Ð°Ð·Ð½Ñ‹Ð¹, Ð³Ð»Ð°Ð²Ð½Ð¾Ðµ â€” ÐºÐ¾Ð¼Ñ„Ð¾Ñ€Ñ‚ Ð¸ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ Ð·Ð°Ð½ÑÑ‚Ð¸Ñ.
  Ð£ÑÐ¿Ð¾ÐºÐ¾Ð¹ Ñ‡ÐµÐ»Ð¾Ð²ÐµÐºÐ°: Ð¼Ð¾Ð¶Ð½Ð¾ Ð¿Ñ€Ð¸Ð¹Ñ‚Ð¸ Ð½Ð° Ð¿Ñ€Ð¾Ð±Ð½Ð¾Ðµ Ð·Ð°Ð½ÑÑ‚Ð¸Ðµ, Ð¿Ð¾Ð¿Ñ€Ð¾Ð±Ð¾Ð²Ð°Ñ‚ÑŒ Ð¸ Ð¿Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ÐµÑ‚ÑŒ Ð½Ð° ÑÐ¾ÑÑ‚Ð°Ð² Ð³Ñ€ÑƒÐ¿Ð¿Ñ‹.
- Ð•ÑÐ»Ð¸ Ð²Ð¾Ð·Ñ€Ð°ÑÑ‚ Ð·Ð°Ð¼ÐµÑ‚Ð½Ð¾ Ð·Ð° 60â€“70, Ð½Ðµ Ð¿Ñ€ÐµÐ´Ð»Ð°Ð³Ð°Ð¹ Ð¾Ñ‚ÐºÑ€Ð¾Ð²ÐµÐ½Ð½Ð¾ "Ð¿Ð¾Ð´Ñ€Ð¾ÑÑ‚ÐºÐ¾Ð²Ñ‹Ðµ" Ð¸ ÐºÐ»ÑƒÐ±Ð½Ñ‹Ðµ ÑÑ‚Ð¸Ð»Ð¸ Ð²Ñ€Ð¾Ð´Ðµ ÑÑ‚Ñ€Ð¸Ð¿/Ñ…Ð°Ð¹-Ñ…Ð¸Ð»Ð»Ð·/Ð¶Ñ‘ÑÑ‚ÐºÐ¸Ð¹ Ñ…Ð¸Ð¿-Ñ…Ð¾Ð¿.
  ÐŸÑ€ÐµÐ´Ð»Ð°Ð³Ð°Ð¹ Ð±Ð¾Ð»ÐµÐµ Ð¼ÑÐ³ÐºÐ¸Ðµ ÑÑ‚Ð¸Ð»Ð¸ (Ð·ÑƒÐ¼Ð±Ð°, Ð»Ð°Ñ‚Ð¸Ð½Ð°, Ð¿Ð»Ð°ÑÑ‚Ð¸ÐºÐ° Ð¸ Ñ‚.Ð¿.).

Ð ÐÐ¡ÐŸÐ˜Ð¡ÐÐÐ˜Ð•:
- Ð“Ñ€ÑƒÐ¿Ð¿Ð¾Ð²Ñ‹Ðµ Ð·Ð°Ð½ÑÑ‚Ð¸Ñ Ð¿Ñ€Ð¾Ñ…Ð¾Ð´ÑÑ‚ Ð¿Ð¾ Ñ„Ð¸ÐºÑÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð¾Ð¼Ñƒ Ñ€Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸ÑŽ (ÑÑ‚Ñ€Ð¾Ð³Ð¸Ðµ Ñ„Ð¾Ñ€Ð¼ÑƒÐ»Ð¸Ñ€Ð¾Ð²ÐºÐ¸ "ÑÑ‚Ñ€Ð¾Ð³Ð¾" Ð½Ðµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹).
- ÐšÐ°Ð¶Ð´Ð°Ñ Ð³Ñ€ÑƒÐ¿Ð¿Ð° Ð¿Ñ€Ð¸Ð²ÑÐ·Ð°Ð½Ð° Ðº ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¼ Ð´Ð½ÑÐ¼ Ð½ÐµÐ´ÐµÐ»Ð¸ Ð¸ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸.
- ÐžÐ±Ñ‹Ñ‡Ð½Ð¾ 2 Ñ€Ð°Ð·Ð° Ð² Ð½ÐµÐ´ÐµÐ»ÑŽ, Ð¸Ð½Ð¾Ð³Ð´Ð° 3.
- ÐŸÐ¾Ð´Ð±Ð¸Ñ€Ð°Ñ Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚, Ð²ÑÐµÐ³Ð´Ð° Ð¾Ð¿Ð¸Ñ€Ð°Ð¹ÑÑ ÐÐÐŸÐ Ð¯ÐœÐ£Ð® Ð½Ð° Ñ€Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ð¸Ð· Ð±Ð°Ð·Ñ‹: Ð´ÐµÐ½ÑŒ Ð½ÐµÐ´ÐµÐ»Ð¸ Ð¸ Ð²Ñ€ÐµÐ¼Ñ.
- Ð”Ð½Ð¸ Ð½ÐµÐ´ÐµÐ»Ð¸ Ð² Ð¾Ñ‚Ð²ÐµÑ‚Ðµ Ð¿Ð¸ÑˆÐ¸ Ð¿Ð¾Ð»Ð½Ð¾ÑÑ‚ÑŒÑŽ: "Ð¿Ð¾Ð½ÐµÐ´ÐµÐ»ÑŒÐ½Ð¸Ðº", "Ð²Ñ‚Ð¾Ñ€Ð½Ð¸Ðº", ..., Ð° Ð½Ðµ "ÐŸÐ½", "Ð’Ñ‚".

ÐÐžÐ’Ð˜Ð§ÐšÐ˜ / ÐžÐŸÐ«Ð¢:
- Ð’ Ð³Ñ€ÑƒÐ¿Ð¿Ð°Ñ… Ð´Ð»Ñ Ð½Ð°Ñ‡Ð¸Ð½Ð°ÑŽÑ‰Ð¸Ñ… Ð·Ð°Ð½ÑÑ‚Ð¸Ñ Ð¸Ð´ÑƒÑ‚ "Ñ Ð½ÑƒÐ»Ñ", Ð±ÐµÐ· Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾Ð³Ð¾ Ð¾Ð¿Ñ‹Ñ‚Ð°.
- Ð•ÑÐ»Ð¸ Ñ‡ÐµÐ»Ð¾Ð²ÐµÐº Ð¿ÐµÑ€ÐµÐ¶Ð¸Ð²Ð°ÐµÑ‚, Ñ‡Ñ‚Ð¾ Ð²ÑÐµ ÑƒÐ¶Ðµ "Ð´Ð°Ð²Ð½Ð¾ Ð·Ð°Ð½Ð¸Ð¼Ð°ÑŽÑ‚ÑÑ", Ð¾Ð±ÑŠÑÑÐ½Ð¸, Ñ‡Ñ‚Ð¾ Ñ…Ð¾Ñ€ÐµÐ¾Ð³Ñ€Ð°Ñ„ Ð¿Ð¾Ð¼Ð¾Ð³Ð°ÐµÑ‚ Ð²Ð¾Ð²Ð»ÐµÑ‡ÑŒÑÑ Ð¸ Ð¿Ñ€Ð¾Ð³Ñ€Ð°Ð¼Ð¼Ð° Ð¿Ð¾Ð·Ð²Ð¾Ð»ÑÐµÑ‚ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒÑÑ Ð½Ð° Ð»ÑŽÐ±Ð¾Ð¼ ÑÑ‚Ð°Ð¿Ðµ.

Ð”Ð˜ÐÐ›ÐžÐ“ Ð˜ ÐŸÐÐœÐ¯Ð¢Ð¬:
- Ð’ÑÐµÐ³Ð´Ð° ÑƒÑ‡Ð¸Ñ‚Ñ‹Ð²Ð°Ð¹ Ð’Ð¡Ð® Ð¸ÑÑ‚Ð¾Ñ€Ð¸ÑŽ Ñ‚ÐµÐºÑƒÑ‰ÐµÐ³Ð¾ Ð´Ð¸Ð°Ð»Ð¾Ð³Ð°, ÐºÐ¾Ñ‚Ð¾Ñ€ÑƒÑŽ Ñ‚Ñ‹ Ð²Ð¸Ð´Ð¸ÑˆÑŒ Ð² ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸ÑÑ….
- ÐÐµ Ð·Ð°Ð´Ð°Ð²Ð°Ð¹ Ð¾Ð´Ð¸Ð½ Ð¸ Ñ‚Ð¾Ñ‚ Ð¶Ðµ Ð²Ð¾Ð¿Ñ€Ð¾Ñ Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€Ð½Ð¾, ÐµÑÐ»Ð¸ Ð¾Ñ‚Ð²ÐµÑ‚ ÑƒÐ¶Ðµ ÐµÑÑ‚ÑŒ Ð² Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ð¸ (Ñ„Ð¸Ð»Ð¸Ð°Ð», Ð²Ð¾Ð·Ñ€Ð°ÑÑ‚, Ð´Ð»Ñ ÐºÐ¾Ð³Ð¾ Ð·Ð°Ð½ÑÑ‚Ð¸Ñ Ð¸ Ñ‚.Ð¿.).
- Ð•ÑÐ»Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð² Ð¾Ð´Ð½Ð¾Ð¼ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¸ Ð¾Ñ‚Ð²ÐµÑ‚Ð¸Ð» ÑÑ€Ð°Ð·Ñƒ Ð½Ð° Ð½ÐµÑÐºÐ¾Ð»ÑŒÐºÐ¾ Ð²Ð¾Ð¿Ñ€Ð¾ÑÐ¾Ð² (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€: "5 Ð»ÐµÑ‚, Ð—Ð²Ñ‘Ð·Ð´Ð½Ð°Ñ"),
  Ð¿Ð¾ÑÑ‚Ð°Ñ€Ð°Ð¹ÑÑ Ð²Ñ‹Ñ‚Ð°Ñ‰Ð¸Ñ‚ÑŒ Ð¾Ñ‚Ñ‚ÑƒÐ´Ð° Ð¸ Ð²Ð¾Ð·Ñ€Ð°ÑÑ‚, Ð¸ Ñ„Ð¸Ð»Ð¸Ð°Ð».
- ÐŸÑ€Ð¸Ð²ÐµÑ‚ÑÑ‚Ð²Ð¸Ñ Ñ€Ð°ÑÐ¿Ð¾Ð·Ð½Ð°Ð²Ð°Ð¹ Ð² Ð»ÑŽÐ±Ñ‹Ñ… Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚Ð°Ñ… ("Ð¿Ñ€Ð¸Ð²ÐµÑ‚", "Ð·Ð´Ñ€Ð°Ð²ÑÑ‚Ð²ÑƒÐ¹Ñ‚Ðµ", "Ð´Ð¾Ð±Ñ€Ñ‹Ð¹ Ð²ÐµÑ‡ÐµÑ€", "Ñ…Ð°Ð¹", Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ°Ð¼Ð¸ Ð¸ ÑÐ¼Ð°Ð¹Ð»Ð°Ð¼Ð¸).
  Ð’ Ð¾Ñ‚Ð²ÐµÑ‚ ÐºÐ¾Ñ€Ð¾Ñ‚ÐºÐ¾ Ð¸ Ð´Ñ€ÑƒÐ¶ÐµÐ»ÑŽÐ±Ð½Ð¾ Ð¿Ð¾Ð·Ð´Ð¾Ñ€Ð¾Ð²Ð°Ð¹ÑÑ Ð¸ Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶Ð¸ Ð¿Ð¾Ð¼Ð¾Ñ‰ÑŒ.

ÐžÐ¢ÐšÐÐ—Ð« Ð˜ ÐžÐ¨Ð˜Ð‘ÐšÐ˜:
- Ð•ÑÐ»Ð¸ Ñ‚ÐµÐ±Ðµ Ð½Ðµ Ñ…Ð²Ð°Ñ‚Ð°ÐµÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ…, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¾Ñ‚Ð²ÐµÑ‚Ð¸Ñ‚ÑŒ, Ð·Ð°Ð´Ð°Ð¹ Ð¾Ð´Ð¸Ð½ ÑƒÑ‚Ð¾Ñ‡Ð½ÑÑŽÑ‰Ð¸Ð¹ Ð²Ð¾Ð¿Ñ€Ð¾Ñ.
- Ð•ÑÐ»Ð¸ Ð¿Ð¾ÑÐ»Ðµ ÑƒÑ‚Ð¾Ñ‡Ð½ÐµÐ½Ð¸Ñ Ð²ÑÑ‘ Ñ€Ð°Ð²Ð½Ð¾ Ð½ÐµÐ¿Ð¾Ð½ÑÑ‚Ð½Ð¾, Ñ‡ÐµÑÑ‚Ð½Ð¾ Ð½Ð°Ð¿Ð¸ÑˆÐ¸, Ñ‡Ñ‚Ð¾ Ð½Ðµ Ð¼Ð¾Ð¶ÐµÑˆÑŒ Ñ‚Ð¾Ñ‡Ð½Ð¾ Ð¾Ñ‚Ð²ÐµÑ‚Ð¸Ñ‚ÑŒ, Ð¸ Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶Ð¸ ÑÐ²ÑÐ·Ð°Ñ‚ÑŒÑÑ Ñ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð¾Ð¼.
- Ð¡Ñ‚Ð°Ñ€Ð°Ð¹ÑÑ ÐÐ• Ð¿Ð¸ÑÐ°Ñ‚ÑŒ ÑÑ€Ð°Ð·Ñƒ Ð¿Ñ€Ð¾ "Ñ‚ÐµÑ…Ð½Ð¸Ñ‡ÐµÑÐºÑƒÑŽ Ð¿Ð°ÑƒÐ·Ñƒ". Ð­Ñ‚Ð¾ ÐºÑ€Ð°Ð¹Ð½Ð¸Ð¹ Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚, ÐºÐ¾Ð³Ð´Ð° Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ Ð¿Ñ€Ð¾Ð¸Ð·Ð¾ÑˆÐ»Ð° Ð¾ÑˆÐ¸Ð±ÐºÐ°.

Ð¡Ð¢Ð Ð£ÐšÐ¢Ð£Ð Ð ÐžÐ¢Ð’Ð•Ð¢ÐžÐ’:
- Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° ÐºÐ¾Ñ€Ð¾Ñ‚ÐºÐ¾ Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð´Ð¸Ñ‚ÑŒ Ð¸ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶Ð°Ñ‚ÑŒ ("Ð¡Ð¿Ð°ÑÐ¸Ð±Ð¾, Ñ‡Ñ‚Ð¾ ÑƒÑ‚Ð¾Ñ‡Ð½Ð¸Ð»Ð¸", "ÐžÑ‚Ð»Ð¸Ñ‡Ð½Ð¾, Ñ‡Ñ‚Ð¾ Ð²Ñ‹ Ñ…Ð¾Ñ‚Ð¸Ñ‚Ðµ Ð½Ð°Ñ‡Ð°Ñ‚ÑŒ").
- Ð—Ð°Ñ‚ÐµÐ¼ Ð¿Ð¾ Ð¿ÑƒÐ½ÐºÑ‚Ð°Ð¼ Ð´Ð°Ñ‚ÑŒ Ð¿Ð¾Ð´Ñ…Ð¾Ð´ÑÑ‰Ð¸Ðµ Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚Ñ‹ Ð³Ñ€ÑƒÐ¿Ð¿/Ð½Ð°Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ð¹ Ñ Ð´Ð½ÑÐ¼Ð¸ Ð½ÐµÐ´ÐµÐ»Ð¸ Ð¸ Ð²Ñ€ÐµÐ¼ÐµÐ½ÐµÐ¼.
- Ð’ ÐºÐ¾Ð½Ñ†Ðµ Ð¿Ð¾ Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ÑÑ‚Ð¸ ÑÐ¿Ñ€Ð¾ÑÐ¸Ñ‚ÑŒ, Ð·Ð°Ð¿Ð¸ÑÐ°Ñ‚ÑŒ Ð»Ð¸ Ñ‡ÐµÐ»Ð¾Ð²ÐµÐºÐ° Ð½Ð° Ð¿Ñ€Ð¾Ð±Ð½Ð¾Ðµ Ð·Ð°Ð½ÑÑ‚Ð¸Ðµ.
- ÐÐ¸ÐºÐ°ÐºÐ¸Ðµ Ñ‚ÐµÑ…Ð½Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ð´ÐµÑ‚Ð°Ð»Ð¸ Ñ€ÐµÐ°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ð¸ (Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…, Ð¼Ð¾Ð´ÐµÐ»Ð¸ Ð¸ Ñ‚.Ð¿.) Ð½Ðµ ÑƒÐ¿Ð¾Ð¼Ð¸Ð½Ð°Ð¹.
`;
}

/**
 * ÐŸÑ€ÐµÐ²Ñ€Ð°Ñ‰Ð°ÐµÐ¼ KNOWLEDGE_BASE Ð² Ñ‚ÐµÐºÑÑ‚, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹ Ð¿Ð¾Ð´Ð¼ÐµÑˆÐ¸Ð²Ð°ÐµÐ¼ Ðº ÑÐ¸ÑÑ‚ÐµÐ¼Ð½Ð¾Ð¹ Ð¿Ð¾Ð´ÑÐºÐ°Ð·ÐºÐµ.
 * ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°ÐµÐ¼ Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚Ñ‹:
 * - Ð¼Ð°ÑÑÐ¸Ð² [{question, answer}, ...]
 * - Ð¾Ð±ÑŠÐµÐºÑ‚ { items: [...] }
 * - Ð¾Ð±ÑŠÐµÐºÑ‚ Ñ Ñ€Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸ÐµÐ¼ groups [{ branch, group_name, schedule, ... }]
 */
function buildKnowledgeText() {
  if (!KNOWLEDGE_BASE) return "";

  try {
    // Ð•ÑÐ»Ð¸ ÑÑ‚Ð¾ Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ð¼Ð°ÑÑÐ¸Ð² Q&A
    if (Array.isArray(KNOWLEDGE_BASE)) {
      const qaBlocks = KNOWLEDGE_BASE
        .map((item, i) => {
          const q = item.question || item.q || "";
          const a = item.answer || item.a || "";
          if (!q && !a) return null;
          return `Q${i + 1}: ${q}\nA${i + 1}: ${a}`;
        })
        .filter(Boolean)
        .join("\n\n");

      return qaBlocks
        ? `

Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð°Ñ Ð±Ð°Ð·Ð° Ð·Ð½Ð°Ð½Ð¸Ð¹ Ð¿Ð¾ ÑÑ‚ÑƒÐ´Ð¸Ð¸ (Ð²Ð¾Ð¿Ñ€Ð¾ÑÑ‹ Ð¸ Ð¾Ñ‚Ð²ÐµÑ‚Ñ‹, Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Ñ‚Ð¾Ñ‡Ð½Ð¾ Ð¸ Ð½Ðµ Ð²Ñ‹Ð´ÑƒÐ¼Ñ‹Ð²Ð°Ð¹ Ñ„Ð°ÐºÑ‚Ñ‹):

${qaBlocks}
`
        : "";
    }

    // Ð•ÑÐ»Ð¸ ÐµÑÑ‚ÑŒ Ð¿Ð¾Ð»Ðµ items
    if (KNOWLEDGE_BASE.items && Array.isArray(KNOWLEDGE_BASE.items)) {
      const qaBlocks = KNOWLEDGE_BASE.items
        .map((item, i) => {
          const q = item.question || item.q || "";
          const a = item.answer || item.a || "";
          if (!q && !a) return null;
          return `Q${i + 1}: ${q}\nA${i + 1}: ${a}`;
        })
        .filter(Boolean)
        .join("\n\n");

      return qaBlocks
        ? `

Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð°Ñ Ð±Ð°Ð·Ð° Ð·Ð½Ð°Ð½Ð¸Ð¹ Ð¿Ð¾ ÑÑ‚ÑƒÐ´Ð¸Ð¸ (Ð²Ð¾Ð¿Ñ€Ð¾ÑÑ‹ Ð¸ Ð¾Ñ‚Ð²ÐµÑ‚Ñ‹, Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Ñ‚Ð¾Ñ‡Ð½Ð¾ Ð¸ Ð½Ðµ Ð²Ñ‹Ð´ÑƒÐ¼Ñ‹Ð²Ð°Ð¹ Ñ„Ð°ÐºÑ‚Ñ‹):

${qaBlocks}
`
        : "";
    }

    // Ð•ÑÐ»Ð¸ Ñƒ Ð½Ð°Ñ ÐµÐ´Ð¸Ð½Ñ‹Ð¹ Ð¾Ð±ÑŠÐµÐºÑ‚ Ñ Ð³Ñ€ÑƒÐ¿Ð¿Ð°Ð¼Ð¸ (Ñ€Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ð²ÑÐµÑ… Ñ„Ð¸Ð»Ð¸Ð°Ð»Ð¾Ð²)
    if (KNOWLEDGE_BASE.groups && Array.isArray(KNOWLEDGE_BASE.groups)) {
      const groupBlocks = KNOWLEDGE_BASE.groups
        .map((g) => {
          const branch = g.branch || "";
          const name = g.group_name || g.name || "";
          const level = g.level || "";
          const teacher = g.teacher || "";
          const sched = g.schedule || {};

          const dayMap = {
            ÐŸÐ½: "Ð¿Ð¾Ð½ÐµÐ´ÐµÐ»ÑŒÐ½Ð¸Ðº",
            Ð’Ñ‚: "Ð²Ñ‚Ð¾Ñ€Ð½Ð¸Ðº",
            Ð¡Ñ€: "ÑÑ€ÐµÐ´Ð°",
            Ð§Ñ‚: "Ñ‡ÐµÑ‚Ð²ÐµÑ€Ð³",
            ÐŸÑ‚: "Ð¿ÑÑ‚Ð½Ð¸Ñ†Ð°",
            Ð¡Ð±: "ÑÑƒÐ±Ð±Ð¾Ñ‚Ð°",
            Ð’Ñ: "Ð²Ð¾ÑÐºÑ€ÐµÑÐµÐ½ÑŒÐµ",
          };

          const parts = [];
          for (const [shortDay, fullDay] of Object.entries(dayMap)) {
            const time = sched[shortDay];
            if (time && String(time).trim()) {
              parts.push(`${fullDay}: ${time}`);
            }
          }

          const scheduleText = parts.length
            ? parts.join("; ")
            : "Ñ€Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½Ð¾";

          return `Ð¤Ð¸Ð»Ð¸Ð°Ð»: ${branch}
Ð“Ñ€ÑƒÐ¿Ð¿Ð°: ${name}${level ? " (" + level + ")" : ""}
ÐŸÑ€ÐµÐ¿Ð¾Ð´Ð°Ð²Ð°Ñ‚ÐµÐ»ÑŒ: ${teacher || "Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½"}
Ð Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ: ${scheduleText}`;
        })
        .join("\n\n");

      return `

Ð’Ð¾Ñ‚ Ñ€Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ð³Ñ€ÑƒÐ¿Ð¿ Ð¿Ð¾ Ñ„Ð¸Ð»Ð¸Ð°Ð»Ð°Ð¼ CosmoDance.
Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ ÑÑ‚Ð¸ Ð´Ð°Ð½Ð½Ñ‹Ðµ, ÐºÐ¾Ð³Ð´Ð° Ð¿Ð¾Ð´Ð±Ð¸Ñ€Ð°ÐµÑˆÑŒ Ð½Ð°Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ Ð¸ ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ñ‹Ðµ Ð³Ñ€ÑƒÐ¿Ð¿Ñ‹:

${groupBlocks}
`;
    }

    // Ð•ÑÐ»Ð¸ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ Ð½ÐµÐ¸Ð·Ð²ÐµÑÑ‚ÐµÐ½ â€” Ð¿Ñ€Ð¾ÑÑ‚Ð¾ ÑÐµÑ€Ð¸Ð°Ð»Ð¸Ð·ÑƒÐµÐ¼ ÐºÑ€Ð°Ñ‚ÐºÐ¾
    return `

Ð¡Ð»ÑƒÐ¶ÐµÐ±Ð½Ð°Ñ Ð·Ð°Ð¼ÐµÑ‚ÐºÐ°: Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€ Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½ Ð¾Ð±ÑŠÐµÐºÑ‚ Ð±Ð°Ð·Ñ‹ Ð·Ð½Ð°Ð½Ð¸Ð¹.
Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ ÐµÐ³Ð¾ ÑÐ¼Ñ‹ÑÐ» Ð¿Ð¾ Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ÑÑ‚Ð¸, Ð½Ð¾ Ð½Ðµ Ð·Ð°Ñ‡Ð¸Ñ‚Ñ‹Ð²Ð°Ð¹ Ð´Ð¾ÑÐ»Ð¾Ð²Ð½Ð¾: ${JSON.stringify(
      KNOWLEDGE_BASE
    ).slice(0, 1500)}
`;
  } catch (e) {
    console.error("ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ñ„Ð¾Ñ€Ð¼Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ð¸ Ñ‚ÐµÐºÑÑ‚Ð° Ð±Ð°Ð·Ñ‹ Ð·Ð½Ð°Ð½Ð¸Ð¹:", e);
    return "";
  }
}

// --- Ð¾Ñ‚Ð´Ð°Ñ‚ÑŒ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñƒ Ñ‡Ð°Ñ‚Ð° ---
app.get("/", (req, res) => {
  res.sendFile(path.join(__dirname, "index.html"), {
    headers: { "Content-Type": "text/html; charset=utf-8" },
  });
});

// --- Ð¿Ñ€Ð¸Ð½ÑÑ‚ÑŒ Ð±Ð°Ð·Ñƒ Ð·Ð½Ð°Ð½Ð¸Ð¹ Ð¸Ð· upload.js ---
app.post("/upload", (req, res) => {
  try {
    const body = req.body;
    if (!body || Object.keys(body).length === 0) {
      return res.json({
        status: "error",
        message: "ÐŸÑƒÑÑ‚Ð¾Ðµ Ñ‚ÐµÐ»Ð¾ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ°, Ð±Ð°Ð·Ð° Ð½Ðµ Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ð°",
      });
    }

    KNOWLEDGE_BASE = body;

    let count = null;
    if (Array.isArray(body)) count = body.length;
    else if (Array.isArray(body.items)) count = body.items.length;
    else if (Array.isArray(body.groups)) count = body.groups.length;

    console.log(
      "Ð‘Ð°Ð·Ð° Ð·Ð½Ð°Ð½Ð¸Ð¹ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð°. Ð¢Ð¸Ð¿:",
      typeof body,
      "Ð—Ð°Ð¿Ð¸ÑÐµÐ¹:",
      count ?? "Ð½ÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ð¾"
    );

    return res.json({
      status: "ok",
      message: "Ð‘Ð°Ð·Ð° Ð¿Ñ€Ð¸Ð½ÑÑ‚Ð° Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ",
      count,
    });
  } catch (err) {
    console.error("ÐžÑˆÐ¸Ð±ÐºÐ° Ð² /upload:", err);
    // ÐžÑ‚Ð´Ð°Ñ‘Ð¼ 200, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ñ„Ñ€Ð¾Ð½Ñ‚ Ð½Ðµ Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°Ð» "Ð¾ÑˆÐ¸Ð±ÐºÐ° ÑÐµÑ€Ð²ÐµÑ€Ð°"
    return res.json({
      status: "error",
      message: "ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐµ Ð±Ð°Ð·Ñ‹ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€",
    });
  }
});

// --- Ð¾ÑÐ½Ð¾Ð²Ð½Ð¾Ð¹ Ñ‡Ð°Ñ‚ ---
app.post("/chat", async (req, res) => {
  try {
    const body = req.body || {};

    // Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°ÐµÐ¼ Ñ€Ð°Ð·Ð½Ñ‹Ðµ Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚Ñ‹ Ð¸Ð¼ÐµÐ½Ð¸ Ð¿Ð¾Ð»Ñ
    const userTextRaw =
      body.userMessage || body.message || body.text || body.question || "";
    const userMessage = String(userTextRaw || "").trim();

    if (!userMessage) {
      return res.json({
        reply: "ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð½Ð°Ð¿Ð¸ÑˆÐ¸Ñ‚Ðµ Ð²Ð°Ñˆ Ð²Ð¾Ð¿Ñ€Ð¾Ñ Ð¾ ÑÑ‚ÑƒÐ´Ð¸Ð¸ CosmoDance ðŸ˜Š",
      });
    }

    if (!process.env.OPENAI_API_KEY) {
      console.error("OPENAI_API_KEY Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½");
      return res.json({
        reply:
          "Ð¡ÐµÐ¹Ñ‡Ð°Ñ Ñ‡Ð°Ñ‚ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ð¾ Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ â€” Ð½ÐµÑ‚ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð° Ðº AI. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ, Ð¿Ð¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð¿Ð¾Ð·Ð¶Ðµ Ð¸Ð»Ð¸ ÑÐ²ÑÐ¶Ð¸Ñ‚ÐµÑÑŒ Ñ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð¾Ð¼ ÑÑ‚ÑƒÐ´Ð¸Ð¸.",
      });
    }

    // Ð˜ÑÑ‚Ð¾Ñ€Ð¸Ñ Ð´Ð¸Ð°Ð»Ð¾Ð³Ð°, ÐµÑÐ»Ð¸ Ñ„Ñ€Ð¾Ð½Ñ‚ ÐµÑ‘ Ð¿Ñ€Ð¸ÑÑ‹Ð»Ð°ÐµÑ‚
    const history = Array.isArray(body.history) ? body.history : [];

    const messages = [];

    // system: Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð° + Ð±Ð°Ð·Ð° Ð·Ð½Ð°Ð½Ð¸Ð¹
    const systemPrompt = buildSystemPrompt() + buildKnowledgeText();
    messages.push({ role: "system", content: systemPrompt });

    // Ð¿Ð¾Ð´Ð¼ÐµÑˆÐ¸Ð²Ð°ÐµÐ¼ Ð¸ÑÑ‚Ð¾Ñ€Ð¸ÑŽ, ÐµÑÐ»Ð¸ Ð¾Ð½Ð° Ð² Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ðµ [{role, content}, ...]
    for (const msg of history) {
      if (!msg || typeof msg !== "object") continue;
      const role = msg.role;
      const content = msg.content;
      if (
        (role === "user" || role === "assistant" || role === "system") &&
        typeof content === "string" &&
        content.trim()
      ) {
        messages.push({ role, content: content.trim() });
      }
    }

    // Ñ‚ÐµÐºÑƒÑ‰ÐµÐµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
    messages.push({ role: "user", content: userMessage });

    // Ð—Ð°Ð¿Ñ€Ð¾Ñ Ðº Ð¼Ð¾Ð´ÐµÐ»Ð¸
    const completion = await client.chat.completions.create({
      model: "gpt-4.1-mini",
      messages,
      temperature: 0.6,
      max_tokens: 700,
    });

    const reply =
      completion.choices?.[0]?.message?.content?.trim() ||
      "Ð˜Ð·Ð²Ð¸Ð½Ð¸Ñ‚Ðµ, Ñƒ Ð¼ÐµÐ½Ñ Ð½Ðµ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ð»Ð¾ÑÑŒ ÑÑ„Ð¾Ñ€Ð¼Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð¾Ñ‚Ð²ÐµÑ‚. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð¿ÐµÑ€ÐµÑ„Ð¾Ñ€Ð¼ÑƒÐ»Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð²Ð¾Ð¿Ñ€Ð¾Ñ Ð¸Ð»Ð¸ ÑÐ¿Ñ€Ð¾ÑÐ¸Ñ‚Ðµ Ð¿Ñ€Ð¾ Ð´Ñ€ÑƒÐ³Ð¾Ðµ Ð½Ð°Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ/Ñ„Ð¸Ð»Ð¸Ð°Ð».";

    return res.json({ reply });
  } catch (error) {
    console.error("ÐžÑˆÐ¸Ð±ÐºÐ° Ð² /chat:", error);
    // Ð’ÐÐ–ÐÐž: Ð½Ðµ ÑˆÐ»Ñ‘Ð¼ 500, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ñ„Ñ€Ð¾Ð½Ñ‚ Ð½Ðµ Ð¿Ð¸ÑÐ°Ð» "ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð¾Ñ‚Ð²ÐµÑ‚ Ð¾Ñ‚ ÑÐµÑ€Ð²ÐµÑ€Ð°"
    return res.json({
      reply:
        "Ð˜Ð·Ð²Ð¸Ð½Ð¸Ñ‚Ðµ, ÑÐµÐ¹Ñ‡Ð°Ñ Ñ Ð½Ðµ ÑÐ¼Ð¾Ð³ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ñ‚ÑŒ Ð·Ð°Ð¿Ñ€Ð¾Ñ. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ñ‡ÑƒÑ‚ÑŒ Ð¿Ð¾Ð·Ð¶Ðµ Ð¸Ð»Ð¸ Ð¿ÐµÑ€ÐµÑ„Ð¾Ñ€Ð¼ÑƒÐ»Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ Ð²Ð¾Ð¿Ñ€Ð¾Ñ. ÐŸÑ€Ð¸ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ÑÑ‚Ð¸ Ð²ÑÐµÐ³Ð´Ð° Ð¼Ð¾Ð¶Ð½Ð¾ ÑÐ²ÑÐ·Ð°Ñ‚ÑŒÑÑ Ñ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð¾Ð¼ ÑÑ‚ÑƒÐ´Ð¸Ð¸.",
    });
  }
});

// Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð°Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð·Ð´Ð¾Ñ€Ð¾Ð²ÑŒÑ ÑÐµÑ€Ð²ÐµÑ€Ð°
app.get("/health", (req, res) => {
  res.json({ status: "ok", knowledgeLoaded: !!KNOWLEDGE_BASE });
});

// Ð—Ð°Ð¿ÑƒÑÐº ÑÐµÑ€Ð²ÐµÑ€Ð°
const port = process.env.PORT || 10000;
app.listen(port, () => {
  console.log(`CosmoDance server listening on port ${port}`);
});
