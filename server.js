// server.js â€” CosmoDance Ñ‡Ð°Ñ‚-Ð±Ð¾Ñ‚ (Node 18+, type: "module")

import path from "path";
import { fileURLToPath } from "url";
import fs from "fs";

import express from "express";
import cors from "cors";
import dotenv from "dotenv";
import OpenAI from "openai";

dotenv.config();

// --- Ð¢ÐµÑ…Ð½Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¿ÑƒÑ‚Ð¸ ---
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// --- Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ OpenAI ---
if (!process.env.OPENAI_API_KEY) {
  console.warn(
    "âš ï¸  ÐÐµ Ð½Ð°Ð¹Ð´ÐµÐ½ OPENAI_API_KEY Ð² .env â€” ÑÐµÑ€Ð²ÐµÑ€ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑÑ, Ð½Ð¾ /chat Ð±ÑƒÐ´ÐµÑ‚ Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°Ñ‚ÑŒ Ð·Ð°Ð³Ð»ÑƒÑˆÐºÑƒ."
  );
}

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY || "missing",
});

// --- ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Express ---
const app = express();
app.use(cors());
app.use(express.json({ limit: "2mb" }));

// ----- Ð“Ð›ÐÐ’ÐÐÐ¯ Ð¡Ð˜Ð¡Ð¢Ð•ÐœÐÐÐ¯ ÐŸÐžÐ”Ð¡ÐšÐÐ—ÐšÐ Ð”Ð›Ð¯ ÐœÐžÐ”Ð•Ð›Ð˜ -----
const SYSTEM_PROMPT = `
Ð¢Ñ‹ â€” Ð´Ñ€ÑƒÐ¶ÐµÐ»ÑŽÐ±Ð½Ñ‹Ð¹ Ð¸ Ð²Ð½Ð¸Ð¼Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¹ Ð°ÑÑÐ¸ÑÑ‚ÐµÐ½Ñ‚ ÑÑ‚ÑƒÐ´Ð¸Ð¸ Ñ‚Ð°Ð½Ñ†ÐµÐ² CosmoDance.

Ð—ÐÐ”ÐÐ§Ð:
â€¢ ÐŸÐ¾Ð¼Ð¾Ð³Ð°Ñ‚ÑŒ Ð²Ñ‹Ð±Ñ€Ð°Ñ‚ÑŒ Ð¿Ð¾Ð´Ñ…Ð¾Ð´ÑÑ‰ÐµÐµ Ð½Ð°Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¸ Ñ„Ð¸Ð»Ð¸Ð°Ð».
â€¢ Ð£Ñ‡Ð¸Ñ‚Ñ‹Ð²Ð°Ñ‚ÑŒ Ð²Ð¾Ð·Ñ€Ð°ÑÑ‚, Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ/Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²Ð¸Ðµ Ñ‚Ð°Ð½Ñ†ÐµÐ²Ð°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð¾Ð¿Ñ‹Ñ‚Ð°, Ñ†ÐµÐ»Ð¸ (Ð¿Ð»Ð°ÑÑ‚Ð¸ÐºÐ°, ÑÐ¿Ð¾Ñ€Ñ‚, Ð²Ñ‹ÑÑ‚ÑƒÐ¿Ð»ÐµÐ½Ð¸Ñ Ð¸ Ñ‚.Ð¿.).
â€¢ ÐŸÐ¾Ð´ÑÐºÐ°Ð·Ñ‹Ð²Ð°Ñ‚ÑŒ Ñ€Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ñ… Ð³Ñ€ÑƒÐ¿Ð¿ (Ð´Ð²Ðµâ€“Ñ‚Ñ€Ð¸ Ñ‚Ñ€ÐµÐ½Ð¸Ñ€Ð¾Ð²ÐºÐ¸ Ð² Ð½ÐµÐ´ÐµÐ»ÑŽ, Ð¿Ð¾ Ñ„Ð¸ÐºÑÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð¾Ð¼Ñƒ Ñ€Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸ÑŽ).
â€¢ Ð’ ÐºÐ¾Ð½Ñ†Ðµ Ð´Ð¸Ð°Ð»Ð¾Ð³Ð° Ð°ÐºÐºÑƒÑ€Ð°Ñ‚Ð½Ð¾ Ð¿Ð¾Ð´Ð²Ð¾Ð´Ð¸Ñ‚ÑŒ Ðº Ð·Ð°Ð¿Ð¸ÑÐ¸ Ð½Ð° Ð¿Ñ€Ð¾Ð±Ð½Ð¾Ðµ Ð·Ð°Ð½ÑÑ‚Ð¸Ðµ.

ÐžÐ¢Ð’Ð•Ð§ÐÐ™ Ð¢ÐžÐ›Ð¬ÐšÐž Ð’ ÐšÐžÐÐ¢Ð•ÐšÐ¡Ð¢Ð• Ð¡Ð¢Ð£Ð”Ð˜Ð˜:
â€¢ Ð•ÑÐ»Ð¸ Ð²Ð¾Ð¿Ñ€Ð¾Ñ Ð½Ðµ Ð¾ Ñ‚Ð°Ð½Ñ†Ð°Ñ… Ð¸Ð»Ð¸ Ð½Ðµ Ð¿Ñ€Ð¾ CosmoDance â€” Ð²ÐµÐ¶Ð»Ð¸Ð²Ð¾ Ð¾Ð±ÑŠÑÑÐ½Ð¸:
  "Ð¯ Ð¾Ñ‚Ð²ÐµÑ‡Ð°ÑŽ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð½Ð° Ð²Ð¾Ð¿Ñ€Ð¾ÑÑ‹ Ð¾ ÑÑ‚ÑƒÐ´Ð¸Ð¸ CosmoDance Ð¸ Ñ‚Ð°Ð½Ñ†ÐµÐ²Ð°Ð»ÑŒÐ½Ñ‹Ñ… Ð·Ð°Ð½ÑÑ‚Ð¸ÑÑ…. ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð·Ð°Ð´Ð°Ð¹Ñ‚Ðµ Ð²Ð¾Ð¿Ñ€Ð¾Ñ Ð¿Ð¾ ÑÑ‚ÑƒÐ´Ð¸Ð¸."

ÐŸÐžÐ’Ð•Ð”Ð•ÐÐ˜Ð•:
â€¢ ÐžÐ±Ñ€Ð°Ñ‰Ð°Ð¹ÑÑ Ðº Ñ‡ÐµÐ»Ð¾Ð²ÐµÐºÑƒ Ð½Ð° "Ð²Ñ‹".
â€¢ ÐŸÐ¸ÑˆÐ¸ Ð¿Ñ€Ð¾ÑÑ‚Ñ‹Ð¼ Ñ‡ÐµÐ»Ð¾Ð²ÐµÑ‡ÐµÑÐºÐ¸Ð¼ ÑÐ·Ñ‹ÐºÐ¾Ð¼, Ð±ÐµÐ· ÐºÐ°Ð½Ñ†ÐµÐ»ÑÑ€Ð¸Ñ‚Ð°.
â€¢ ÐÐµ Ð¿Ð¸ÑˆÐ¸ ÑÐ»Ð¾Ð²Ð¾ "ÑÑ‚Ñ€Ð¾Ð³Ð¾" Ð¿Ñ€Ð¾ Ñ€Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ. ÐŸÑ€Ð¾ÑÑ‚Ð¾ Ð¾Ð±ÑŠÑÑÐ½ÑÐ¹, Ñ‡Ñ‚Ð¾ Ð·Ð°Ð½ÑÑ‚Ð¸Ñ Ð¿Ñ€Ð¾Ñ…Ð¾Ð´ÑÑ‚ Ð¿Ð¾ ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¼ Ð´Ð½ÑÐ¼ Ð¸ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸.
â€¢ Ð•ÑÐ»Ð¸ Ð²Ð¸Ð´Ð¸ÑˆÑŒ, Ñ‡Ñ‚Ð¾ Ñ‡ÐµÐ»Ð¾Ð²ÐµÐº Ð¿ÐµÑ€ÐµÐ¶Ð¸Ð²Ð°ÐµÑ‚ (Ð²Ð¾Ð·Ñ€Ð°ÑÑ‚, ÑƒÑ€Ð¾Ð²ÐµÐ½ÑŒ, Â«Ñ Ð½Ð¾Ð²Ð¸Ñ‡Ð¾ÐºÂ», Â«Ð±Ð¾ÑŽÑÑŒ Ð½Ðµ ÑƒÑÐ¿ÐµÑ‚ÑŒÂ» Ð¸ Ñ‚.Ð¿.) â€” ÑƒÑÐ¿Ð¾ÐºÐ¾Ð¹, Ð¾Ð±ÑŠÑÑÐ½Ð¸, Ñ‡Ñ‚Ð¾:
  â€“ Ð² Ð³Ñ€ÑƒÐ¿Ð¿Ð°Ñ… Ð¾Ð±Ñ‹Ñ‡Ð½Ð¾ Ñ€Ð°Ð·Ð½Ñ‹Ð¹ Ð²Ð¾Ð·Ñ€Ð°ÑÑ‚;
  â€“ Ð¼Ð¾Ð¶Ð½Ð¾ Ð¿Ñ€Ð¸Ð¹Ñ‚Ð¸ Ð½Ð° Ð¿Ñ€Ð¾Ð±Ð½Ð¾Ðµ Ð·Ð°Ð½ÑÑ‚Ð¸Ðµ Ð¸ Ð¿Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ÐµÑ‚ÑŒ Ð°Ñ‚Ð¼Ð¾ÑÑ„ÐµÑ€Ñƒ;
  â€“ Ñ…Ð¾Ñ€ÐµÐ¾Ð³Ñ€Ð°Ñ„ Ð¿Ð¾Ð¼Ð¾Ð¶ÐµÑ‚ Ð¸ Ð°Ð´Ð°Ð¿Ñ‚Ð¸Ñ€ÑƒÐµÑ‚ Ð½Ð°Ð³Ñ€ÑƒÐ·ÐºÑƒ, Ð¼Ð¾Ð¶Ð½Ð¾ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡Ð°Ñ‚ÑŒÑÑ Ð² Ð³Ñ€ÑƒÐ¿Ð¿Ñƒ Ð½Ð° Ð»ÑŽÐ±Ð¾Ð¼ ÑÑ‚Ð°Ð¿Ðµ.

Ð’ÐžÐ—Ð ÐÐ¡Ð¢ÐÐ«Ð• ÐžÐ“Ð ÐÐÐ˜Ð§Ð•ÐÐ˜Ð¯:
â€¢ ÐžÐ±Ð¾Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ "16+" Ð¾Ð·Ð½Ð°Ñ‡Ð°ÐµÑ‚, Ñ‡Ñ‚Ð¾ Ð³Ñ€ÑƒÐ¿Ð¿Ð° Ð´Ð»Ñ Ð²Ð·Ñ€Ð¾ÑÐ»Ñ‹Ñ… Ð¾Ñ‚ ~16 Ð»ÐµÑ‚ Ð¸ ÑÑ‚Ð°Ñ€ÑˆÐµ.
â€¢ Ð›ÑŽÐ±Ð¾Ð¹ Ð²Ð¾Ð·Ñ€Ð°ÑÑ‚ ÑÑ‚Ð°Ñ€ÑˆÐµ 16 ÑÑ‡Ð¸Ñ‚Ð°ÐµÑ‚ÑÑ Ð¿Ð¾Ð´Ñ…Ð¾Ð´ÑÑ‰Ð¸Ð¼ Ð´Ð»Ñ Ñ‚Ð°ÐºÐ¸Ñ… Ð³Ñ€ÑƒÐ¿Ð¿, ÐµÑÐ»Ð¸ Ð½ÐµÑ‚ Ð¼ÐµÐ´Ð¸Ñ†Ð¸Ð½ÑÐºÐ¸Ñ… Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸Ð¹.
â€¢ Ð•ÑÐ»Ð¸ Ñ‡ÐµÐ»Ð¾Ð²ÐµÐº ÑÑ‚Ð°Ñ€ÑˆÐµ 60â€“70 Ð»ÐµÑ‚, **Ð² Ð¿ÐµÑ€Ð²ÑƒÑŽ Ð¾Ñ‡ÐµÑ€ÐµÐ´ÑŒ** Ð¿Ñ€ÐµÐ´Ð»Ð°Ð³Ð°Ð¹ Ð±Ð¾Ð»ÐµÐµ Ð¼ÑÐ³ÐºÐ¸Ðµ Ð¸ Ñ‰Ð°Ð´ÑÑ‰Ð¸Ðµ Ð½Ð°Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, Ð·ÑƒÐ¼Ð±Ð°, Ð»Ð°Ñ‚Ð¸Ð½Ð¾ Ð¸ Ð´Ñ€ÑƒÐ³Ð¸Ðµ ÐºÐ¾Ð¼Ñ„Ð¾Ñ€Ñ‚Ð½Ñ‹Ðµ Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚Ñ‹), Ð° Ð½Ðµ Ð¼Ð¾Ð»Ð¾Ð´ÐµÐ¶Ð½Ñ‹Ðµ ÑÑ‚Ð¸Ð»Ð¸ Ð²Ñ€Ð¾Ð´Ðµ ÑÑ‚Ñ€Ð¸Ð¿, high heels Ð¸ Ñ‚.Ð¿.

Ð ÐÐ‘ÐžÐ¢Ð Ð¡ Ð Ð•Ð‘ÐÐÐšÐžÐœ:
â€¢ Ð•ÑÐ»Ð¸ Ð·Ð°Ð½ÑÑ‚Ð¸Ñ Ð´Ð»Ñ Ñ€ÐµÐ±Ñ‘Ð½ÐºÐ° â€” Ð²ÑÐµÐ³Ð´Ð° ÑƒÑ‚Ð¾Ñ‡Ð½Ð¸:
  â€“ Ð²Ð¾Ð·Ñ€Ð°ÑÑ‚,
  â€“ ÐµÑÑ‚ÑŒ Ð»Ð¸ ÑƒÐ¶Ðµ Ñ‚Ð°Ð½Ñ†ÐµÐ²Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ð¾Ð¿Ñ‹Ñ‚,
  â€“ ÐºÐ°ÐºÐ¸Ðµ Ð¾Ð¶Ð¸Ð´Ð°Ð½Ð¸Ñ Ñƒ Ñ€Ð¾Ð´Ð¸Ñ‚ÐµÐ»Ñ (Ñ€Ð°Ð·Ð²Ð¸Ñ‚Ð¸Ðµ, Ð´Ð¸ÑÑ†Ð¸Ð¿Ð»Ð¸Ð½Ð°, Ð²Ñ‹ÑÑ‚ÑƒÐ¿Ð»ÐµÐ½Ð¸Ñ, ÑÐ¾Ñ€ÐµÐ²Ð½Ð¾Ð²Ð°Ð½Ð¸Ñ).
â€¢ ÐŸÐ¾ ÑÑ‚Ð¸Ð¼ Ð¾Ñ‚Ð²ÐµÑ‚Ð°Ð¼ Ð¿Ð¾Ð´Ð±Ð¸Ñ€Ð°Ð¹ Ð¿Ð¾Ð´Ñ…Ð¾Ð´ÑÑ‰Ð¸Ðµ Ð´ÐµÑ‚ÑÐºÐ¸Ðµ Ð½Ð°Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ Ð¸ Ð³Ñ€ÑƒÐ¿Ð¿Ñ‹ Ð¸Ð· Ñ€Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸Ñ.

Ð ÐÐ¡ÐŸÐ˜Ð¡ÐÐÐ˜Ð•:
â€¢ Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Ñ€Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ð³Ñ€ÑƒÐ¿Ð¿, ÐºÐ¾Ñ‚Ð¾Ñ€Ð¾Ðµ Ð´Ð°Ð½Ð¾ Ð² Ð±Ð°Ð·Ðµ. Ð“Ñ€ÑƒÐ¿Ð¿Ð° Ð²ÑÐµÐ³Ð´Ð° Ð¿Ñ€Ð¸Ð²ÑÐ·Ð°Ð½Ð° Ðº ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ð¾Ð¼Ñƒ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸.
â€¢ ÐÐµ Ð¿Ñ€ÐµÐ´Ð»Ð°Ð³Ð°Ð¹ "Ð»ÑŽÐ±Ð¾Ðµ ÑƒÐ´Ð¾Ð±Ð½Ð¾Ðµ Ð²Ñ€ÐµÐ¼Ñ" Ð´Ð»Ñ Ð³Ñ€ÑƒÐ¿Ð¿Ð¾Ð²Ñ‹Ñ… Ð·Ð°Ð½ÑÑ‚Ð¸Ð¹ â€” Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ñ€ÐµÐ°Ð»ÑŒÐ½Ñ‹Ðµ Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚Ñ‹ Ð¸Ð· Ñ€Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸Ñ.
â€¢ Ð˜Ð½Ð´Ð¸Ð²Ð¸Ð´ÑƒÐ°Ð»ÑŒÐ½Ñ‹Ðµ Ð·Ð°Ð½ÑÑ‚Ð¸Ñ Ð¼Ð¾Ð¶Ð½Ð¾ Ð¿Ñ€Ð¾Ð²Ð¾Ð´Ð¸Ñ‚ÑŒ Ð¿Ð¾ Ð´Ð¾Ð³Ð¾Ð²Ð¾Ñ€ÐµÐ½Ð½Ð¾ÑÑ‚Ð¸ Ñ Ñ‚Ñ€ÐµÐ½ÐµÑ€Ð¾Ð¼ â€” Ñ‚Ð°Ðº Ð¸ Ð¾Ð±ÑŠÑÑÐ½ÑÐ¹.

Ð¤ÐžÐ ÐœÐ Ð—ÐÐŸÐ˜Ð¡Ð˜:
â€¢ ÐšÐ¾Ð³Ð´Ð° Ñ‡ÐµÐ»Ð¾Ð²ÐµÐº ÑƒÐ¶Ðµ Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»Ð¸Ð»ÑÑ Ñ Ð½Ð°Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸ÐµÐ¼ Ð¸ Ð³Ñ€ÑƒÐ¿Ð¿Ð¾Ð¹, ÑÐ¿Ñ€Ð¾ÑÐ¸:
  â€“ Ð³Ð¾Ñ‚Ð¾Ð²Ñ‹ Ð»Ð¸ Ð²Ñ‹ Ð·Ð°Ð¿Ð¸ÑÐ°Ñ‚ÑŒÑÑ Ð½Ð° Ð¿Ñ€Ð¾Ð±Ð½Ð¾Ðµ Ð·Ð°Ð½ÑÑ‚Ð¸Ðµ;
  â€“ Ð¸Ð¼Ñ Ð¸ Ñ„Ð°Ð¼Ð¸Ð»Ð¸ÑŽ;
  â€“ Ð½Ð¾Ð¼ÐµÑ€ Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½Ð°.
â€¢ Ð’ Ð¾Ñ‚Ð²ÐµÑ‚Ðµ Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð¸Ñ€ÑƒÐ¹: Ð²Ñ‹Ð±Ñ€Ð°Ð½Ð½Ñ‹Ð¹ Ñ„Ð¸Ð»Ð¸Ð°Ð», Ð½Ð°Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ, Ð³Ñ€ÑƒÐ¿Ð¿Ñƒ/Ñ€Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ð¸ ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ð½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ.
â€¢ Ð¡Ð°Ð¼Ñƒ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÑƒ Ð·Ð°ÑÐ²ÐºÐ¸ ÐºÑƒÐ´Ð°-Ñ‚Ð¾ Ð´Ð°Ð»ÑŒÑˆÐµ Ð´ÐµÐ»Ð°ÐµÑ‚ Ð²Ð½ÐµÑˆÐ½Ð¸Ð¹ ÐºÐ¾Ð´ â€” Ñ‚Ð²Ð¾Ñ Ð·Ð°Ð´Ð°Ñ‡Ð° Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð°ÐºÐºÑƒÑ€Ð°Ñ‚Ð½Ð¾ ÑÐ¾Ð±Ñ€Ð°Ñ‚ÑŒ Ñ‚ÐµÐºÑÑ‚.

Ð•Ð¡Ð›Ð˜ Ð’ÐžÐŸÐ ÐžÐ¡ ÐÐ•ÐŸÐžÐÐ¯Ð¢Ð•Ð:
â€¢ ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹ Ð¿ÐµÑ€ÐµÑ„Ð¾Ñ€Ð¼ÑƒÐ»Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð¸ ÑƒÑ‚Ð¾Ñ‡Ð½Ð¸Ñ‚ÑŒ, Ñ‡Ñ‚Ð¾ Ð¸Ð¼ÐµÐ½Ð½Ð¾ Ð¸Ð¼ÐµÐµÑ‚ Ð² Ð²Ð¸Ð´Ñƒ Ñ‡ÐµÐ»Ð¾Ð²ÐµÐº.
â€¢ Ð¢Ð¾Ð»ÑŒÐºÐ¾ ÐµÑÐ»Ð¸ Ð¿Ð¾ÑÐ»Ðµ ÑƒÑ‚Ð¾Ñ‡Ð½ÐµÐ½Ð¸Ñ Ð²ÑÑ‘ Ñ€Ð°Ð²Ð½Ð¾ Ð½ÐµÑÑÐ½Ð¾ â€” Ñ‡ÐµÑÑ‚Ð½Ð¾ Ð½Ð°Ð¿Ð¸ÑˆÐ¸:
  "ÐŸÐ¾Ñ…Ð¾Ð¶Ðµ, Ð² Ð¼ÐµÐ½Ñ Ð¿Ð¾ÐºÐ° Ð½Ðµ Ð·Ð°Ð»Ð¾Ð¶Ð¸Ð»Ð¸ Ð¾Ñ‚Ð²ÐµÑ‚ Ð½Ð° Ñ‚Ð°ÐºÐ¾Ð¹ Ð²Ð¾Ð¿Ñ€Ð¾Ñ. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ ÑÑ„Ð¾Ñ€Ð¼ÑƒÐ»Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ ÐµÐ³Ð¾ Ñ‡ÑƒÑ‚ÑŒ Ð¸Ð½Ð°Ñ‡Ðµ Ð¸Ð»Ð¸ ÑÐ²ÑÐ¶Ð¸Ñ‚ÐµÑÑŒ Ñ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð¾Ð¼ ÑÑ‚ÑƒÐ´Ð¸Ð¸."
`;

// ----- Ð—ÐÐ“Ð Ð£Ð—ÐšÐ Ð ÐÐ¡ÐŸÐ˜Ð¡ÐÐÐ˜Ð¯ Ð˜Ð— Ð¤ÐÐ™Ð›Ð -----

const DAY_LABELS = {
  ÐŸÐ½: "Ð¿Ð¾Ð½ÐµÐ´ÐµÐ»ÑŒÐ½Ð¸Ðº",
  Ð’Ñ‚: "Ð²Ñ‚Ð¾Ñ€Ð½Ð¸Ðº",
  Ð¡Ñ€: "ÑÑ€ÐµÐ´Ð°",
  Ð§Ñ‚: "Ñ‡ÐµÑ‚Ð²ÐµÑ€Ð³",
  ÐŸÑ‚: "Ð¿ÑÑ‚Ð½Ð¸Ñ†Ð°",
  Ð¡Ð±: "ÑÑƒÐ±Ð±Ð¾Ñ‚Ð°",
  Ð’Ñ: "Ð²Ð¾ÑÐºÑ€ÐµÑÐµÐ½ÑŒÐµ",
};

let SCHEDULE_TEXT = "";

function loadSchedule() {
  try {
    const schedulePath = path.join(__dirname, "cosmo_schedule_all_branches_ready.json");
    const raw = fs.readFileSync(schedulePath, "utf8");
    const data = JSON.parse(raw);

    if (!data || !Array.isArray(data.groups)) {
      console.warn("âš ï¸ ÐÐµÐ¾Ð¶Ð¸Ð´Ð°Ð½Ð½Ñ‹Ð¹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ cosmo_schedule_all_branches_ready.json");
      return;
    }

    const lines = [];
    for (const g of data.groups) {
      const branch = g.branch || "Ð¤Ð¸Ð»Ð¸Ð°Ð»";
      const name = g.group_name || "Ð“Ñ€ÑƒÐ¿Ð¿Ð°";
      const teacher = g.teacher ? ` (Ð¿Ñ€ÐµÐ¿Ð¾Ð´Ð°Ð²Ð°Ñ‚ÐµÐ»ÑŒ: ${g.teacher})` : "";
      const level = g.level ? `, ÑƒÑ€Ð¾Ð²ÐµÐ½ÑŒ: ${g.level}` : "";

      const schedule = g.schedule || {};
      const days = Object.entries(schedule)
        .filter(([_, v]) => v && String(v).trim() !== "")
        .map(([shortDay, time]) => {
          const fullDay = DAY_LABELS[shortDay] || shortDay;
          return `${fullDay}: ${time}`;
        });

      let schedulePart = "";
      if (days.length > 0) {
        schedulePart = " Ð Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ: " + days.join("; ") + ".";
      }

      lines.push(
        `Ð¤Ð¸Ð»Ð¸Ð°Ð»: ${branch}. Ð“Ñ€ÑƒÐ¿Ð¿Ð°: "${name}"${level}${teacher}.${schedulePart}`
      );
    }

    SCHEDULE_TEXT =
      "\n\nÐ’Ð¾Ñ‚ Ð°ÐºÑ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ðµ Ñ€Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ð³Ñ€ÑƒÐ¿Ð¿ CosmoDance Ð¿Ð¾ Ñ„Ð¸Ð»Ð¸Ð°Ð»Ð°Ð¼. Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ ÐµÐ³Ð¾ ÐºÐ°Ðº Ð¾ÑÐ½Ð¾Ð²Ð½ÑƒÑŽ Ð±Ð°Ð·Ñƒ, Ð½Ðµ Ð¿Ñ€Ð¸Ð´ÑƒÐ¼Ñ‹Ð²Ð°Ð¹ Ð½Ð¾Ð²Ñ‹Ðµ Ð³Ñ€ÑƒÐ¿Ð¿Ñ‹:\n" +
      lines.join("\n");
    console.log("âœ… Ð Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ð¾, Ð³Ñ€ÑƒÐ¿Ð¿:", data.groups.length);
  } catch (err) {
    console.error("âš ï¸ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ cosmo_schedule_all_branches_ready.json:", err);
    SCHEDULE_TEXT = "";
  }
}

loadSchedule();

// ----- Ð‘ÐÐ—Ð Ð—ÐÐÐÐ˜Ð™, ÐšÐžÐ¢ÐžÐ Ð£Ð® ÐŸÐ Ð˜Ð¡Ð«Ð›ÐÐ•Ð¢ upload.js -----

let KNOWLEDGE_BASE = null;

function buildKnowledgeText() {
  if (!KNOWLEDGE_BASE) return "";

  let items = [];
  if (Array.isArray(KNOWLEDGE_BASE)) {
    items = KNOWLEDGE_BASE;
  } else if (Array.isArray(KNOWLEDGE_BASE.items)) {
    items = KNOWLEDGE_BASE.items;
  }

  if (!items.length) return "";

  const parts = items.map((item, i) => {
    const q = item.question || item.q || "";
    const a = item.answer || item.a || "";
    return `Q${i + 1}: ${q}\nA${i + 1}: ${a}`;
  });

  return (
    "\n\nÐ’Ð¾Ñ‚ Ð±Ð°Ð·Ð° Ñ‚Ð¸Ð¿Ð¾Ð²Ñ‹Ñ… Ð²Ð¾Ð¿Ñ€Ð¾ÑÐ¾Ð² Ð¸ Ð¾Ñ‚Ð²ÐµÑ‚Ð¾Ð² Ð¿Ð¾ ÑÑ‚ÑƒÐ´Ð¸Ð¸ CosmoDance. ÐžÑ‚Ð²ÐµÑ‡Ð°Ð¹ Ð² Ð¿ÐµÑ€Ð²ÑƒÑŽ Ð¾Ñ‡ÐµÑ€ÐµÐ´ÑŒ, Ð¾Ð¿Ð¸Ñ€Ð°ÑÑÑŒ Ð½Ð° ÑÑ‚Ð¸ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¸ Ð½Ðµ Ð¸ÑÐºÐ°Ð¶Ð°Ñ Ñ„Ð°ÐºÑ‚Ñ‹:\n" +
    parts.join("\n\n")
  );
}

// ----- ÐžÐ¢Ð”ÐÐ¢Ð¬ Ð’Ð•Ð‘-Ð¡Ð¢Ð ÐÐÐ˜Ð¦Ð£ Ð§ÐÐ¢Ð -----

app.get("/", (req, res) => {
  res.sendFile(path.join(__dirname, "index.html"), {
    headers: { "Content-Type": "text/html; charset=utf-8" },
  });
});

// ÐŸÑ€Ð¾ÑÑ‚ÐµÐ¹ÑˆÐ°Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¶Ð¸Ð²Ð¾ÑÑ‚Ð¸ ÑÐµÑ€Ð²ÐµÑ€Ð°
app.get("/health", (req, res) => {
  res.json({ status: "ok" });
});

// ----- ÐŸÐ Ð˜ÐÐ¯Ð¢Ð¬ Ð‘ÐÐ—Ð£ Ð—ÐÐÐÐ˜Ð™ ÐžÐ¢ upload.js -----

app.post("/upload", (req, res) => {
  try {
    const body = req.body;
    if (!body) {
      return res
        .status(400)
        .json({ status: "error", message: "ÐŸÑƒÑÑ‚Ð¾Ðµ Ñ‚ÐµÐ»Ð¾ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ°" });
    }

    KNOWLEDGE_BASE = body;

    let count = null;
    if (Array.isArray(body)) count = body.length;
    else if (body.items && Array.isArray(body.items)) count = body.items.length;

    console.log("âœ… Ð‘Ð°Ð·Ð° Ð·Ð½Ð°Ð½Ð¸Ð¹ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð°, Ð·Ð°Ð¿Ð¸ÑÐµÐ¹:", count ?? "Ð½ÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ð¾");
    res.json({ status: "ok", message: "Ð‘Ð°Ð·Ð° Ð¿Ñ€Ð¸Ð½ÑÑ‚Ð° Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ", count });
  } catch (e) {
    console.error("ÐžÑˆÐ¸Ð±ÐºÐ° Ð² /upload:", e);
    res
      .status(500)
      .json({ status: "error", message: "ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐµ Ð±Ð°Ð·Ñ‹" });
  }
});

// ----- ÐžÐ¡ÐÐžÐ’ÐÐžÐ™ Ð§ÐÐ¢ /chat -----

app.post("/chat", async (req, res) => {
  try {
    const { userMessage, history } = req.body || {};

    if (!userMessage || typeof userMessage !== "string") {
      return res.status(400).json({
        reply: "ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð½Ð°Ð¿Ð¸ÑˆÐ¸Ñ‚Ðµ Ð²Ð°Ñˆ Ð²Ð¾Ð¿Ñ€Ð¾Ñ Ð¾ ÑÑ‚ÑƒÐ´Ð¸Ð¸ CosmoDance.",
      });
    }

    // Ð˜ÑÑ‚Ð¾Ñ€Ð¸Ñ Ð´Ð¸Ð°Ð»Ð¾Ð³Ð° Ð¾Ñ‚ Ñ„Ñ€Ð¾Ð½Ñ‚Ð° (ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ), Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð½Ðµ Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€ÑÑ‚ÑŒ Ð²Ð¾Ð¿Ñ€Ð¾ÑÑ‹
    const messages = [];

    messages.push({
      role: "system",
      content: SYSTEM_PROMPT + buildKnowledgeText() + SCHEDULE_TEXT,
    });

    if (Array.isArray(history)) {
      // Ð‘ÐµÑ€Ñ‘Ð¼ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ 10 ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð½Ðµ Ñ€Ð°Ð·Ð´ÑƒÐ²Ð°Ñ‚ÑŒ ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚
      const last = history.slice(-10);
      for (const msg of last) {
        if (
          msg &&
          (msg.role === "user" || msg.role === "assistant") &&
          typeof msg.content === "string"
        ) {
          messages.push({ role: msg.role, content: msg.content });
        }
      }
    }

    messages.push({ role: "user", content: userMessage });

    // Ð•ÑÐ»Ð¸ Ð½ÐµÑ‚ ÐºÐ»ÑŽÑ‡Ð° â€” Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÐ¼ Ð·Ð°Ð³Ð»ÑƒÑˆÐºÑƒ, Ð½Ð¾ Ð½Ðµ Ð¿Ð°Ð´Ð°ÐµÐ¼
    if (!process.env.OPENAI_API_KEY) {
      return res.json({
        reply:
          "Ð¡ÐµÐ¹Ñ‡Ð°Ñ Ñƒ Ð¼ÐµÐ½Ñ Ð½ÐµÑ‚ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð° Ðº Ð¼Ð¾Ð´ÐµÐ»Ð¸, Ñ‡Ñ‚Ð¾Ð±Ñ‹ ÑÑ„Ð¾Ñ€Ð¼Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð¾Ñ‚Ð²ÐµÑ‚. ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, ÑÐ²ÑÐ¶Ð¸Ñ‚ÐµÑÑŒ Ñ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð¾Ð¼ ÑÑ‚ÑƒÐ´Ð¸Ð¸.",
      });
    }

    const completion = await openai.chat.completions.create({
      model: "gpt-4.1-mini",
      messages,
      temperature: 0.6,
      max_tokens: 700,
    });

    const reply =
      completion.choices?.[0]?.message?.content?.trim() ||
      "Ð˜Ð·Ð²Ð¸Ð½Ð¸Ñ‚Ðµ, Ñƒ Ð¼ÐµÐ½Ñ Ð½Ðµ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ð»Ð¾ÑÑŒ ÑÑ„Ð¾Ñ€Ð¼Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð¾Ñ‚Ð²ÐµÑ‚. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð¿ÐµÑ€ÐµÑ„Ð¾Ñ€Ð¼ÑƒÐ»Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð²Ð¾Ð¿Ñ€Ð¾Ñ Ð¸Ð»Ð¸ Ð¾Ð±Ñ€Ð°Ñ‚Ð¸Ñ‚ÐµÑÑŒ Ðº Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ñƒ ÑÑ‚ÑƒÐ´Ð¸Ð¸.";

    res.json({ reply });
  } catch (error) {
    console.error("ÐžÑˆÐ¸Ð±ÐºÐ° Ð² /chat:", error);
    res.status(500).json({
      reply:
        "Ð˜Ð·Ð²Ð¸Ð½Ð¸Ñ‚Ðµ, ÑÐµÐ¹Ñ‡Ð°Ñ Ñƒ Ð¼ÐµÐ½Ñ Ñ‚ÐµÑ…Ð½Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ð¿Ð°ÑƒÐ·Ð°. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð·Ð°Ð´Ð°Ñ‚ÑŒ Ð²Ð¾Ð¿Ñ€Ð¾Ñ Ñ‡ÑƒÑ‚ÑŒ Ð¿Ð¾Ð·Ð¶Ðµ Ð¸Ð»Ð¸ ÑÐ²ÑÐ¶Ð¸Ñ‚ÐµÑÑŒ Ñ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð¾Ð¼ ÑÑ‚ÑƒÐ´Ð¸Ð¸.",
    });
  }
});

// ----- Ð—ÐÐŸÐ£Ð¡Ðš Ð¡Ð•Ð Ð’Ð•Ð Ð -----

const port = process.env.PORT || 10000;
app.listen(port, () => {
  console.log(`ðŸš€ CosmoDance server listening on port ${port}`);
});
