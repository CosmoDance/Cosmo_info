import path from "path";
import { fileURLToPath } from "url";
import fs from "fs";

import express from "express";
import cors from "cors";
import dotenv from "dotenv";
import OpenAI from "openai";

dotenv.config();

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const app = express();
app.use(cors());
app.use(express.json({ limit: "2mb" })); // Ð¿Ñ€Ð¸Ð½Ð¸Ð¼Ð°ÐµÐ¼ JSON Ð´Ð¾ 2 ÐœÐ‘

// ---------- OpenAI ÐºÐ»Ð¸ÐµÐ½Ñ‚ ----------
const client = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});

// ---------- Ð‘Ð°Ð·Ð° Ð·Ð½Ð°Ð½Ð¸Ð¹ (Ñ€Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ + Ð¾Ñ‚Ð²ÐµÑ‚Ñ‹) ----------
let KNOWLEDGE_BASE = null;

// Ð¿Ñ€Ð¾Ð±ÑƒÐµÐ¼ Ð¿Ñ€Ð¸ ÑÑ‚Ð°Ñ€Ñ‚Ðµ Ð¿Ð¾Ð´Ñ…Ð²Ð°Ñ‚Ð¸Ñ‚ÑŒ cosmo_schedule_all_branches_ready.json,
// Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð´Ð°Ð¶Ðµ Ð±ÐµÐ· upload.js Ð±Ð¾Ñ‚ Ñ‡Ñ‚Ð¾-Ñ‚Ð¾ Ð·Ð½Ð°Ð» Ð¾ Ð³Ñ€ÑƒÐ¿Ð¿Ð°Ñ…
try {
  const schedulePath = path.join(
    __dirname,
    "cosmo_schedule_all_branches_ready.json"
  );
  if (fs.existsSync(schedulePath)) {
    const raw = fs.readFileSync(schedulePath, "utf-8");
    const data = JSON.parse(raw);
    KNOWLEDGE_BASE = data;
    console.log(
      "[INIT] cosmo_schedule_all_branches_ready.json Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½, Ð³Ñ€ÑƒÐ¿Ð¿:",
      Array.isArray(data.groups) ? data.groups.length : "Ð½ÐµÑ‚ Ð¼Ð°ÑÑÐ¸Ð²Ð° groups"
    );
  } else {
    console.log(
      "[INIT] Ð¤Ð°Ð¹Ð» cosmo_schedule_all_branches_ready.json Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½ â€” Ð¶Ð´ÐµÐ¼ upload.js"
    );
  }
} catch (e) {
  console.error("[INIT] ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ñ‡Ñ‚ÐµÐ½Ð¸Ð¸ cosmo_schedule_all_branches_ready.json:", e);
}

// ---------- Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð½Ð°Ñ Ð¿Ð¾Ð´ÑÐºÐ°Ð·ÐºÐ° ----------
const SYSTEM_PROMPT = `
Ð¢Ñ‹ â€” Ð´Ñ€ÑƒÐ¶ÐµÐ»ÑŽÐ±Ð½Ñ‹Ð¹ Ð¸ Ð²Ð½Ð¸Ð¼Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¹ Ð°ÑÑÐ¸ÑÑ‚ÐµÐ½Ñ‚ ÑÑ‚ÑƒÐ´Ð¸Ð¸ Ñ‚Ð°Ð½Ñ†ÐµÐ² CosmoDance.

Ð¢Ð²Ð¾Ñ Ð·Ð°Ð´Ð°Ñ‡Ð°:
- Ð¿Ð¾Ð¼Ð¾Ð³Ð°Ñ‚ÑŒ Ð²Ñ‹Ð±Ñ€Ð°Ñ‚ÑŒ Ñ„Ð¸Ð»Ð¸Ð°Ð» (Ð—Ð²Ñ‘Ð·Ð´Ð½Ð°Ñ, ÐžÐ·ÐµÑ€ÐºÐ¸, Ð”Ñ‹Ð±ÐµÐ½ÐºÐ¾, ÐšÑƒÐ¿Ñ‡Ð¸Ð½Ð¾),
- Ð¿Ð¾Ð´Ð±Ð¸Ñ€Ð°Ñ‚ÑŒ Ð½Ð°Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ Ð¸ Ð³Ñ€ÑƒÐ¿Ð¿Ñ‹ Ð¿Ð¾ Ð²Ð¾Ð·Ñ€Ð°ÑÑ‚Ñƒ, ÑƒÑ€Ð¾Ð²Ð½ÑŽ Ð¸ Ñ†ÐµÐ»ÑÐ¼,
- Ð¿Ð¾Ð´ÑÐºÐ°Ð·Ñ‹Ð²Ð°Ñ‚ÑŒ Ñ€Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ð³Ñ€ÑƒÐ¿Ð¿,
- Ñ€Ð°ÑÑÐºÐ°Ð·Ñ‹Ð²Ð°Ñ‚ÑŒ Ð¿Ñ€Ð¾ Ð°Ð±Ð¾Ð½ÐµÐ¼ÐµÐ½Ñ‚Ñ‹ Ð¸ Ð¿Ñ€Ð¾Ð±Ð½Ñ‹Ðµ Ð·Ð°Ð½ÑÑ‚Ð¸Ñ,
- Ð¾Ñ‚Ð²ÐµÑ‡Ð°Ñ‚ÑŒ Ð½Ð° Ñ‚Ð¸Ð¿Ð¾Ð²Ñ‹Ðµ Ð²Ð¾Ð¿Ñ€Ð¾ÑÑ‹ Ð¾ ÑÑ‚ÑƒÐ´Ð¸Ð¸.

Ð’Ð°Ð¶Ð½Ð¾:

1) ÐžÑ‚Ð²ÐµÑ‡Ð°Ð¹ Ð¢ÐžÐ›Ð¬ÐšÐž Ð¿Ð¾ Ñ‚ÐµÐ¼Ðµ ÑÑ‚ÑƒÐ´Ð¸Ð¸ CosmoDance Ð¸ Ñ‚Ð°Ð½Ñ†ÐµÐ².
   Ð•ÑÐ»Ð¸ Ð²Ð¾Ð¿Ñ€Ð¾Ñ Ð½Ð¸ÐºÐ°Ðº Ð½Ðµ ÑÐ²ÑÐ·Ð°Ð½ ÑÐ¾ ÑÑ‚ÑƒÐ´Ð¸ÐµÐ¹, Ð¾Ñ‚Ð²ÐµÑ‡Ð°Ð¹:
   "Ð¯ Ð¾Ñ‚Ð²ÐµÑ‡Ð°ÑŽ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð½Ð° Ð²Ð¾Ð¿Ñ€Ð¾ÑÑ‹ Ð¾ ÑÑ‚ÑƒÐ´Ð¸Ð¸ CosmoDance â€” Ñ„Ð¸Ð»Ð¸Ð°Ð»Ð°Ñ…, Ð½Ð°Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸ÑÑ…, Ñ€Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸Ð¸ Ð¸ Ð·Ð°Ð¿Ð¸ÑÑÑ… Ð½Ð° Ð·Ð°Ð½ÑÑ‚Ð¸Ñ."

2) Ð’ÑÐµÐ³Ð´Ð° Ð¾Ð¿Ð¸Ñ€Ð°Ð¹ÑÑ Ð½Ð° Ð±Ð°Ð·Ñƒ Ð·Ð½Ð°Ð½Ð¸Ð¹ Ð¸ Ñ€Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ, ÐºÐ¾Ñ‚Ð¾Ñ€Ð¾Ðµ Ñ‚ÐµÐ±Ðµ Ð¿ÐµÑ€ÐµÐ´Ð°Ð½Ð¾.
   Ð•ÑÐ»Ð¸ Ð² Ð±Ð°Ð·Ðµ ÐµÑÑ‚ÑŒ Ð¿Ð¾Ð´Ñ…Ð¾Ð´ÑÑ‰Ð°Ñ Ð³Ñ€ÑƒÐ¿Ð¿Ð° â€” Ð¿Ñ€ÐµÐ´Ð»Ð°Ð³Ð°Ð¹ ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ñ‹Ðµ Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚Ñ‹:
   Ñ„Ð¸Ð»Ð¸Ð°Ð», Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ðµ Ð³Ñ€ÑƒÐ¿Ð¿Ñ‹, Ð²Ð¾Ð·Ñ€Ð°ÑÑ‚/ÑƒÑ€Ð¾Ð²ÐµÐ½ÑŒ (ÐµÑÐ»Ð¸ ÑƒÐºÐ°Ð·Ð°Ð½), Ð´Ð½Ð¸ Ð½ÐµÐ´ÐµÐ»Ð¸ Ð¸ Ð²Ñ€ÐµÐ¼Ñ.

3) Ð’Ð¾Ð·Ñ€Ð°ÑÑ‚ Ð¸ ÑƒÑ€Ð¾Ð²Ð½Ð¸:
   - "Ð½Ð°Ñ‡Ð¸Ð½Ð°ÑŽÑ‰Ð¸Ðµ", "Ð´Ð»Ñ Ð½Ð¾Ð²Ð¸Ñ‡ÐºÐ¾Ð²", "Ð±ÐµÐ· Ð¾Ð¿Ñ‹Ñ‚Ð°" â€” Ð¾Ð´Ð½Ð¾ Ð¸ Ñ‚Ð¾ Ð¶Ðµ.
   - "ÐºÐ¾Ð¼Ð°Ð½Ð´Ð°" Ð¸Ð»Ð¸ "team" â€” ÑÑ‚Ð¾ Ð³Ñ€ÑƒÐ¿Ð¿Ñ‹ Ð¿Ð¾ ÐºÐ°ÑÑ‚Ð¸Ð½Ð³Ñƒ, Ñ‚ÑƒÐ´Ð° Ð·Ð°Ð¿Ð¸ÑÑ‹Ð²Ð°ÑŽÑ‚ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ñ Ð¾Ð¿Ñ‹Ñ‚Ð¾Ð¼.
   - Ð•ÑÐ»Ð¸ Ð½Ð°Ð¿Ð¸ÑÐ°Ð½Ð¾ "16+" â€” ÑÑ‚Ð¾ Ð³Ñ€ÑƒÐ¿Ð¿Ð° Ð´Ð»Ñ Ð²Ð·Ñ€Ð¾ÑÐ»Ñ‹Ñ…, ÐºÑƒÐ´Ð° Ð¼Ð¾Ð¶Ð½Ð¾ Ð¿Ñ€Ð¸Ð¹Ñ‚Ð¸ Ð¸ Ð² 20, 30, 40 Ð»ÐµÑ‚ Ð¸ ÑÑ‚Ð°Ñ€ÑˆÐµ,
     ÐµÑÐ»Ð¸ Ð½ÐµÑ‚ Ð¼ÐµÐ´Ð¸Ñ†Ð¸Ð½ÑÐºÐ¸Ñ… Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸Ð¹.
   - Ð•ÑÐ»Ð¸ Ñ‡ÐµÐ»Ð¾Ð²ÐµÐº Ð¿ÐµÑ€ÐµÐ¶Ð¸Ð²Ð°ÐµÑ‚, Ñ‡Ñ‚Ð¾ Ð² Ð³Ñ€ÑƒÐ¿Ð¿Ðµ Ð±ÑƒÐ´ÑƒÑ‚ "Ð²ÑÐµ 16, Ð° Ð¼Ð½Ðµ 40",
     ÑÐ¿Ð¾ÐºÐ¾Ð¹Ð½Ð¾ Ð¾Ð±ÑŠÑÑÐ½Ð¸, Ñ‡Ñ‚Ð¾ Ð² Ð³Ñ€ÑƒÐ¿Ð¿Ð°Ñ… Ñ‡Ð°ÑÑ‚Ð¾ Ð±Ñ‹Ð²Ð°ÑŽÑ‚ Ñ€Ð°Ð·Ð½Ñ‹Ðµ Ð²Ð¾Ð·Ñ€Ð°ÑÑ‚Ð°,
     Ð¼Ð¾Ð¶Ð½Ð¾ Ð¿Ñ€Ð¸Ð¹Ñ‚Ð¸ Ð½Ð° Ð¿Ñ€Ð¾Ð±Ð½Ð¾Ðµ Ð·Ð°Ð½ÑÑ‚Ð¸Ðµ Ð¸ Ð¿Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ÐµÑ‚ÑŒ ÑÐ¾ÑÑ‚Ð°Ð² Ð³Ñ€ÑƒÐ¿Ð¿Ñ‹,
     Ð° Ñ…Ð¾Ñ€ÐµÐ¾Ð³Ñ€Ð°Ñ„ Ð¿Ð¾Ð¼Ð¾Ð¶ÐµÑ‚ Ð¼ÑÐ³ÐºÐ¾ Ð²Ð»Ð¸Ñ‚ÑŒÑÑ Ð² Ð¿Ñ€Ð¾Ñ†ÐµÑÑ.

4) ÐŸÑ€Ð¾Ð±Ð½Ð¾Ðµ Ð·Ð°Ð½ÑÑ‚Ð¸Ðµ Ð¸ Ð·Ð°ÑÐ²ÐºÐ°:
   - ÐšÐ¾Ð³Ð´Ð° Ñ‡ÐµÐ»Ð¾Ð²ÐµÐº ÑƒÐ¶Ðµ Ð²Ñ‹Ð±Ñ€Ð°Ð» Ñ„Ð¸Ð»Ð¸Ð°Ð», Ð½Ð°Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¸ ÑƒÐ´Ð¾Ð±Ð½ÑƒÑŽ Ð³Ñ€ÑƒÐ¿Ð¿Ñƒ/Ñ€Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ,
     ÑƒÑ‚Ð¾Ñ‡Ð½Ð¸, Ð³Ð¾Ñ‚Ð¾Ð² Ð»Ð¸ Ð¾Ð½ Ð·Ð°Ð¿Ð¸ÑÐ°Ñ‚ÑŒÑÑ Ð½Ð° Ð¿Ñ€Ð¾Ð±Ð½Ð¾Ðµ Ð·Ð°Ð½ÑÑ‚Ð¸Ðµ.
   - Ð•ÑÐ»Ð¸ Ñ‡ÐµÐ»Ð¾Ð²ÐµÐº ÑÐ¾Ð³Ð»Ð°ÑÐµÐ½, Ð¡Ð”Ð•Ð›ÐÐ™ ÐšÐ ÐÐ¢ÐšÐžÐ• Ð Ð•Ð—Ð®ÐœÐ• Ð·Ð°ÑÐ²ÐºÐ¸ Ð² ÐºÐ¾Ð½Ñ†Ðµ Ð¾Ñ‚Ð²ÐµÑ‚Ð°:
     Ñ„Ð¸Ð»Ð¸Ð°Ð», Ð½Ð°Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ, Ð³Ñ€ÑƒÐ¿Ð¿Ð°/Ñ€Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ, Ð²Ð¾Ð·Ñ€Ð°ÑÑ‚ (ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ), ÑƒÑ€Ð¾Ð²ÐµÐ½ÑŒ (Ð½Ð¾Ð²Ð¸Ñ‡Ð¾Ðº/ÐµÑÑ‚ÑŒ Ð¾Ð¿Ñ‹Ñ‚),
     Ð¸Ð¼Ñ/Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½ (ÐµÑÐ»Ð¸ Ð¾Ð½ Ð¸Ñ… Ð½Ð°Ð¿Ð¸ÑÐ°Ð»).
   - ÐÐµ Ð¿Ñ€Ð¸Ð´ÑƒÐ¼Ñ‹Ð²Ð°Ð¹ Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½ Ð¸ Ð¸Ð¼Ñ, ÐµÑÐ»Ð¸ Ð¸Ñ… ÐµÑ‰Ñ‘ Ð½Ðµ Ð±Ñ‹Ð»Ð¾.

5) Ð”Ð¸Ð°Ð»Ð¾Ð³ Ð¸ Ð¿Ð°Ð¼ÑÑ‚ÑŒ:
   - Ð’ÑÐµÐ³Ð´Ð° ÑƒÑ‡Ð¸Ñ‚Ñ‹Ð²Ð°Ð¹ Ð’Ð¡Ð® Ð¿Ñ€ÐµÐ´Ñ‹Ð´ÑƒÑ‰ÐµÑŽ Ð¿ÐµÑ€ÐµÐ¿Ð¸ÑÐºÑƒ, Ð¿Ñ€Ð¸ÑÐ»Ð°Ð½Ð½ÑƒÑŽ Ñ‚ÐµÐ±Ðµ Ð² history.
   - Ð•ÑÐ»Ð¸ Ñ‡ÐµÐ»Ð¾Ð²ÐµÐº ÑƒÐ¶Ðµ Ð¾Ñ‚Ð²ÐµÑ‚Ð¸Ð» Ð½Ð° Ñ‚Ð²Ð¾Ð¹ Ð²Ð¾Ð¿Ñ€Ð¾Ñ (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, Ð½Ð°Ð¿Ð¸ÑÐ°Ð» "5 Ð»ÐµÑ‚ Ð·Ð²Ñ‘Ð·Ð´Ð½Ð°Ñ" Ð¸Ð»Ð¸
     "Ð·Ð²ÐµÐ·Ð´Ð½Ð°Ñ, Ñ€ÐµÐ±Ñ‘Ð½Ð¾Ðº 7 Ð»ÐµÑ‚, Ð½Ð°Ñ‡Ð¸Ð½Ð°ÐµÐ¼ Ñ Ð½ÑƒÐ»Ñ"), ÐÐ• Ð¡ÐŸÐ ÐÐ¨Ð˜Ð’ÐÐ™ ÑÑ‚Ð¾ Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€Ð½Ð¾.
   - Ð£Ð¼ÐµÐ¹ Ð¿Ð¾Ð½Ð¸Ð¼Ð°Ñ‚ÑŒ ÐºÐ¾Ñ€Ð¾Ñ‚ÐºÐ¸Ðµ Ð¾Ñ‚Ð²ÐµÑ‚Ñ‹ Ð¸ Ñ„Ñ€Ð°Ð·Ñ‹, Ð³Ð´Ðµ Ð½ÐµÑÐºÐ¾Ð»ÑŒÐºÐ¾ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ð¾Ð² Ð² Ð¾Ð´Ð½Ð¾Ð¹ ÑÑ‚Ñ€Ð¾ÐºÐµ.
     ÐŸÑ€Ð¸Ð¼ÐµÑ€Ñ‹:
       "5 Ð»ÐµÑ‚ Ð·Ð²Ñ‘Ð·Ð´Ð½Ð°Ñ" â†’ Ð²Ð¾Ð·Ñ€Ð°ÑÑ‚ Ñ€ÐµÐ±Ñ‘Ð½ÐºÐ° 5 Ð»ÐµÑ‚, Ñ„Ð¸Ð»Ð¸Ð°Ð» Ð—Ð²Ñ‘Ð·Ð´Ð½Ð°Ñ.
       "Ð´Ð»Ñ ÑÐµÐ±Ñ, ÐšÑƒÐ¿Ñ‡Ð¸Ð½Ð¾, Ð½Ð¾Ð²Ð¸Ñ‡Ð¾Ðº" â†’ Ð·Ð°Ð½ÑÑ‚Ð¸Ñ Ð´Ð»Ñ Ð²Ð·Ñ€Ð¾ÑÐ»Ð¾Ð³Ð¾, Ñ„Ð¸Ð»Ð¸Ð°Ð» ÐšÑƒÐ¿Ñ‡Ð¸Ð½Ð¾, ÑƒÑ€Ð¾Ð²ÐµÐ½ÑŒ Ð½Ð¾Ð²Ð¸Ñ‡Ð¾Ðº.
   - Ð¤Ð¾Ñ€Ð¼ÑƒÐ»Ð¸Ñ€ÑƒÐ¹ Ð²Ð¾Ð¿Ñ€Ð¾ÑÑ‹ Ñ‚Ð°Ðº, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð´Ð²Ð¸Ð³Ð°Ñ‚ÑŒÑÑ Ð´Ð°Ð»ÑŒÑˆÐµ, Ð° Ð½Ðµ Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€ÑÑ‚ÑŒ ÑƒÐ¶Ðµ Ð²Ñ‹ÑÑÐ½Ñ‘Ð½Ð½Ð¾Ðµ.

6) Ð¡Ñ‚Ð¸Ð»ÑŒ:
   - ÐžÐ±Ñ€Ð°Ñ‰Ð°Ð¹ÑÑ Ð½Ð° "Ð²Ñ‹".
   - ÐŸÐ¸ÑˆÐ¸ Ð¿Ñ€Ð¾ÑÑ‚Ñ‹Ð¼ Ð¶Ð¸Ð²Ñ‹Ð¼ ÑÐ·Ñ‹ÐºÐ¾Ð¼, Ñ‚ÐµÐ¿Ð»Ð¾ Ð¸ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°ÑŽÑ‰Ðµ, Ð±ÐµÐ· ÐºÐ°Ð½Ñ†ÐµÐ»ÑÑ€Ð¸Ñ‚Ð°.
   - ÐŸÐ¾Ð¼Ð¾Ð³Ð°Ð¹ ÑÐ½ÑÑ‚ÑŒ Ð²Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ: "Ð° ÐµÑÐ»Ð¸ Ñ Ð½Ð¾Ð²Ð¸Ñ‡Ð¾Ðº", "Ð° ÐµÑÐ»Ð¸ Ð¼Ð½Ðµ Ð¼Ð½Ð¾Ð³Ð¾ Ð»ÐµÑ‚", "Ñ ÑÑ‚ÐµÑÐ½ÑÑŽÑÑŒ" Ð¸ Ñ‚.Ð¿.
   - ÐžÑ‚Ð²ÐµÑ‡Ð°Ð¹ Ð¿Ð¾ ÑÑƒÑ‰ÐµÑÑ‚Ð²Ñƒ, Ð½Ð¾ Ð½Ðµ ÑÐ»Ð¸ÑˆÐºÐ¾Ð¼ Ð´Ð»Ð¸Ð½Ð½Ð¾ â€” 3â€“8 ÐºÐ¾Ñ€Ð¾Ñ‚ÐºÐ¸Ñ… Ð°Ð±Ð·Ð°Ñ†ÐµÐ² Ð¾Ð±Ñ‹Ñ‡Ð½Ð¾ Ð´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾.
`;

// ---------- Ð’ÑÐ¿Ð¾Ð¼Ð¾Ð³Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸ ----------

function buildKnowledgeText() {
  if (!KNOWLEDGE_BASE) return "";

  let parts = [];

  // Ð Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ð³Ñ€ÑƒÐ¿Ð¿
  if (Array.isArray(KNOWLEDGE_BASE.groups) && KNOWLEDGE_BASE.groups.length > 0) {
    const lines = KNOWLEDGE_BASE.groups.map((g, i) => {
      const branch = g.branch || "Ð¤Ð¸Ð»Ð¸Ð°Ð» Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½";
      const name = g.group_name || "Ð“Ñ€ÑƒÐ¿Ð¿Ð° Ð±ÐµÐ· Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ñ";
      const level = g.level || (g.is_team ? "ÐºÐ¾Ð¼Ð°Ð½Ð´Ð°" : "ÑƒÑ€Ð¾Ð²ÐµÐ½ÑŒ Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½");
      const teacher = g.teacher ? `ÐŸÑ€ÐµÐ¿Ð¾Ð´Ð°Ð²Ð°Ñ‚ÐµÐ»ÑŒ: ${g.teacher}. ` : "";

      let scheduleStr = "";
      if (g.schedule && typeof g.schedule === "object") {
        const dayMap = {
          "ÐŸÐ½": "Ð¿Ð¾Ð½ÐµÐ´ÐµÐ»ÑŒÐ½Ð¸Ðº",
          "Ð’Ñ‚": "Ð²Ñ‚Ð¾Ñ€Ð½Ð¸Ðº",
          "Ð¡Ñ€": "ÑÑ€ÐµÐ´Ð°",
          "Ð§Ñ‚": "Ñ‡ÐµÑ‚Ð²ÐµÑ€Ð³",
          "ÐŸÑ‚": "Ð¿ÑÑ‚Ð½Ð¸Ñ†Ð°",
          "Ð¡Ð±": "ÑÑƒÐ±Ð±Ð¾Ñ‚Ð°",
          "Ð’Ñ": "Ð²Ð¾ÑÐºÑ€ÐµÑÐµÐ½ÑŒÐµ",
        };
        const dayParts = [];
        for (const [shortDay, time] of Object.entries(g.schedule)) {
          if (!time) continue;
          const fullDay = dayMap[shortDay] || shortDay;
          dayParts.push(`${fullDay}: ${time}`);
        }
        if (dayParts.length > 0) {
          scheduleStr = "Ð Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ: " + dayParts.join("; ") + ". ";
        }
      }

      return `Ð“Ñ€ÑƒÐ¿Ð¿Ð° ${i + 1}: Ñ„Ð¸Ð»Ð¸Ð°Ð» ${branch}, Ð½Ð°Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ "${name}", ÑƒÑ€Ð¾Ð²ÐµÐ½ÑŒ: ${level}. ${teacher}${scheduleStr}`.trim();
    });

    parts.push(
      "ÐÐ¸Ð¶Ðµ Ñ€Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ð³Ñ€ÑƒÐ¿Ð¿ CosmoDance. Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ ÐµÐ³Ð¾, ÐºÐ¾Ð³Ð´Ð° Ð¿Ð¾Ð´Ð±Ð¸Ñ€Ð°ÐµÑˆÑŒ Ð·Ð°Ð½ÑÑ‚Ð¸Ñ:\n" +
        lines.join("\n")
    );
  }

  // Ð•ÑÐ»Ð¸ Ð² Ð±ÑƒÐ´ÑƒÑ‰ÐµÐ¼ Ð±ÑƒÐ´ÑƒÑ‚ ÐµÑ‰Ñ‘ Ð¿Ð¾Ð»Ñ (FAQ Ð¸ Ñ‚.Ð¿.) â€” Ð¼Ð¾Ð¶Ð½Ð¾ Ð´Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ ÑÑŽÐ´Ð°.

  return parts.length > 0
    ? "\n\nÐ’Ð¾Ñ‚ Ð±Ð°Ð·Ð° Ð·Ð½Ð°Ð½Ð¸Ð¹ Ð¿Ð¾ Ð³Ñ€ÑƒÐ¿Ð¿Ð°Ð¼ Ð¸ Ñ€Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸ÑŽ CosmoDance. ÐžÑ‚Ð²ÐµÑ‡Ð°Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŽ, Ð¾Ð¿Ð¸Ñ€Ð°Ð¹ÑÑ Ð½Ð° ÑÑ‚Ð¸ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¸ ÐÐ• Ð¿Ñ€Ð¸Ð´ÑƒÐ¼Ñ‹Ð²Ð°Ð¹ Ñ€Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ:\n\n" +
        parts.join("\n\n")
    : "";
}

// ---------- ÐœÐ°Ñ€ÑˆÑ€ÑƒÑ‚Ñ‹ ----------

// ÐžÑ‚Ð´Ð°Ñ‚ÑŒ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñƒ Ñ‡Ð°Ñ‚Ð°
app.get("/", (req, res) => {
  res.sendFile(path.join(__dirname, "index.html"), {
    headers: { "Content-Type": "text/html; charset=utf-8" },
  });
});

// ÐŸÑ€Ð¸Ñ‘Ð¼ Ð±Ð°Ð·Ñ‹ Ð·Ð½Ð°Ð½Ð¸Ð¹ (upload.js ÑˆÐ»Ñ‘Ñ‚ ÑÑŽÐ´Ð° knowledge.json / Ñ€Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ)
app.post("/upload", (req, res) => {
  try {
    const body = req.body;
    if (!body) {
      return res.status(400).json({
        status: "error",
        message: "ÐŸÑƒÑÑ‚Ð¾Ðµ Ñ‚ÐµÐ»Ð¾ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ°",
      });
    }

    KNOWLEDGE_BASE = body;
    let count = null;
    if (Array.isArray(body)) count = body.length;
    else if (body.groups && Array.isArray(body.groups)) count = body.groups.length;
    else if (body.items && Array.isArray(body.items)) count = body.items.length;

    console.log("Ð‘Ð°Ð·Ð° Ð·Ð½Ð°Ð½Ð¸Ð¹ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð°, Ð·Ð°Ð¿Ð¸ÑÐµÐ¹:", count ?? "Ð½ÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ð¾");

    return res.json({
      status: "ok",
      message: "Ð‘Ð°Ð·Ð° Ð¿Ñ€Ð¸Ð½ÑÑ‚Ð° Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ",
      count,
    });
  } catch (e) {
    console.error("ÐžÑˆÐ¸Ð±ÐºÐ° Ð² /upload:", e);
    return res.status(500).json({
      status: "error",
      message: "ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐµ Ð±Ð°Ð·Ñ‹",
    });
  }
});

// ÐžÑÐ½Ð¾Ð²Ð½Ð¾Ð¹ Ñ‡Ð°Ñ‚
app.post("/chat", async (req, res) => {
  try {
    const { history } = req.body || {};

    if (!Array.isArray(history) || history.length === 0) {
      return res.status(400).json({
        ok: false,
        error: "EMPTY_HISTORY",
        reply: "ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð½Ð°Ð¿Ð¸ÑˆÐ¸Ñ‚Ðµ Ð²Ð°Ñˆ Ð²Ð¾Ð¿Ñ€Ð¾Ñ Ð¾ ÑÑ‚ÑƒÐ´Ð¸Ð¸ CosmoDance ðŸ™‚",
      });
    }

    // ÐžÐ±Ñ€ÐµÐ·Ð°ÐµÐ¼ Ð¸ÑÑ‚Ð¾Ñ€Ð¸ÑŽ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð½Ðµ Ñ€Ð°Ð·Ð´ÑƒÐ²Ð°Ñ‚ÑŒ ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚
    const MAX_MESSAGES = 20; // Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ñ… 20 ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹ (10 Ð¿Ð°Ñ€ "Ð²Ð¾Ð¿Ñ€Ð¾Ñ-Ð¾Ñ‚Ð²ÐµÑ‚")
    const shortHistory =
      history.length > MAX_MESSAGES
        ? history.slice(history.length - MAX_MESSAGES)
        : history;

    const knowledgeText = buildKnowledgeText();

    const messagesForModel = [
      { role: "system", content: SYSTEM_PROMPT },
      ...(knowledgeText
        ? [{ role: "system", content: knowledgeText }]
        : []),
      ...shortHistory.map((msg) => ({
        role: msg.role === "assistant" ? "assistant" : "user",
        content: String(msg.content || ""),
      })),
    ];

    const completion = await client.chat.completions.create({
      model: "gpt-4.1-mini",
      messages: messagesForModel,
      temperature: 0.6,
      max_tokens: 700,
    });

    const reply =
      completion.choices?.[0]?.message?.content?.trim() ||
      "Ð˜Ð·Ð²Ð¸Ð½Ð¸Ñ‚Ðµ, Ñƒ Ð¼ÐµÐ½Ñ Ð½Ðµ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ð»Ð¾ÑÑŒ ÑÑ„Ð¾Ñ€Ð¼Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð¾Ñ‚Ð²ÐµÑ‚. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð¿ÐµÑ€ÐµÑ„Ð¾Ñ€Ð¼ÑƒÐ»Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð²Ð¾Ð¿Ñ€Ð¾Ñ ðŸ™‚";

    return res.json({
      ok: true,
      reply,
    });
  } catch (error) {
    console.error("ÐžÑˆÐ¸Ð±ÐºÐ° Ð² /chat:", error);
    return res.status(500).json({
      ok: false,
      error: "SERVER_ERROR",
      reply:
        "Ð˜Ð·Ð²Ð¸Ð½Ð¸Ñ‚Ðµ, ÑÐµÐ¹Ñ‡Ð°Ñ Ñƒ Ð¼ÐµÐ½Ñ Ð½ÐµÐ±Ð¾Ð»ÑŒÑˆÐ°Ñ Ñ‚ÐµÑ…Ð½Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ð¿Ð°ÑƒÐ·Ð°. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð·Ð°Ð´Ð°Ñ‚ÑŒ Ð²Ð¾Ð¿Ñ€Ð¾Ñ ÐµÑ‰Ñ‘ Ñ€Ð°Ð· Ð¸Ð»Ð¸ Ð½ÐµÐ¼Ð½Ð¾Ð³Ð¾ Ð¿ÐµÑ€ÐµÑ„Ð¾Ñ€Ð¼ÑƒÐ»Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ ÐµÐ³Ð¾. Ð•ÑÐ»Ð¸ Ð¾ÑˆÐ¸Ð±ÐºÐ° Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€ÑÐµÑ‚ÑÑ, Ð¼Ð¾Ð¶Ð½Ð¾ Ð½Ð°Ð¿Ð¸ÑÐ°Ñ‚ÑŒ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ñƒ ÑÑ‚ÑƒÐ´Ð¸Ð¸.",
    });
  }
});

// ÐžÑ‚Ñ‡Ñ‘Ñ‚ Ð¾ Ð´Ð¸Ð°Ð»Ð¾Ð³Ðµ (Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð¿Ð¾ÑÐ»Ðµ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ñ)
app.post("/report", async (req, res) => {
  try {
    const { history, reason } = req.body || {};

    if (!Array.isArray(history) || history.length === 0) {
      return res.json({ ok: true, skipped: true, message: "ÐÐµÑ‚ Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ð¸ Ð´Ð»Ñ Ð¾Ñ‚Ñ‡Ñ‘Ñ‚Ð°" });
    }

    // Ð“Ð¾Ñ‚Ð¾Ð²Ð¸Ð¼ Ñ‚ÐµÐºÑÑ‚ Ð´Ð»Ñ ÑÐ²Ð¾Ð´ÐºÐ¸
    const plainLog = history
      .map((m) => `${m.role === "assistant" ? "Ð‘Ð¾Ñ‚" : "ÐšÐ»Ð¸ÐµÐ½Ñ‚"}: ${m.content}`)
      .join("\n");

    let summaryText = plainLog;

    // Ð•ÑÐ»Ð¸ ÐµÑÑ‚ÑŒ ÐºÐ»ÑŽÑ‡ OpenAI â€” Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐµÐ¼ ÑÐ´ÐµÐ»Ð°Ñ‚ÑŒ ÐºÐ¾Ñ€Ð¾Ñ‚ÐºÑƒÑŽ ÑÐ²Ð¾Ð´ÐºÑƒ
    try {
      const summaryCompletion = await client.chat.completions.create({
        model: "gpt-4.1-mini",
        messages: [
          {
            role: "system",
            content:
              "Ð¢Ñ‹ Ð´ÐµÐ»Ð°ÐµÑˆÑŒ Ð¾Ñ‡ÐµÐ½ÑŒ ÐºÑ€Ð°Ñ‚ÐºÐ¾Ðµ Ñ€ÐµÐ·ÑŽÐ¼Ðµ Ð´Ð¸Ð°Ð»Ð¾Ð³Ð° ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð° ÑÐ¾ ÑÑ‚ÑƒÐ´Ð¸ÐµÐ¹ Ñ‚Ð°Ð½Ñ†ÐµÐ² CosmoDance Ð´Ð»Ñ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð°.",
          },
          {
            role: "user",
            content:
              "Ð’Ð¾Ñ‚ Ð²ÐµÑÑŒ Ð´Ð¸Ð°Ð»Ð¾Ð³. Ð¡Ð¾ÑÑ‚Ð°Ð²ÑŒ ÐºÑ€Ð°Ñ‚ÐºÑƒÑŽ Ð²Ñ‹Ð¶Ð¸Ð¼ÐºÑƒ: ÐºÑ‚Ð¾, ÐºÐ°ÐºÐ¾Ð¹ Ñ„Ð¸Ð»Ð¸Ð°Ð»/Ð½Ð°Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ/Ð²Ð¾Ð·Ñ€Ð°ÑÑ‚ Ð¸Ð½Ñ‚ÐµÑ€ÐµÑÐ¾Ð²Ð°Ð», Ðº Ñ‡ÐµÐ¼Ñƒ Ð² Ð¸Ñ‚Ð¾Ð³Ðµ Ð¿Ñ€Ð¸ÑˆÐ»Ð¸, Ð³Ð¾Ñ‚Ð¾Ð² Ð»Ð¸ Ñ‡ÐµÐ»Ð¾Ð²ÐµÐº Ð·Ð°Ð¿Ð¸ÑÐ°Ñ‚ÑŒÑÑ.\n\n" +
              plainLog,
          },
        ],
        max_tokens: 250,
        temperature: 0.3,
      });

      summaryText =
        summaryCompletion.choices?.[0]?.message?.content?.trim() || plainLog;
    } catch (e) {
      console.error("ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ð¸ ÑÐ²Ð¾Ð´ÐºÐ¸ Ð´Ð»Ñ Ð¾Ñ‚Ñ‡Ñ‘Ñ‚Ð°:", e);
    }

    const finalText =
      `ÐžÑ‚Ñ‡Ñ‘Ñ‚ Ð¾ Ð´Ð¸Ð°Ð»Ð¾Ð³Ðµ CosmoDance.\nÐŸÑ€Ð¸Ñ‡Ð¸Ð½Ð° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ñ: ${reason || "Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½Ð°"}.\n\n` +
      summaryText;

    // Ð•ÑÐ»Ð¸ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½ Telegram-Ð±Ð¾Ñ‚ â€” Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼
    const botToken = process.env.TELEGRAM_BOT_TOKEN;
    const chatId = process.env.TELEGRAM_CHAT_ID; // ÑÑŽÐ´Ð° Ñ‚Ñ‹ ÑÐ°Ð¼ Ð¿Ð¾Ð´ÑÑ‚Ð°Ð²Ð¸ÑˆÑŒ ID/ÐºÐ°Ð½Ð°Ð»

    if (botToken && chatId) {
      const url = `https://api.telegram.org/bot${botToken}/sendMessage`;

      await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          chat_id: chatId,
          text: finalText,
          parse_mode: "HTML",
        }),
      });

      return res.json({ ok: true, sentToTelegram: true });
    }

    // Ð•ÑÐ»Ð¸ Telegram Ð½Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½ â€” Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÐ¼ ÑÐ²Ð¾Ð´ÐºÑƒ (Ð¼Ð¾Ð¶Ð½Ð¾ ÑÐ¼Ð¾Ñ‚Ñ€ÐµÑ‚ÑŒ Ð² Ð»Ð¾Ð³Ð°Ñ… Render)
    console.log("[REPORT]\n" + finalText);

    return res.json({ ok: true, sentToTelegram: false, summary: finalText });
  } catch (e) {
    console.error("ÐžÑˆÐ¸Ð±ÐºÐ° Ð² /report:", e);
    return res.status(500).json({ ok: false });
  }
});

// ÐŸÑ€Ð¾ÑÑ‚Ð¾Ð¹ health-check
app.get("/health", (_req, res) => {
  res.json({ ok: true });
});

const port = process.env.PORT || 10000;
app.listen(port, () => {
  console.log(`CosmoDance server listening on port ${port}`);
});
