// server.js
import path from "path";
import { fileURLToPath } from "url";

import express from "express";
import cors from "cors";
import dotenv from "dotenv";
import fs from "fs";
import OpenAI from "openai";

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

dotenv.config();

const app = express();
app.use(cors());
app.use(express.json({ limit: "2mb" })); // принимаем JSON до 2 МБ

const client = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});

// ---------- Загрузка локальной базы знаний и расписания ----------

function safeLoadJSON(filename) {
  try {
    const fullPath = path.join(__dirname, filename);
    if (!fs.existsSync(fullPath)) {
      console.warn(`⚠️ Файл ${filename} не найден`);
      return null;
    }
    const text = fs.readFileSync(fullPath, "utf-8");
    return JSON.parse(text);
  } catch (e) {
    console.error(`Ошибка чтения ${filename}:`, e);
    return null;
  }
}

const KNOWLEDGE_JSON = safeLoadJSON("knowledge.json");
const SCHEDULE_JSON = safeLoadJSON("cosmo_schedule_all_branches_ready.json");

// Превращаем расписание в удобный текст для модели
function scheduleToText(scheduleJson) {
  if (!scheduleJson || !Array.isArray(scheduleJson.groups)) return "";

  const dayNames = {
    "Пн": "понедельник",
    "Вт": "вторник",
    "Ср": "среда",
    "Чт": "четверг",
    "Пт": "пятница",
    "Сб": "суббота",
    "Вс": "воскресенье",
  };

  const lines = [];

  for (const g of scheduleJson.groups) {
    const branch = g.branch || "";
    const name = g.group_name || "";
    const teacher = g.teacher || "";
    const level = g.level || "";
    const isTeam = g.is_team ? " (команда, по отбору/кастингу)" : "";
    const parts = [];

    if (g.schedule && typeof g.schedule === "object") {
      for (const [shortDay, time] of Object.entries(g.schedule)) {
        if (!time) continue;
        const fullDay = dayNames[shortDay] || shortDay;
        parts.push(`${fullDay}: ${time}`);
      }
    }

    if (!parts.length) continue;

    const line =
      `Филиал: ${branch}. Группа: ${name}` +
      (level ? `, уровень: ${level}` : "") +
      isTeam +
      (teacher ? `, педагог: ${teacher}` : "") +
      `. Расписание: ${parts.join("; ")}.`;

    lines.push(line);
  }

  return lines.join("\n");
}

const SCHEDULE_TEXT = scheduleToText(SCHEDULE_JSON);

// ---------- Системная подсказка ----------

const SYSTEM_PROMPT_BASE = `
Ты — дружелюбный и внимательный ассистент студии танцев CosmoDance.

Твои основные задачи:
1) Помогать выбрать направление и филиал.
2) Подбирать подходящую группу по возрасту, уровню (опыт/новичок) и расписанию.
3) Объяснять, как пройти, как записаться, как работает пробное занятие, абонементы и т.п.
4) Отвечать на типичные «страхи» и сомнения (возраст, опыт, подойдет ли группа и т.п.).
5) Отвечать строго в рамках студии CosmoDance и танцев. На посторонние темы мягко отказывай: 
   "Я отвечаю только на вопросы о студии CosmoDance и занятиях танцами."

Филиалы: Звёздная, Озерки, Дыбенко, Купчино.
Используй написания "Звёздная" и "Звездная" как одно и то же.
Если в ответе пользователя есть что-то похожее на эти названия даже с ошибкой, считай, что он указал филиал.

ВАЖНО по диалогу и «слотам»:
- Ты ведёшь диалог как менеджер: сначала выясняешь филиал, потом для кого занятие (взрослый или ребёнок),
  возраст ребёнка, есть ли танцевальный опыт, что хочется получить от занятий.
- Если пользователь ответил на вопрос в одной фразе сразу на несколько пунктов 
  (например: "5 лет звездная", "звёздная, 7 лет", "для ребёнка 10 лет, Купчино"),
  ты ДОЛЖЕН сам разобрать фразу, вытащить филиал, возраст, кто записывается и НЕ ЗАДАВАТЬ ЭТИ ЖЕ ВОПРОСЫ ПОВТОРНО.
- Считай, что ты всегда имеешь доступ к прошлым сообщениям диалога: используй их, не повторяй вопросы.
- Если вдруг информации не хватает, задавай уточняющие вопросы, но старайся не спрашивать одно и то же.

Возраст и обозначения типа "16+":
- "16+" означает, что группа открыта для всех, кому 16 и старше. 
- Если человеку 30, 40, 50 и т.д., можно тоже ходить в 16+ при желании.
- Если пользователь переживает, что все будут сильно младше или опытнее:
  * спокойным тоном объясни, что в группах обычно разный возраст,
  * можно прийти на пробное занятие и посмотреть состав группы,
  * программа и педагог помогают включиться на любом этапе, даже если кто-то занимается дольше.
- Не ограничивай человека возрастом, если он попадает в "16+" или похожую категорию.

Группы и команды:
- Если в названии есть слово "команда", поясни, что это более продвинутый состав,
  туда попадают ученики с опытом, обычно по отбору/кастингу.
- Начинающие группы открыты для записи без опыта.

Расписание:
- Используй содержимое расписания по филиалам, которое дано ниже.
- В ответах всегда пиши ДНИ НЕДЕЛИ ПОЛНОСТЬЮ: понедельник, вторник, среда, четверг, пятница, суббота, воскресенье.
  Не используй сокращения типа "Пн", "Вт".
- Объясняй, что групповые занятия проходят по чёткому расписанию (2–3 раза в неделю),
  нельзя приходить в любое время, но ТАК СЛОВО "строго" лучше не использовать — пиши мягко.
- Индивидуальные занятия можно согласовать в удобное время с педагогом.

Работа с родителями:
- Если записывают ребёнка, обязательно уточняй возраст.
- Спроси коротко, есть ли уже танцевальный опыт.
- Спроси, что важнее: движение/общение, развитие пластики и координации, выступления и конкурсы и т.д.,
  но НЕ перегружай анкету — достаточно 1–2 уточняющих вопросов.
- На основе ответов предложи конкретные направления и группы по расписанию.

Поведение при непонятных вопросах:
- Сначала ПОПРОБУЙ логически ответить, опираясь на описание студии, направления и здравый смысл.
- Только если вопрос совсем не по теме или информации совсем недостаточно,
  можно ответить, что точного ответа нет и предложить переформулировать вопрос или написать администратору.
- Не злоупотребляй фразой про "техническую паузу". Вместо этого лучше скажи:
  "Кажется, у меня нет точного ответа на этот вопрос. Попробуйте переформулировать или уточнить, пожалуйста."

Формат ответов:
- Пиши простым, живым, вежливым языком, на ВЫ.
- Не выдавай сухие списки без пояснений — добавляй короткие комментарии.
- Если предлагаешь несколько групп, делай их списком с понятным указанием: филиал, возраст/уровень, дни и время.
`;

// добавляем текст расписания и, если нужно, knowledge.json
const SYSTEM_PROMPT = SYSTEM_PROMPT_BASE +
  (SCHEDULE_TEXT
    ? `\n\nНиже полное расписание филиалов CosmoDance. Используй его, когда подбираешь группы:\n${SCHEDULE_TEXT}\n`
    : "") +
  (KNOWLEDGE_JSON
    ? `\n\nТакже вот база вопросов и ответов по студии (используй её как справочник):\n${JSON.stringify(
        KNOWLEDGE_JSON,
        null,
        2
      )}\n`
    : "");

// ---------- Отдаём веб-страницу чата ----------

app.get("/", (req, res) => {
  res.sendFile(path.join(__dirname, "index.html"), {
    headers: { "Content-Type": "text/html; charset=utf-8" },
  });
});

// ---------- Основной чат ----------

app.post("/chat", async (req, res) => {
  try {
    const { userMessage, history } = req.body || {};

    if (!userMessage || typeof userMessage !== "string") {
      return res.status(400).json({
        reply: "Пожалуйста, напишите ваш вопрос или запрос по студии CosmoDance.",
      });
    }

    // История приходит с фронта как массив {role, content}
    const historyMessages = Array.isArray(history)
      ? history
          .filter(
            (m) =>
              m &&
              typeof m.role === "string" &&
              typeof m.content === "string" &&
              ["user", "assistant"].includes(m.role)
          )
          // ограничим последние 20 сообщений, чтобы не раздувать контекст
          .slice(-20)
      : [];

    const messages = [
      { role: "system", content: SYSTEM_PROMPT },
      ...historyMessages,
      { role: "user", content: userMessage },
    ];

    const completion = await client.chat.completions.create({
      model: "gpt-4.1-mini",
      messages,
      temperature: 0.5,
      max_tokens: 900,
    });

    const reply =
      completion.choices?.[0]?.message?.content?.trim() ||
      "Кажется, у меня не получилось сформировать ответ. Попробуйте переформулировать вопрос или уточнить, пожалуйста.";

    res.json({ reply });
  } catch (error) {
    console.error("Ошибка в /chat:", error);
    res.status(500).json({
      reply:
        "Кажется, у меня нет точного ответа или произошёл технический сбой. Попробуйте задать вопрос чуть иначе или свяжитесь с администратором студии.",
    });
  }
});

const port = process.env.PORT || 10000;
app.listen(port, () => {
  console.log(`CosmoDance server listening on port ${port}`);
});
