// server.js - CosmoDance Chat Bot v3.0 (–ü–æ–ª–Ω–∞—è –±–∞–∑–∞ –∑–Ω–∞–Ω–∏–π)
import express from "express";
import cors from "cors";
import dotenv from "dotenv";
import fs from "fs";
import path from "path";
import { fileURLToPath } from "url";

dotenv.config();

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// ============ –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ============
const app = express();
app.use(cors());
app.use(express.json({ limit: "100kb" }));
app.use(express.static(__dirname));

// ============ –ó–ê–ì–†–£–ó–ö–ê –ë–ê–ó–´ –ó–ù–ê–ù–ò–ô ============
function loadKnowledge() {
  try {
    const data = fs.readFileSync("knowledge.json", "utf8");
    return JSON.parse(data);
  } catch (error) {
    console.error("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ knowledge.json:", error.message);
    return { 
      docs: [],
      info: {
        website: "https://cosmo.su/",
        schedule_link: "https://cosmo.su/raspisanie/",
        prices_link: "https://cosmo.su/prices/",
        contacts_link: "https://cosmo.su/contacts/"
      }
    };
  }
}

const KNOWLEDGE = loadKnowledge();
console.log(`üìö –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${KNOWLEDGE.docs?.length || 0} –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π`);

// ============ –ü–û–ò–°–ö –í –ë–ê–ó–ï –ó–ù–ê–ù–ò–ô ============
function searchInKnowledge(query) {
  if (!KNOWLEDGE.docs || !Array.isArray(KNOWLEDGE.docs)) {
    return null;
  }
  
  const lowerQuery = query.toLowerCase();
  
  // –°–Ω–∞—á–∞–ª–∞ –∏—â–µ–º —Ç–æ—á–Ω—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –≤ –∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö
  const exactTitleMatch = KNOWLEDGE.docs.find(doc => 
    doc.title && doc.title.toLowerCase().includes(lowerQuery)
  );
  
  if (exactTitleMatch) {
    return exactTitleMatch;
  }
  
  // –ò—â–µ–º –≤ —Ç–µ–∫—Å—Ç–µ
  const textMatch = KNOWLEDGE.docs.find(doc => 
    doc.text && doc.text.toLowerCase().includes(lowerQuery)
  );
  
  if (textMatch) {
    return textMatch;
  }
  
  // –ò—â–µ–º –ø–æ —Ç–µ–≥–∞–º
  const tagMatch = KNOWLEDGE.docs.find(doc => 
    doc.tags && doc.tags.some(tag => 
      tag && tag.toLowerCase().includes(lowerQuery)
    )
  );
  
  if (tagMatch) {
    return tagMatch;
  }
  
  // –†–∞–∑–±–∏–≤–∞–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–ª–æ–≤–∞
  const queryWords = lowerQuery.split(' ').filter(word => word.length > 3);
  
  for (const doc of KNOWLEDGE.docs) {
    const docText = (doc.title + ' ' + doc.text + ' ' + (doc.tags?.join(' ') || '')).toLowerCase();
    const matchCount = queryWords.filter(word => docText.includes(word)).length;
    
    if (matchCount >= Math.max(1, queryWords.length / 2)) {
      return doc;
    }
  }
  
  return null;
}

// ============ –õ–û–ö–ê–õ–¨–ù–´–ï –û–¢–í–ï–¢–´ ============
const LOCAL_RESPONSES = {
  // –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è
  '–ø—Ä–∏–≤–µ—Ç': 'üëã –ü—Ä–∏–≤–µ—Ç! –Ø —á–∞—Ç-–±–æ—Ç —Å—Ç—É–¥–∏–∏ —Ç–∞–Ω—Ü–µ–≤ CosmoDance. –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?',
  '–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ': 'üëã –ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç —Å—Ç—É–¥–∏–∏ CosmoDance.',
  '–¥–æ–±—Ä—ã–π –¥–µ–Ω—å': 'üëã –î–æ–±—Ä—ã–π –¥–µ–Ω—å! –†–∞–¥ –≤–∞—Å –≤–∏–¥–µ—Ç—å –≤ —Å—Ç—É–¥–∏–∏ CosmoDance!',
  '–¥–æ–±—Ä–æ–µ —É—Ç—Ä–æ': 'üëã –î–æ–±—Ä–æ–µ —É—Ç—Ä–æ! –ì–æ—Ç–æ–≤ –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –≤–∞—à–∏ –≤–æ–ø—Ä–æ—Å—ã.',
  '–¥–æ–±—Ä—ã–π –≤–µ—á–µ—Ä': 'üëã –î–æ–±—Ä—ã–π –≤–µ—á–µ—Ä! –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?',
  'start': 'üéØ **–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ CosmoDance!**\n\n–Ø –ø–æ–º–æ–≥—É –≤–∞–º:\n‚Ä¢ –£–∑–Ω–∞—Ç—å —Ü–µ–Ω—ã –∏ –∞–±–æ–Ω–µ–º–µ–Ω—Ç—ã\n‚Ä¢ –ù–∞–π—Ç–∏ –±–ª–∏–∂–∞–π—à–∏–π —Ñ–∏–ª–∏–∞–ª\n‚Ä¢ –£–∑–Ω–∞—Ç—å –æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è—Ö\n‚Ä¢ –ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∑–∞–Ω—è—Ç–∏–µ\n\n–ß—Ç–æ –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç?',
  
  // –ë—ã—Å—Ç—Ä—ã–µ —Å—Å—ã–ª–∫–∏
  '—Å–∞–π—Ç': `üåê **–ù–∞—à —Å–∞–π—Ç:** ${KNOWLEDGE.info?.website || 'https://cosmo.su/'}\n–ó–¥–µ—Å—å –≤—Å—è –∞–∫—Ç—É–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è!`,
  '—Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ': `üìÖ **–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ:** ${KNOWLEDGE.info?.schedule_link || 'https://cosmo.su/raspisanie/'}\n\nüéØ **–í—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ –∞–∫—Ç—É–∞–ª—å–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ —Å–∞–π—Ç–µ!**`,
  '—Ü–µ–Ω—ã': `üí∞ **–¶–µ–Ω—ã –∏ –∞–±–æ–Ω–µ–º–µ–Ω—Ç—ã:**\n${KNOWLEDGE.info?.prices_link || 'https://cosmo.su/prices/'}\n\nüíé **–°–∞–º—ã–µ —Å–≤–µ–∂–∏–µ —Ü–µ–Ω—ã –∏ –∞–∫—Ü–∏–∏ —Ç–æ–ª—å–∫–æ –Ω–∞ —Å–∞–π—Ç–µ!**`,
  '–∫–æ–Ω—Ç–∞–∫—Ç—ã': `üìû **–ö–æ–Ω—Ç–∞–∫—Ç—ã –≤—Å–µ—Ö —Ñ–∏–ª–∏–∞–ª–æ–≤:**\n${KNOWLEDGE.info?.contacts_link || 'https://cosmo.su/contacts/'}`,
  
  // –§–∏–ª–∏–∞–ª—ã
  '—Ñ–∏–ª–∏–∞–ª—ã': 'üìç **–ù–∞—à–∏ —Ñ–∏–ª–∏–∞–ª—ã –≤ –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥–µ:**\n\n1. **–ó–≤—ë–∑–¥–Ω–∞—è** (–º. –ó–≤—ë–∑–¥–Ω–∞—è)\n2. **–î—ã–±–µ–Ω–∫–æ** (–º. –ü—Ä. –ë–æ–ª—å—à–µ–≤–∏–∫–æ–≤)\n3. **–ö—É–ø—á–∏–Ω–æ** (–º. –ö—É–ø—á–∏–Ω–æ)\n4. **–û–∑–µ—Ä–∫–∏** (–º. –û–∑–µ—Ä–∫–∏)\n\nüîó **–í—Å–µ –∞–¥—Ä–µ—Å–∞ –∏ –∫–æ–Ω—Ç–∞–∫—Ç—ã:** https://cosmo.su/contacts/',
  
  // –¶–ï–ù–´ (—Ç–æ—á–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π)
  '—Å–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç –ø—Ä–æ–±–Ω–æ–µ': 'üíé **–ü—Ä–æ–±–Ω–æ–µ –∑–∞–Ω—è—Ç–∏–µ:**\n\n‚Ä¢ –°—Ç–æ–∏–º–æ—Å—Ç—å: 400 ‚ÇΩ\n‚Ä¢ –≠—Ç–æ –ø–µ—Ä–≤–æ–µ –ø–æ—Å–µ—â–µ–Ω–∏–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è\n‚Ä¢ –ü—Ä–∏ –ø–æ–∫—É–ø–∫–µ –∞–±–æ–Ω–µ–º–µ–Ω—Ç–∞ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –ë–ï–°–ü–õ–ê–¢–ù–´–ú\n\nüéØ **–ò–¥–µ–∞–ª—å–Ω–æ, —á—Ç–æ–±—ã –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –ø–µ—Ä–µ–¥ –ø–æ–∫—É–ø–∫–æ–π –∞–±–æ–Ω–µ–º–µ–Ω—Ç–∞!**',
  
  '–ø—Ä–æ–±–Ω–æ–µ –∑–∞–Ω—è—Ç–∏–µ': 'üíé **–ü—Ä–æ–±–Ω–æ–µ –∑–∞–Ω—è—Ç–∏–µ:**\n\n‚Ä¢ –°—Ç–æ–∏–º–æ—Å—Ç—å: 400 ‚ÇΩ\n‚Ä¢ –ü–µ—Ä–≤–æ–µ –ø–æ—Å–µ—â–µ–Ω–∏–µ –ª—é–±–æ–≥–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è\n‚Ä¢ –ü—Ä–∏ –ø–æ–∫—É–ø–∫–µ –∞–±–æ–Ω–µ–º–µ–Ω—Ç–∞ ‚Äî –≤ –ø–æ–¥–∞—Ä–æ–∫ (–±–µ—Å–ø–ª–∞—Ç–Ω–æ)\n\nüéØ **–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º —Å–Ω–∞—á–∞–ª–∞ –ø–æ—Å–µ—Ç–∏—Ç—å –ø—Ä–æ–±–Ω–æ–µ!**',
  
  '—Ä–∞–∑–æ–≤–æ–µ –∑–∞–Ω—è—Ç–∏–µ': 'üé´ **–†–∞–∑–æ–≤–æ–µ –∑–∞–Ω—è—Ç–∏–µ:**\n\n‚Ä¢ –°—Ç–æ–∏–º–æ—Å—Ç—å: 900 ‚ÇΩ\n‚Ä¢ –†–∞–∑–æ–≤–æ–µ –ø–æ—Å–µ—â–µ–Ω–∏–µ –±–µ–∑ –∞–±–æ–Ω–µ–º–µ–Ω—Ç–∞\n‚Ä¢ –ò–¥–µ–∞–ª—å–Ω–æ, –µ—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ –ø—Ä–æ—Å—Ç–æ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å\n\nüí° **–í—ã–≥–æ–¥–Ω–µ–µ –∫—É–ø–∏—Ç—å –∞–±–æ–Ω–µ–º–µ–Ω—Ç!**',
  
  '–∞–±–æ–Ω–µ–º–µ–Ω—Ç –Ω–∞ –º–µ—Å—è—Ü': 'üìÖ **–ê–±–æ–Ω–µ–º–µ–Ω—Ç—ã –Ω–∞ 1 –º–µ—Å—è—Ü:**\n\n**–ù–∞ 60 –º–∏–Ω—É—Ç:**\n‚Ä¢ 4 –∑–∞–Ω—è—Ç–∏—è ‚Äî 3 290 ‚ÇΩ\n‚Ä¢ 8 –∑–∞–Ω—è—Ç–∏–π ‚Äî 4 990 ‚ÇΩ\n‚Ä¢ –ë–µ–∑–ª–∏–º–∏—Ç ‚Äî 11 500 ‚ÇΩ\n\n**–ù–∞ 85 –º–∏–Ω—É—Ç:**\n‚Ä¢ 4 –∑–∞–Ω—è—Ç–∏—è ‚Äî 3 950 ‚ÇΩ\n‚Ä¢ 8 –∑–∞–Ω—è—Ç–∏–π ‚Äî 6 500 ‚ÇΩ\n\nüíé **–ü—Ä–∏ –ø–æ–∫—É–ø–∫–µ –ø—Ä–æ–±–Ω–æ–µ –∑–∞–Ω—è—Ç–∏–µ –±–µ—Å–ø–ª–∞—Ç–Ω–æ!**',
  
  '–∞–±–æ–Ω–µ–º–µ–Ω—Ç –Ω–∞ 8 –∑–∞–Ω—è—Ç–∏–π': 'üìä **–ê–±–æ–Ω–µ–º–µ–Ω—Ç –Ω–∞ 8 –∑–∞–Ω—è—Ç–∏–π:**\n\n**–ù–∞ 60 –º–∏–Ω—É—Ç:**\n‚Ä¢ 8 –∑–∞–Ω—è—Ç–∏–π ‚Äî 4 990 ‚ÇΩ\n‚Ä¢ –°—Ä–æ–∫: 1 –º–µ—Å—è—Ü\n\n**–ù–∞ 85 –º–∏–Ω—É—Ç:**\n‚Ä¢ 8 –∑–∞–Ω—è—Ç–∏–π ‚Äî 6 500 ‚ÇΩ\n‚Ä¢ –°—Ä–æ–∫: 1 –º–µ—Å—è—Ü\n\nüéØ **–°–∞–º—ã–π –ø–æ–ø—É–ª—è—Ä–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç!**',
  
  '—Å–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç –∞–±–æ–Ω–µ–º–µ–Ω—Ç': 'üí∞ **–ê–±–æ–Ω–µ–º–µ–Ω—Ç—ã CosmoDance:**\n\n**–ù–∞ 60 –º–∏–Ω—É—Ç (1 —á–∞—Å):**\n‚Ä¢ 4 –∑–∞–Ω—è—Ç–∏—è ‚Äî 3 290 ‚ÇΩ (1 –º–µ—Å—è—Ü)\n‚Ä¢ 8 –∑–∞–Ω—è—Ç–∏–π ‚Äî 4 990 ‚ÇΩ (1 –º–µ—Å—è—Ü)\n‚Ä¢ 12 –∑–∞–Ω—è—Ç–∏–π ‚Äî 6 500 ‚ÇΩ (1 –º–µ—Å—è—Ü)\n‚Ä¢ 12 –∑–∞–Ω—è—Ç–∏–π ‚Äî 7 200 ‚ÇΩ (2 –º–µ—Å—è—Ü–∞)\n‚Ä¢ 24 –∑–∞–Ω—è—Ç–∏—è ‚Äî 12 590 ‚ÇΩ (3,5 –º–µ—Å—è—Ü–∞)\n‚Ä¢ 48 –∑–∞–Ω—è—Ç–∏–π ‚Äî 22 900 ‚ÇΩ (6,5 –º–µ—Å—è—Ü–∞)\n‚Ä¢ –ë–µ–∑–ª–∏–º–∏—Ç ‚Äî 11 500 ‚ÇΩ (1 –º–µ—Å—è—Ü)\n\n**–ù–∞ 85 –º–∏–Ω—É—Ç (1,5 —á–∞—Å–∞):**\n‚Ä¢ 4 –∑–∞–Ω—è—Ç–∏—è ‚Äî 3 950 ‚ÇΩ (1 –º–µ—Å—è—Ü)\n‚Ä¢ 8 –∑–∞–Ω—è—Ç–∏–π ‚Äî 6 500 ‚ÇΩ (1 –º–µ—Å—è—Ü)\n‚Ä¢ 12 –∑–∞–Ω—è—Ç–∏–π ‚Äî 9 200 ‚ÇΩ (2 –º–µ—Å—è—Ü–∞)\n‚Ä¢ 24 –∑–∞–Ω—è—Ç–∏—è ‚Äî 17 200 ‚ÇΩ (3,5 –º–µ—Å—è—Ü–∞)\n‚Ä¢ 48 –∑–∞–Ω—è—Ç–∏–π ‚Äî 31 650 ‚ÇΩ (6,5 –º–µ—Å—è—Ü–∞)\n\nüíé **–ü—Ä–æ–±–Ω–æ–µ –∑–∞–Ω—è—Ç–∏–µ: 400 ‚ÇΩ (–±–µ—Å–ø–ª–∞—Ç–Ω–æ –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ –∞–±–æ–Ω–µ–º–µ–Ω—Ç–∞)**',
  
  '–±–µ–∑–ª–∏–º–∏—Ç': '‚àû **–ë–µ–∑–ª–∏–º–∏—Ç–Ω—ã–π –∞–±–æ–Ω–µ–º–µ–Ω—Ç:**\n\n‚Ä¢ –°—Ç–æ–∏–º–æ—Å—Ç—å: 11 500 ‚ÇΩ\n‚Ä¢ –°—Ä–æ–∫: 1 –º–µ—Å—è—Ü\n‚Ä¢ –ù–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Å–µ—â–µ–Ω–∏–π\n\nüéØ **–ò–¥–µ–∞–ª—å–Ω–æ, –µ—Å–ª–∏ –ø–ª–∞–Ω–∏—Ä—É–µ—Ç–µ —Ö–æ–¥–∏—Ç—å —á–∞—â–µ 3 —Ä–∞–∑ –≤ –Ω–µ–¥–µ–ª—é!**',
  
  '–∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–µ –∑–∞–Ω—è—Ç–∏–µ': 'üë§ **–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –∑–∞–Ω—è—Ç–∏—è:**\n\n‚Ä¢ –°—Ç–æ–∏–º–æ—Å—Ç—å: –æ—Ç 2 200 ‚ÇΩ\n‚Ä¢ –¶–µ–Ω–∞ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏ —Ö–æ—Ä–µ–æ–≥—Ä–∞—Ñ–∞\n‚Ä¢ –¢–æ—á–Ω—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å —Å–æ–æ–±—â–∞–µ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä\n\nüíé **–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç!**',
  
  '–∞–±–æ–Ω–µ–º–µ–Ω—Ç –¥–ª—è —Ä–µ–±–µ–Ω–∫–∞': 'üëß **–ê–±–æ–Ω–µ–º–µ–Ω—Ç—ã –¥–ª—è –¥–µ—Ç–µ–π:**\n\n‚Ä¢ –¶–µ–Ω—ã —Ç–∞–∫–∏–µ –∂–µ, –∫–∞–∫ –¥–ª—è –≤–∑—Ä–æ—Å–ª—ã—Ö\n‚Ä¢ –ü—Ä–∏ –ø–æ–∫—É–ø–∫–µ –∞–±–æ–Ω–µ–º–µ–Ω—Ç–∞ —Ä–µ–±—ë–Ω–∫—É –¥–∞—Ä–∏—Ç—Å—è –¥–Ω–µ–≤–Ω–∏–∫ —Ç–∞–Ω—Ü–æ—Ä–∞\n\n**–ù–∞ 60 –º–∏–Ω—É—Ç:**\n‚Ä¢ 4 –∑–∞–Ω—è—Ç–∏—è ‚Äî 3 290 ‚ÇΩ\n‚Ä¢ 8 –∑–∞–Ω—è—Ç–∏–π ‚Äî 4 990 ‚ÇΩ\n‚Ä¢ 12 –∑–∞–Ω—è—Ç–∏–π ‚Äî 6 500 ‚ÇΩ\n\nüéÅ **–°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –ø–æ–¥–∞—Ä–æ–∫ –¥–ª—è –¥–µ—Ç–µ–π!**',
  
  '–ø—Ä–æ–¥–ª–∏—Ç—å –∞–±–æ–Ω–µ–º–µ–Ω—Ç': '‚è∞ **–ü—Ä–æ–¥–ª–µ–Ω–∏–µ –∞–±–æ–Ω–µ–º–µ–Ω—Ç–∞:**\n\n–î–∞, –∞–±–æ–Ω–µ–º–µ–Ω—Ç –º–æ–∂–Ω–æ –ø—Ä–æ–¥–ª–∏—Ç—å –ø—Ä–∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–∏:\n‚Ä¢ –ú–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–π —Å–ø—Ä–∞–≤–∫–∏\n‚Ä¢ –ë–æ–ª—å–Ω–∏—á–Ω–æ–≥–æ –ª–∏—Å—Ç–∞\n\nüìû **–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –¥–ª—è –ø—Ä–æ–¥–ª–µ–Ω–∏—è.**',
  
  '—Å–∫–æ–ª—å–∫–æ –¥–ª–∏—Ç—Å—è –∑–∞–Ω—è—Ç–∏–µ': '‚è±Ô∏è **–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∑–∞–Ω—è—Ç–∏–π:**\n\n‚Ä¢ –ß–∞—Å–æ–≤–æ–µ –∑–∞–Ω—è—Ç–∏–µ = 60 –º–∏–Ω—É—Ç\n‚Ä¢ –ü–æ–ª—É—Ç–æ—Ä–∞—á–∞—Å–æ–≤–æ–µ –∑–∞–Ω—è—Ç–∏–µ = 85 –º–∏–Ω—É—Ç\n\nüéØ **–£—Ç–æ—á–Ω—è–π—Ç–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —É –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è!**',
  
  '–≤—Å–µ —Ü–µ–Ω—ã –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ': '‚úÖ **–ï–¥–∏–Ω—ã–µ —Ü–µ–Ω—ã:**\n\n–î–∞, –≤—Å–µ —Ü–µ–Ω—ã –æ–¥–∏–Ω–∞–∫–æ–≤—ã –¥–ª—è –≤—Å–µ—Ö –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π —Å—Ç—É–¥–∏–∏ CosmoDance.\n–ù–µ—Ç —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –ø–æ —Å—Ç–∏–ª—è–º —Ç–∞–Ω—Ü–∞.\n\nüí∞ **–û–¥–Ω–∞ —Ü–µ–Ω–∞ –¥–ª—è –≤—Å–µ—Ö –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π!**',
  
  // –§–∏–ª–∏–∞–ª—ã —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
  '–∑–≤–µ–∑–¥–Ω': 'üìç **–§–∏–ª–∏–∞–ª –Ω–∞ –ó–≤—ë–∑–¥–Ω–æ–π:**\n\nüöá **–ú–µ—Ç—Ä–æ:** –ó–≤—ë–∑–¥–Ω–∞—è\n‚Ä¢ 5-7 –º–∏–Ω—É—Ç –ø–µ—à–∫–æ–º –æ—Ç –º–µ—Ç—Ä–æ\n‚Ä¢ –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –∑–∞–ª—ã\n‚Ä¢ –†–∞–∑–¥–µ–≤–∞–ª–∫–∏ –∏ –¥—É—à–µ–≤—ã–µ\n‚Ä¢ –í—Å–µ –≥—Ä—É–ø–ø—ã –¥–ª—è –Ω–∞—á–∏–Ω–∞—é—â–∏—Ö\n\nüîó **–¢–æ—á–Ω—ã–π –∞–¥—Ä–µ—Å:** https://cosmo.su/contacts/#zvezdnaya',
  
  '–¥—ã–±–µ–Ω–∫': 'üìç **–§–∏–ª–∏–∞–ª –Ω–∞ –î—ã–±–µ–Ω–∫–æ:**\n\nüöá **–ú–µ—Ç—Ä–æ:** –ü—Ä–æ—Å–ø–µ–∫—Ç –ë–æ–ª—å—à–µ–≤–∏–∫–æ–≤\n‚Ä¢ –£–¥–æ–±–Ω–æ–µ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ\n‚Ä¢ –ë–æ–ª—å—à–∏–µ –∑–∞–ª—ã\n‚Ä¢ –ü–∞—Ä–∫–æ–≤–∫–∞ —Ä—è–¥–æ–º\n\nüîó **–¢–æ—á–Ω—ã–π –∞–¥—Ä–µ—Å:** https://cosmo.su/contacts/#dybenko',
  
  '–∫—É–ø—á–∏–Ω': 'üìç **–§–∏–ª–∏–∞–ª –≤ –ö—É–ø—á–∏–Ω–æ:**\n\nüöá **–ú–µ—Ç—Ä–æ:** –ö—É–ø—á–∏–Ω–æ\n‚Ä¢ –°–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ\n‚Ä¢ –ö–æ–º—Ñ–æ—Ä—Ç–Ω—ã–µ —Ä–∞–∑–¥–µ–≤–∞–ª–∫–∏\n‚Ä¢ –ó–æ–Ω–∞ –æ—Ç–¥—ã—Ö–∞\n\nüîó **–¢–æ—á–Ω—ã–π –∞–¥—Ä–µ—Å:** https://cosmo.su/contacts/#kupchino',
  
  '–æ–∑–µ—Ä–∫': 'üìç **–§–∏–ª–∏–∞–ª –≤ –û–∑–µ—Ä–∫–∞—Ö:**\n\nüöá **–ú–µ—Ç—Ä–æ:** –û–∑–µ—Ä–∫–∏\n‚Ä¢ –°–≤–µ—Ç–ª—ã–µ –∑–∞–ª—ã\n‚Ä¢ –ù–æ–≤—ã–µ –∑–µ—Ä–∫–∞–ª–∞\n‚Ä¢ –°–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –≤–µ–Ω—Ç–∏–ª—è—Ü–∏—è\n\nüîó **–¢–æ—á–Ω—ã–π –∞–¥—Ä–µ—Å:** https://cosmo.su/contacts/#ozerki',
  
  // –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏ –æ–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
  '–Ω–∞—á–∞—Ç—å': 'üéØ **–ö–∞–∫ –Ω–∞—á–∞—Ç—å —Ç–∞–Ω—Ü–µ–≤–∞—Ç—å –≤ CosmoDance:**\n\n1. **–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ** –∫–æ—Ç–æ—Ä–æ–µ –≤–∞–º –Ω—Ä–∞–≤–∏—Ç—Å—è\n2. **–ù–∞–π–¥–∏—Ç–µ –±–ª–∏–∂–∞–π—à–∏–π —Ñ–∏–ª–∏–∞–ª**\n3. **–ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ** –¥–ª—è –Ω–∞—á–∏–Ω–∞—é—â–∏—Ö\n4. **–ó–∞–ø–∏—à–∏—Ç–µ—Å—å –Ω–∞ –ø—Ä–æ–±–Ω–æ–µ –∑–∞–Ω—è—Ç–∏–µ** (400 ‚ÇΩ)\n5. **–ü—Ä–∏—Ö–æ–¥–∏—Ç–µ –≤ —É–¥–æ–±–Ω–æ–π –æ–¥–µ–∂–¥–µ**\n\nüìÖ **–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ:** https://cosmo.su/raspisanie/\nüí∞ **–¶–µ–Ω—ã:** https://cosmo.su/prices/',
  
  '–Ω–æ–≤–∏—á–æ–∫': 'üéØ **–î–ª—è –Ω–æ–≤–∏—á–∫–æ–≤:**\n\n‚úÖ **–ù–µ –Ω—É–∂–Ω–æ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏** ‚Äî –≤—Å–µ –Ω–∞—á–∏–Ω–∞—é—Ç —Å –Ω—É–ª—è!\n‚úÖ **–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥** –∫ –∫–∞–∂–¥–æ–º—É\n‚úÖ **–î—Ä—É–∂–µ–ª—é–±–Ω–∞—è –∞—Ç–º–æ—Å—Ñ–µ—Ä–∞**\n‚úÖ **–û–ø—ã—Ç–Ω—ã–µ —Ç—Ä–µ–Ω–µ—Ä—ã**\n\nüî• **–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–ª—è –Ω–∞—á–∏–Ω–∞—é—â–∏—Ö:**\n‚Ä¢ Hip-Hop\n‚Ä¢ Jazz Funk\n‚Ä¢ Contemporary\n‚Ä¢ High Heels\n‚Ä¢ Latina\n\nüìÖ **–í—ã–±–µ—Ä–∏—Ç–µ –∏ –ø—Ä–∏—Ö–æ–¥–∏—Ç–µ!**',
  
  '–∑–∞–ø–∏—Å–∞—Ç—å—Å—è': 'üìù **–ö–∞–∫ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è:**\n\n**–°–ø–æ—Å–æ–±—ã –∑–∞–ø–∏—Å–∏:**\n1. **–ù–∞ —Å–∞–π—Ç–µ** —á–µ—Ä–µ–∑ —Ñ–æ—Ä–º—É –∑–∞–ø–∏—Å–∏\n2. **–ü–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É** —Ñ–∏–ª–∏–∞–ª–∞\n3. **–í —Å–æ—Ü—Å–µ—Ç—è—Ö** —Å—Ç—É–¥–∏–∏\n4. **–õ–∏—á–Ω–æ** –≤ —Å—Ç—É–¥–∏–∏\n\nüéØ **–ü–µ—Ä–µ–¥ –∑–∞–ø–∏—Å—å—é:**\n‚Ä¢ –ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ\n‚Ä¢ –í—ã–±–µ—Ä–∏—Ç–µ —É–¥–æ–±–Ω—ã–π —Ñ–∏–ª–∏–∞–ª\n‚Ä¢ –û–ø—Ä–µ–¥–µ–ª–∏—Ç–µ—Å—å —Å –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º\n\nüîó **–§–æ—Ä–º–∞ –∑–∞–ø–∏—Å–∏ –Ω–∞ —Å–∞–π—Ç–µ:** https://cosmo.su/',
  
  '–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω': 'üíÉ **–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–∞–Ω—Ü–µ–≤:**\n\nüéØ **–î–ª—è –Ω–∞—á–∏–Ω–∞—é—â–∏—Ö –¥–æ—Å—Ç—É–ø–Ω—ã:**\n‚Ä¢ Hip-Hop (—Ö–∏–ø-—Ö–æ–ø)\n‚Ä¢ Jazz Funk (–¥–∂–∞–∑-—Ñ–∞–Ω–∫)\n‚Ä¢ Contemporary (–∫–æ–Ω—Ç–µ–º–ø–æ—Ä–∞—Ä–∏)\n‚Ä¢ High Heels (–≤—ã—Å–æ–∫–∏–µ –∫–∞–±–ª—É–∫–∏)\n‚Ä¢ Latina (–ª–∞—Ç–∏–Ω–∞)\n‚Ä¢ Twerk (—Ç–≤–µ—Ä–∫)\n‚Ä¢ Strip Dance (—Å—Ç—Ä–∏–ø-–ø–ª–∞—Å—Ç–∏–∫–∞)\n‚Ä¢ Break Dance (–±—Ä–µ–π–∫-–¥–∞–Ω—Å)\n\nüîó **–í—Å–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è:** https://cosmo.su/directions/',
  
  '—á—Ç–æ –Ω—É–∂–Ω–æ': 'üéí **–î–ª—è –ø–µ—Ä–≤–æ–≥–æ –∑–∞–Ω—è—Ç–∏—è:**\n\n1. **–û–¥–µ–∂–¥–∞:** —É–¥–æ–±–Ω–∞—è, –Ω–µ —Å–∫–æ–≤—ã–≤–∞—é—â–∞—è\n2. **–û–±—É–≤—å:** —á–µ—à–∫–∏, –∫—Ä–æ—Å—Å–æ–≤–∫–∏ –∏–ª–∏ –Ω–æ—Å–∫–∏\n3. **–í–æ–¥–∞:** –±—É—Ç—ã–ª–∫–∞ —Å –≤–æ–¥–æ–π\n4. **–ü–æ–ª–æ—Ç–µ–Ω—Ü–µ:** –ø–æ –∂–µ–ª–∞–Ω–∏—é\n5. **–•–æ—Ä–æ—à–µ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ!**\n\nüíé **–í—Å–µ –æ—Å—Ç–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Å—Ç—É–¥–∏—è.**',
  
  '—Ç—Ä–µ–Ω–µ—Ä': 'üë®‚Äçüè´ **–ù–∞—à–∏ —Ç—Ä–µ–Ω–µ—Ä—ã:**\n\n‚Ä¢ –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ö–æ—Ä–µ–æ–≥—Ä–∞—Ñ—ã\n‚Ä¢ –û–ø—ã—Ç —Ä–∞–±–æ—Ç—ã –æ—Ç 5 –ª–µ—Ç\n‚Ä¢ –£—á–∞—Å—Ç–∏–µ –≤ —á–µ–º–ø–∏–æ–Ω–∞—Ç–∞—Ö\n‚Ä¢ –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –∫ –Ω–æ–≤–∏—á–∫–∞–º\n\nüî• **–í—Å–µ —Ç—Ä–µ–Ω–µ—Ä—ã —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—Ç—Å—è –Ω–∞ —Ä–∞–±–æ—Ç–µ —Å –Ω–∞—á–∏–Ω–∞—é—â–∏–º–∏!**\nüîó **–ü–æ–¥—Ä–æ–±–Ω–µ–µ:** https://cosmo.su/trainers/'
};

// ============ –ú–ê–†–®–†–£–¢–´ API ============

// –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞
app.get("/", (req, res) => {
  res.sendFile(path.join(__dirname, "index.html"));
});

// –ß–∞—Ç —Å –±–æ—Ç–æ–º
app.post("/chat", async (req, res) => {
  try {
    const { message } = req.body;
    const userMessage = (message || "").trim();
    
    if (!userMessage) {
      return res.json({
        reply: "üëã –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å –æ —Å—Ç—É–¥–∏–∏ CosmoDance."
      });
    }

    console.log(`üì® –ó–∞–ø—Ä–æ—Å: "${userMessage}"`);
    
    const lowerMessage = userMessage.toLowerCase();
    
    // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
    for (const [key, response] of Object.entries(LOCAL_RESPONSES)) {
      if (lowerMessage.includes(key) && key.length > 3) {
        console.log(`‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –¥–ª—è: ${key}`);
        return res.json({ 
          reply: response,
          source: "local_response"
        });
      }
    }
    
    // 2. –ò—â–µ–º –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π
    const knowledgeMatch = searchInKnowledge(userMessage);
    if (knowledgeMatch) {
      console.log(`‚úÖ –ù–∞–π–¥–µ–Ω–æ –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π: ${knowledgeMatch.title}`);
      
      let response = '';
      
      // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
      switch (knowledgeMatch.category) {
        case 'prices':
          response = `üí∞ **${knowledgeMatch.title}**\n\n${knowledgeMatch.text}\n\n`;
          response += `üíé **–ê–∫—Ç—É–∞–ª—å–Ω—ã–µ —Ü–µ–Ω—ã –≤—Å–µ–≥–¥–∞ –Ω–∞ —Å–∞–π—Ç–µ:** ${KNOWLEDGE.info?.prices_link || 'https://cosmo.su/prices/'}`;
          break;
          
        case 'branches':
          response = `üìç **${knowledgeMatch.title}**\n\n${knowledgeMatch.text}\n\n`;
          response += `üìû **–ö–æ–Ω—Ç–∞–∫—Ç—ã –∏ —Ç–æ—á–Ω—ã–π –∞–¥—Ä–µ—Å:** ${KNOWLEDGE.info?.contacts_link || 'https://cosmo.su/contacts/'}`;
          break;
          
        case 'schedule':
          response = `üìÖ **${knowledgeMatch.title}**\n\n${knowledgeMatch.text}\n\n`;
          response += `üéØ **–ê–∫—Ç—É–∞–ª—å–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ:** ${KNOWLEDGE.info?.schedule_link || 'https://cosmo.su/raspisanie/'}`;
          break;
          
        default:
          response = `üéØ **${knowledgeMatch.title}**\n\n${knowledgeMatch.text}`;
          if (knowledgeMatch.category === 'directions') {
            response += `\n\nüîó **–í—Å–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è:** ${KNOWLEDGE.info?.directions_link || 'https://cosmo.su/directions/'}`;
          }
      }
      
      return res.json({
        reply: response,
        source: "knowledge_base"
      });
    }
    
    // 3. –û–±—â–∏–π –æ—Ç–≤–µ—Ç —Å —Å—Å—ã–ª–∫–∞–º–∏
    const generalResponse = `üéØ **–°—Ç—É–¥–∏—è —Ç–∞–Ω—Ü–µ–≤ CosmoDance**\n\n` +
      `–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, —è –Ω–µ –Ω–∞—à–µ–ª —Ç–æ—á–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π.\n\n` +
      `**–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å –ø–æ-–¥—Ä—É–≥–æ–º—É:**\n` +
      `‚Ä¢ "–°–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç –ø—Ä–æ–±–Ω–æ–µ –∑–∞–Ω—è—Ç–∏–µ?"\n` +
      `‚Ä¢ "–ö–∞–∫–∏–µ –∞–±–æ–Ω–µ–º–µ–Ω—Ç—ã –µ—Å—Ç—å –Ω–∞ 8 –∑–∞–Ω—è—Ç–∏–π?"\n` +
      `‚Ä¢ "–ö–∞–∫ –¥–æ–±—Ä–∞—Ç—å—Å—è –¥–æ —Ñ–∏–ª–∏–∞–ª–∞ –Ω–∞ –ó–≤—ë–∑–¥–Ω–æ–π?"\n` +
      `‚Ä¢ "–ö–∞–∫–∏–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –µ—Å—Ç—å –¥–ª—è –Ω–∞—á–∏–Ω–∞—é—â–∏—Ö?"\n\n` +
      `üìÖ **–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ:** ${KNOWLEDGE.info?.schedule_link || 'https://cosmo.su/raspisanie/'}\n` +
      `üí∞ **–¶–µ–Ω—ã:** ${KNOWLEDGE.info?.prices_link || 'https://cosmo.su/prices/'}\n` +
      `üìç **–ö–æ–Ω—Ç–∞–∫—Ç—ã:** ${KNOWLEDGE.info?.contacts_link || 'https://cosmo.su/contacts/'}`;
    
    return res.json({
      reply: generalResponse,
      source: "general_info"
    });

  } catch (error) {
    console.error("‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–∞:", error.message);
    
    res.json({ 
      reply: `üéØ **–°—Ç—É–¥–∏—è —Ç–∞–Ω—Ü–µ–≤ CosmoDance**\n\n` +
             `üìç **–§–∏–ª–∏–∞–ª—ã:** –ó–≤—ë–∑–¥–Ω–∞—è, –î—ã–±–µ–Ω–∫–æ, –ö—É–ø—á–∏–Ω–æ, –û–∑–µ—Ä–∫–∏\n` +
             `üìÖ **–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ:** ${KNOWLEDGE.info?.schedule_link || 'https://cosmo.su/raspisanie/'}\n` +
             `üí∞ **–¶–µ–Ω—ã:** ${KNOWLEDGE.info?.prices_link || 'https://cosmo.su/prices/'}\n` +
             `üåê **–°–∞–π—Ç:** ${KNOWLEDGE.info?.website || 'https://cosmo.su/'}\n\n` +
             `üìû **–°–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∞–º–∏ –¥–ª—è –∑–∞–ø–∏—Å–∏ –∏ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏.**`,
      error: true,
      source: "error_fallback"
    });
  }
});

// –ü—Ä–æ—Å–º–æ—Ç—Ä –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
app.get("/api/knowledge", (req, res) => {
  const { search, category } = req.query;
  
  let results = KNOWLEDGE.docs || [];
  
  if (search) {
    results = results.filter(doc => 
      doc.title.toLowerCase().includes(search.toLowerCase()) ||
      doc.text.toLowerCase().includes(search.toLowerCase()) ||
      (doc.tags && doc.tags.some(tag => tag.toLowerCase().includes(search.toLowerCase())))
    );
  }
  
  if (category) {
    results = results.filter(doc => doc.category === category);
  }
  
  res.json({
    search,
    category,
    total_docs: KNOWLEDGE.docs?.length || 0,
    count: results.length,
    results: results.map(doc => ({
      id: doc.id,
      title: doc.title,
      category: doc.category,
      tags: doc.tags,
      excerpt: doc.text.substring(0, 100) + (doc.text.length > 100 ? '...' : '')
    }))
  });
});

// –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π
app.get("/api/categories", (req, res) => {
  const categories = [...new Set(KNOWLEDGE.docs?.map(d => d.category).filter(Boolean))];
  res.json({
    categories,
    count: categories.length
  });
});

// –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
app.get("/health", (req, res) => {
  const categories = [...new Set(KNOWLEDGE.docs?.map(d => d.category).filter(Boolean))];
  
  res.json({
    status: "healthy",
    service: "CosmoDance Chat Bot",
    version: "3.0",
    timestamp: new Date().toISOString(),
    last_updated: KNOWLEDGE.last_updated,
    knowledge_base: {
      total_docs: KNOWLEDGE.docs?.length || 0,
      categories: categories,
      categories_count: categories.length
    },
    features: {
      local_responses: Object.keys(LOCAL_RESPONSES).length,
      knowledge_search: true,
      no_external_dependencies: true
    },
    links: KNOWLEDGE.info
  });
});

// –ê–¥–º–∏–Ω: –¥–æ–±–∞–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç –≤ –±–∞–∑—É –∑–Ω–∞–Ω–∏–π
app.post("/api/knowledge/add", (req, res) => {
  try {
    const { title, text, category, tags } = req.body;
    
    if (!title || !text) {
      return res.status(400).json({ error: "–¢—Ä–µ–±—É—é—Ç—Å—è title –∏ text" });
    }
    
    const newDoc = {
      id: `doc_${Date.now()}`,
      title,
      text,
      category: category || "general",
      tags: tags || [],
      created_at: new Date().toISOString()
    };
    
    KNOWLEDGE.docs.push(newDoc);
    KNOWLEDGE.last_updated = new Date().toISOString();
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Ñ–∞–π–ª
    fs.writeFileSync(
      path.join(__dirname, "knowledge.json"),
      JSON.stringify(KNOWLEDGE, null, 2)
    );
    
    res.json({
      success: true,
      message: "–î–æ–∫—É–º–µ–Ω—Ç –¥–æ–±–∞–≤–ª–µ–Ω",
      doc: newDoc
    });
    
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

// ============ –ó–ê–ü–£–°–ö –°–ï–†–í–ï–†–ê ============
const port = process.env.PORT || 10000;
const host = process.env.HOST || '0.0.0.0';

app.listen(port, host, () => {
  console.log("=".repeat(60));
  console.log("üöÄ CosmoDance Chat Bot v3.0 –ó–ê–ü–£–©–ï–ù!");
  console.log(`üìç –ü–æ—Ä—Ç: ${port}`);
  console.log(`üåê –•–æ—Å—Ç: ${host}`);
  console.log(`üîó URL: http://${host}:${port}`);
  console.log(`üìö –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π: ${KNOWLEDGE.docs?.length || 0} –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤`);
  console.log(`üí∞ –ö–∞—Ç–µ–≥–æ—Ä–∏–∏: ${[...new Set(KNOWLEDGE.docs?.map(d => d.category).filter(Boolean))].join(', ')}`);
  console.log("=".repeat(60));
  console.log("‚úÖ –ë–æ—Ç –≥–æ—Ç–æ–≤ –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ —Ü–µ–Ω–∞—Ö, —Ñ–∏–ª–∏
