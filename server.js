// server.js
// ESM-версия сервера для Render + OpenAI + база знаний Cosmo Dance

import express from "express";

const app = express();
app.use(express.json());

const PORT = process.env.PORT || 10000;
const OPENAI_API_KEY = process.env.OPENAI_API_KEY;

// ================== БАЗА ЗНАНИЙ COSMO DANCE ==================

export const KNOWLEDGE_BASE = {
  meta: {
    persona: "дружелюбный живой человек, не робот",
    addressForm: "вы", // всегда обращаемся на «Вы»
    style:
      "спокойно, по-доброму, с поддержкой и объяснением, что танцы доступны каждому",
    goal:
      "не просто информировать, а успокаивать, вдохновлять и мягко мотивировать прийти на пробное занятие"
  },

  // --- Общая информация о студии ---
  studio: {
    shortDescription:
      "Cosmo Dance — сеть студий танцев в Санкт-Петербурге. Работаем с 2015 года, учим танцевать детей и взрослых с любым уровнем подготовки.",
    history: [
      "Первый филиал Cosmo Dance был открыт в октябре 2015 года у метро «Улица Дыбенко».",
      "С тех пор сеть студий выросла и включает несколько филиалов в разных районах города."
    ],
    philosophy:
      "Мы верим, что танцевать может каждый, независимо от возраста, телосложения и опыта. Важнее не идеальная растяжка, а желание двигаться и получать удовольствие.",
    promise: [
      "Мы бережно относимся к новичкам: занятия построены так, чтобы человек чувствовал себя спокойно, а не «неуклюже».",
      "Уже за несколько занятий человек начинает лучше чувствовать ритм, становится увереннее и понимает, что действительно может научиться танцевать."
    ]
  },

  // --- Филиалы ---
  branches: {
    dybenko: {
      name: "Филиал «Дыбенко»",
      address:
        "м. «Улица Дыбенко», пр. Большевиков, д. 18, корп. 2 (ТРК «Невский 2», 6 этаж)",
      metro: "Улица Дыбенко",
      halls: 3,
      dressingRooms: 5,
      waitingArea:
        "Большой холл с удобной зоной ожидания и мониторами, на которые транслируются занятия из залов.",
      parking:
        "Есть платный паркинг ТРК и бесплатная уличная парковка рядом с торговым центром.",
      howToGetShort:
        "От метро «Улица Дыбенко» до ТРК «Невский» несколько минут пешком.",
      howToGetDetailed: [
        "У метро «Улица Дыбенко» ориентир — торговый центр «Невский». У него два корпуса: старый двухэтажный и новый шестиэтажный.",
        "Студия находится именно в новом шестиэтажном корпусе, который стоит чуть дальше и правее относительно первого.",
        "Заходите в торговый центр через крутящуюся дверь. Перед вами будут эскалаторы, чуть левее — лифт.",
        "Проще всего подняться на лифте на 6 этаж. Выйдя из лифта, идите прямо — Вы увидите множество вывесок «Школа танцев Cosmo Dance»."
      ]
    },

    zvezdnaya: {
      name: "Филиал «Звёздная»",
      address: "м. «Звёздная», пр. Юрия Гагарина, д. 42",
      metro: "Звёздная",
      halls: 4,
      dressingRooms: 4,
      waitingArea:
        "Уютный холл с зоной ожидания и мониторами с трансляцией занятий.",
      building:
        "Двухэтажное здание, в котором также расположена «Пятёрочка». Студия на первом этаже.",
      howToGetDetailed: [
        "Ориентир — магазин «Пятёрочка» по адресу проспект Юрия Гагарина, 42.",
        "Если стоять лицом к «Пятёрочке», слева будет крыльцо и два входа в здание.",
        "Рядом Вы увидите вывески студии танцев — заходите через этот вход, внутри Вас встретит администратор Cosmo Dance."
      ]
    },

    kupchino: {
      name: "Филиал «Купчино»",
      address: "м. «Купчино», Балканская площадь, д. 5 лит. Я (ТЦ «Балканский-3», 4 этаж)",
      metro: "Купчино",
      halls: 5,
      waitingArea:
        "Большая зона ожидания с мониторами, на которых можно наблюдать занятия детей.",
      parking:
        "Огромная парковка напротив ТЦ «Балкания Нова». Первые три часа парковки — бесплатно по правилам ТЦ.",
      howToGetDetailed: [
        "От метро «Купчино» идти 1–2 минуты — выход в сторону Балканской площади.",
        "Ориентир — торговый центр «Балканский-3». Входы в ТЦ расположены с трёх сторон здания.",
        "Заходите в торговый центр, проходите прямо к центральной части зала, где расположен стеклянный лифт.",
        "Поднимайтесь на лифте на 4 этаж. От лифта поверните направо — вскоре увидите вывеску «Школа танцев Cosmo Dance»."
      ]
    },

    ozerki: {
      name: "Филиал «Озерки»",
      address: "м. «Озерки», пр. Луначарского, д. 1, корп. 1",
      metro: "Озерки",
      halls: 3,
      waitingArea:
        "Уютная зона ожидания на первом этаже жилого дома, также установлены мониторы для просмотра занятий.",
      building:
        "Первый этаж жилого дома, примерно по центру здания. На фасаде размещена вывеска Cosmo Dance.",
      parking:
        "Парковка вдоль дома в «кармане» улицы — можно припарковаться прямо рядом со студией."
    }
  },

  // --- Фишки для детей ---
  kidsFeatures: {
    monitors:
      "Во всех студиях в зоне ожидания установлены мониторы, на которые транслируются занятия из залов. Родители могут наблюдать урок от начала до конца, не заходя в зал и не смущая ребёнка. Это редкая открытость — так работает далеко не каждая школа танцев.",
    dancerDiary:
      "Каждому ребёнку мы дарим «Дневник танцора». В него педагог вклеивает наклейки, ставит отметки за уроки и отмечает достижения. Ребёнок проходит этапы, и по мере продвижения получает небольшие подарки — это сильно повышает мотивацию.",
    concertsIntro:
      "Для детей очень важен результат — возможность выступить на сцене. Мы даём эту возможность всем, кто занимается у нас в течение сезона."
  },

  // --- Годовые концерты ---
  concerts: {
    description:
      "Раз в год Cosmo Dance проводит большой отчётный концерт для всех филиалов.",
    details: [
      "Концерт обычно проходит в конце мая на крупных площадках Санкт-Петербурга.",
      "На сезон 2025/2026 планируется площадка уровня ДК «Выборгский» с вместимостью около 1500 зрителей.",
      "В концерте участвует примерно 1000 наших учеников: дети и взрослые выходят на большую сцену перед родными и друзьями.",
      "Для многих детей это первый серьёзный опыт сцены с освещением, костюмами и настоящими театральными условиями."
    ],
    valueForParents: [
      "Если Вы приводите ребёнка в начале сезона, уже к маю он может выйти на большую сцену в составе своей группы.",
      "Для родителей это уникальный момент: сидеть в зрительном зале и впервые видеть своего ребёнка на сцене большого зала.",
      "Мы помогаем детям не просто выучить связки, а почувствовать себя настоящими артистами."
    ]
  },

  // --- Абонементы и оплата (без конкретных цен) ---
  prices: {
    notes: [
      "Актуальные цены и виды абонементов всегда указаны в разделе «Цены» на сайте cosmo.su.",
      "Стоимость едина для направлений в рамках одной категории (детские/взрослые группы).",
      "На каждое направление можно прийти на пробное занятие. Если после пробного урока Вы покупаете абонемент, сам пробный урок засчитывается как подарок и оплачивать его отдельно не нужно."
    ],
    validity: [
      "У каждого абонемента есть срок действия, в течение которого нужно использовать занятия.",
      "Для детей при болезни мы продлеваем абонемент на период, который ребёнок пропустил. Для этого достаточно предоставить медицинскую справку.",
      "Если семья уезжает в отпуск, можно подтвердить это билетами — мы также продлим срок действия абонемента."
    ],
    family: [
      "В студии действует семейная скидка для тех, кто занимается всей семьёй. Конкретный размер скидки можно уточнить у администратора или на сайте.",
      "Семейная скидка может применяться, когда ходят, например, мама и ребёнок, либо несколько детей из одной семьи."
    ],
    individualLessons: {
      description:
        "Есть возможность заниматься индивидуально с педагогом. Это подходит тем, кто не любит группы, готовится к событию или хочет ускорить прогресс.",
      priceNote:
        "Стоимость индивидуального урока зависит от педагога и направления. В среднем — от ~2200 до ~3500 ₽ за занятие. Точную цену администратор подскажет по выбранному направлению и преподавателю.",
      schedule:
        "Чаще всего индивидуальные занятия ставятся в дневное время до 17:00, когда залы свободнее, но можно подобрать и другое время по договорённости."
    }
  }
};

// ================== ВСПОМОГАТЕЛЬНАЯ ЛОГИКА ==================

function buildSystemPrompt() {
  return `
Вы — чат-бот сети студий танцев Cosmo Dance в Санкт-Петербурге.

Ваша задача:
- отвечать дружелюбно, живо, как реальный администратор;
- обращаться к человеку на «Вы»;
- не пугать новичков, а поддерживать и вдохновлять;
- по возможности приглашать на пробное занятие.

Используйте следующую базу знаний о студии, филиалах, абонементах и особенностях:
${JSON.stringify(KNOWLEDGE_BASE, null, 2)}

Правила ответов:
- Отвечайте кратко и по делу, но тёплым, человеческим языком.
- Если человек спрашивает только адрес — дайте в первую очередь точный адрес и метро.
- Если просит «как пройти» — используйте подробные инструкции из базы знаний.
- Если вопрос про цены — объясните общие принципы и предложите актуальную стоимость посмотреть в разделе «Цены» на сайте или уточнить у администратора.
- Если информации не хватает, честно скажите об этом и предложите оставить номер телефона/написать администратору.
`;
}

// ================== API ЧАТА ==================

app.post("/chat", async (req, res) => {
  try {
    const userMessage =
      req.body.userMessage || req.body.message || req.body.text || "";

    if (!userMessage || typeof userMessage !== "string") {
      return res
        .status(400)
        .json({ error: 'Поле "userMessage" обязательно и должно быть строкой.' });
    }

    if (!OPENAI_API_KEY) {
      return res.status(500).json({
        error: "OPENAI_API_KEY не задан в переменных окружения сервера."
      });
    }

    const openaiResponse = await fetch(
      "https://api.openai.com/v1/chat/completions",
      {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${OPENAI_API_KEY}`
        },
        body: JSON.stringify({
          model: "gpt-4o-mini",
          messages: [
            { role: "system", content: buildSystemPrompt() },
            { role: "user", content: userMessage }
          ]
        })
      }
    );

    const data = await openaiResponse.json();

    if (!openaiResponse.ok) {
      console.error("OpenAI API error:", data);
      return res.status(500).json({
        error: "Ошибка обращения к OpenAI",
        details: data
      });
    }

    const reply =
      data.choices?.[0]?.message?.content?.trim() ||
      "Извините, сейчас не могу ответить. Попробуйте ещё раз чуть позже.";

    res.json({ reply });
  } catch (err) {
    console.error("Server error:", err);
    res.status(500).json({ error: "Внутренняя ошибка сервера" });
  }
});

// Простой healthcheck
app.get("/", (req, res) => {
  res.send("Cosmo_info bot is running.");
});

app.listen(PORT, () => {
  console.log(`Cosmo_info server listening on port ${PORT}`);
});
