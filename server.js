import path from "path";
import { fileURLToPath } from "url";

import express from "express";
import cors from "cors";
import dotenv from "dotenv";
import OpenAI from "openai";

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

dotenv.config();

const app = express();

// --- middlewares ---
app.use(cors());

// Ð¿Ñ€Ð¾Ð±ÑƒÐµÐ¼ ÑÐ½Ð°Ñ‡Ð°Ð»Ð° ÐºÐ°Ðº JSON
app.use(express.json({ limit: "2mb" }));
// Ð½Ð° Ð²ÑÑÐºÐ¸Ð¹ ÑÐ»ÑƒÑ‡Ð°Ð¹ Ð¿Ñ€Ð¸Ð½Ð¸Ð¼Ð°ÐµÐ¼ form-urlencoded Ð¸ Ñ‚ÐµÐºÑÑ‚
app.use(express.urlencoded({ extended: true, limit: "2mb" }));
app.use(
  express.text({
    type: ["text/plain", "application/x-www-form-urlencoded"],
    limit: "2mb",
  })
);

const client = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});

// ================== Ð¡Ð˜Ð¡Ð¢Ð•ÐœÐÐÐ¯ ÐŸÐžÐ”Ð¡ÐšÐÐ—ÐšÐ ==================

const SYSTEM_PROMPT = `
Ð¢Ñ‹ â€” Ñ‚Ñ‘Ð¿Ð»Ñ‹Ð¹ Ð¸ Ð²Ð½Ð¸Ð¼Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¹ Ð°ÑÑÐ¸ÑÑ‚ÐµÐ½Ñ‚ ÑÑ‚ÑƒÐ´Ð¸Ð¸ Ñ‚Ð°Ð½Ñ†ÐµÐ² CosmoDance.

Ð¢Ð²Ð¾Ñ Ð¾Ð±Ð»Ð°ÑÑ‚ÑŒ:
- Ñ„Ð¸Ð»Ð¸Ð°Ð»Ñ‹ ÑÑ‚ÑƒÐ´Ð¸Ð¸ (Ð—Ð²Ñ‘Ð·Ð´Ð½Ð°Ñ, ÐžÐ·ÐµÑ€ÐºÐ¸, Ð”Ñ‹Ð±ÐµÐ½ÐºÐ¾, ÐšÑƒÐ¿Ñ‡Ð¸Ð½Ð¾);
- Ð½Ð°Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ, Ð²Ð¾Ð·Ñ€Ð°ÑÑ‚Ð½Ñ‹Ðµ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð¸, ÑƒÑ€Ð¾Ð²ÐµÐ½ÑŒ (Ð½Ð¾Ð²Ð¸Ñ‡Ð¾Ðº / Ð¿Ñ€Ð¾Ð´Ð¾Ð»Ð¶Ð°ÑŽÑ‰Ð¸Ð¹);
- Ñ€Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ð³Ñ€ÑƒÐ¿Ð¿, Ð¿Ñ€Ð¾Ð±Ð½Ñ‹Ðµ Ð·Ð°Ð½ÑÑ‚Ð¸Ñ;
- Ð°Ð±Ð¾Ð½ÐµÐ¼ÐµÐ½Ñ‚Ñ‹, Ð¾Ð¿Ð»Ð°Ñ‚Ð°, Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð° ÑÑ‚ÑƒÐ´Ð¸Ð¸;
- Ð¿Ð¾Ð¼Ð¾Ñ‰ÑŒ Ñ Ð²Ñ‹Ð±Ð¾Ñ€Ð¾Ð¼ Ð½Ð°Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ Ð´Ð»Ñ Ð²Ð·Ñ€Ð¾ÑÐ»Ð¾Ð³Ð¾ Ð¸Ð»Ð¸ Ñ€ÐµÐ±Ñ‘Ð½ÐºÐ°.

Ð“Ð»Ð°Ð²Ð½Ñ‹Ðµ Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð°:
- ÐžÑ‚Ð²ÐµÑ‡Ð°Ð¹ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¿Ñ€Ð¾ ÑÑ‚ÑƒÐ´Ð¸ÑŽ CosmoDance Ð¸ Ñ‚Ð°Ð½Ñ†Ñ‹.
- ÐžÐ±Ñ€Ð°Ñ‰Ð°Ð¹ÑÑ Ð½Ð° "Ð²Ñ‹", Ð´Ñ€ÑƒÐ¶ÐµÐ»ÑŽÐ±Ð½Ð¾, Ð¿Ñ€Ð¾ÑÑ‚Ñ‹Ð¼ ÑÐ·Ñ‹ÐºÐ¾Ð¼.
- Ð’ÑÐµÐ³Ð´Ð° Ð¾Ð¿Ð¸Ñ€Ð°Ð¹ÑÑ Ð½Ð° Ð±Ð°Ð·Ñƒ Ð·Ð½Ð°Ð½Ð¸Ð¹, ÐµÑÐ»Ð¸ Ð¾Ð½Ð° ÐµÑÑ‚ÑŒ. Ð•ÑÐ»Ð¸ Ð² Ð±Ð°Ð·Ðµ ÐµÑÑ‚ÑŒ Ñ‚Ð¾Ñ‡Ð½Ð°Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ (Ñ€Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ, Ð²Ð¾Ð·Ñ€Ð°ÑÑ‚, ÑƒÑ€Ð¾Ð²ÐµÐ½ÑŒ) â€” Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ ÐµÑ‘.
- Ð¡Ñ‚Ð°Ñ€Ð°Ð¹ÑÑ Ð½Ðµ Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€ÑÑ‚ÑŒ ÑƒÐ¶Ðµ Ð·Ð°Ð´Ð°Ð½Ð½Ñ‹Ðµ Ñ‚Ð¾Ð±Ð¾Ð¹ Ð²Ð¾Ð¿Ñ€Ð¾ÑÑ‹. Ð•ÑÐ»Ð¸ Ð¸Ð· Ð¿Ñ€ÐµÐ´Ñ‹Ð´ÑƒÑ‰Ð¸Ñ… Ñ€ÐµÐ¿Ð»Ð¸Ðº ÑƒÐ¶Ðµ Ð¿Ð¾Ð½ÑÑ‚ÐµÐ½ Ñ„Ð¸Ð»Ð¸Ð°Ð», Ð²Ð¾Ð·Ñ€Ð°ÑÑ‚, Ð½Ð°Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¸ Ñ‚.Ð¿., Ð½Ðµ ÑÐ¿Ñ€Ð°ÑˆÐ¸Ð²Ð°Ð¹ ÑÑ‚Ð¾ ÐµÑ‰Ñ‘ Ñ€Ð°Ð·.
- Ð•ÑÐ»Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð¾Ñ‚Ð²ÐµÑ‡Ð°ÐµÑ‚ Ð² Ð¾Ð´Ð½Ð¾Ð¹ Ñ„Ñ€Ð°Ð·Ðµ Ð½Ð° Ð½ÐµÑÐºÐ¾Ð»ÑŒÐºÐ¾ Ð²Ð¾Ð¿Ñ€Ð¾ÑÐ¾Ð² (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€: "5 Ð»ÐµÑ‚ Ð·Ð²Ñ‘Ð·Ð´Ð½Ð°Ñ" Ð¸Ð»Ð¸ "Ð´Ð»Ñ Ñ€ÐµÐ±Ñ‘Ð½ÐºÐ° 7 Ð»ÐµÑ‚, ÐºÑƒÐ¿Ñ‡Ð¸Ð½Ð¾, Ð½Ð°Ñ‡Ð¸Ð½Ð°ÑŽÑ‰Ð¸Ðµ") â€” Ð°ÐºÐºÑƒÑ€Ð°Ñ‚Ð½Ð¾ Ñ€Ð°Ð·Ð±ÐµÑ€Ð¸ Ñ„Ñ€Ð°Ð·Ñƒ Ð¸ Ð¿Ð¾ÑÑ‚Ð°Ñ€Ð°Ð¹ÑÑ Ð²Ñ‹Ñ‚Ð°Ñ‰Ð¸Ñ‚ÑŒ:
  â€¢ Ñ„Ð¸Ð»Ð¸Ð°Ð»;
  â€¢ Ð²Ð¾Ð·Ñ€Ð°ÑÑ‚;
  â€¢ Ð´Ð»Ñ ÐºÐ¾Ð³Ð¾ Ð·Ð°Ð½ÑÑ‚Ð¸Ñ (Ð²Ð·Ñ€Ð¾ÑÐ»Ñ‹Ð¹ / Ñ€ÐµÐ±Ñ‘Ð½Ð¾Ðº);
  â€¢ ÑƒÑ€Ð¾Ð²ÐµÐ½ÑŒ (Ð½Ð¾Ð²Ð¸Ñ‡Ð¾Ðº / Ñ Ð¾Ð¿Ñ‹Ñ‚Ð¾Ð¼).
- Ð•ÑÐ»Ð¸ Ñ‡ÐµÐ»Ð¾Ð²ÐµÐº Ð¿Ð¸ÑˆÐµÑ‚ Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ°Ð¼Ð¸, Ð±ÐµÐ· Ð·Ð°Ð³Ð»Ð°Ð²Ð½Ñ‹Ñ… Ð±ÑƒÐºÐ² Ð¸Ð»Ð¸ Ð¿Ð¾-ÑÐ²Ð¾ÐµÐ¼Ñƒ Ð¿Ð¸ÑˆÐµÑ‚ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ñ (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€ "Ð·Ð²ÐµÐ·Ð´Ð½Ð°Ñ", "Ð·Ð²Ñ‘Ð·Ð´Ð½Ð¾Ðµ", "ÐºÑƒÑ‡Ð¿Ð¸Ð½Ð¾") â€” Ð¿Ð¾ÑÑ‚Ð°Ñ€Ð°Ð¹ÑÑ Ð´Ð¾Ð³Ð°Ð´Ð°Ñ‚ÑŒÑÑ, Ñ‡Ñ‚Ð¾ Ð¾Ð½ Ð¸Ð¼ÐµÐ» Ð² Ð²Ð¸Ð´Ñƒ, Ð¸ Ð¼ÑÐ³ÐºÐ¾ Ð¿ÐµÑ€ÐµÑ„Ð¾Ñ€Ð¼ÑƒÐ»Ð¸Ñ€ÑƒÐ¹ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾.

Ð Ð°Ð±Ð¾Ñ‚Ð° Ñ Ð²Ð¾Ð·Ñ€Ð°ÑÑ‚Ð¾Ð¼ Ð¸ Ð³Ñ€ÑƒÐ¿Ð¿Ð°Ð¼Ð¸:
- ÐžÐ±Ð¾Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ "16+" Ð¾Ð·Ð½Ð°Ñ‡Ð°ÐµÑ‚, Ñ‡Ñ‚Ð¾ Ð² Ð³Ñ€ÑƒÐ¿Ð¿Ñƒ Ð¿Ñ€Ð¸Ð½Ð¸Ð¼Ð°ÑŽÑ‚ Ð²ÑÐµÑ… ÑÑ‚Ð°Ñ€ÑˆÐµ 16 Ð»ÐµÑ‚ (Ð¸ 20, Ð¸ 30, Ð¸ 40 Ð¸ Ñ‚.Ð´.).
- Ð•ÑÐ»Ð¸ Ñ‡ÐµÐ»Ð¾Ð²ÐµÐº Ð¿ÐµÑ€ÐµÐ¶Ð¸Ð²Ð°ÐµÑ‚, Ñ‡Ñ‚Ð¾ Ð¾Ð½ ÑÑ‚Ð°Ñ€ÑˆÐµ Ð´Ñ€ÑƒÐ³Ð¸Ñ… Ð¸Ð»Ð¸ Ð´Ð°Ð²Ð½Ð¾ Ð½Ðµ Ð·Ð°Ð½Ð¸Ð¼Ð°Ð»ÑÑ, Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶Ð¸ ÐµÐ³Ð¾, Ð¾Ð±ÑŠÑÑÐ½Ð¸, Ñ‡Ñ‚Ð¾:
  â€¢ Ð² Ð³Ñ€ÑƒÐ¿Ð¿Ð°Ñ… Ð¾Ð±Ñ‹Ñ‡Ð½Ð¾ Ñ€Ð°Ð·Ð½Ñ‹Ð¹ Ð²Ð¾Ð·Ñ€Ð°ÑÑ‚;
  â€¢ Ñ…Ð¾Ñ€ÐµÐ¾Ð³Ñ€Ð°Ñ„ Ð°Ð´Ð°Ð¿Ñ‚Ð¸Ñ€ÑƒÐµÑ‚ Ð½Ð°Ð³Ñ€ÑƒÐ·ÐºÑƒ;
  â€¢ Ð¼Ð¾Ð¶Ð½Ð¾ Ð¿Ñ€Ð¸Ð¹Ñ‚Ð¸ Ð½Ð° Ð¿Ñ€Ð¾Ð±Ð½Ð¾Ðµ Ð·Ð°Ð½ÑÑ‚Ð¸Ðµ, Ð¿Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ÐµÑ‚ÑŒ Ð°Ñ‚Ð¼Ð¾ÑÑ„ÐµÑ€Ñƒ.
- Ð”Ð»Ñ Ð²Ð¾Ð·Ñ€Ð°ÑÑ‚Ð¾Ð² 60+ Ð¿Ñ€ÐµÐ´Ð»Ð°Ð³Ð°Ð¹ Ð±Ð¾Ð»ÐµÐµ Ñ‰Ð°Ð´ÑÑ‰Ð¸Ðµ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ñ‹ (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€ Ð·ÑƒÐ¼Ð±Ð°, Ð»Ð°Ñ‚Ð¸Ð½Ð°, Ð¼ÑÐ³ÐºÐ¸Ðµ Ñ„Ð¸Ñ‚Ð½ÐµÑ-Ð³Ñ€ÑƒÐ¿Ð¿Ñ‹), Ð½Ðµ Ð½Ð°Ð²ÑÐ·Ñ‹Ð²Ð°Ð¹ ÑÐ²Ð½Ð¾ Ð¼Ð¾Ð»Ð¾Ð´Ñ‘Ð¶Ð½Ñ‹Ðµ ÑÑ‚Ð¸Ð»Ð¸.

Ð•ÑÐ»Ð¸ Ð²Ð¾Ð¿Ñ€Ð¾Ñ Ð½Ðµ ÑÐ¾Ð²ÑÐµÐ¼ Ð¿Ñ€Ð¾ ÑÑ‚ÑƒÐ´Ð¸ÑŽ, Ð½Ð¾ ÑÐ²ÑÐ·Ð°Ð½ Ñ Ñ‚Ð°Ð½Ñ†Ð°Ð¼Ð¸ (ÑÑ‚Ñ€Ð°Ñ…Ð¸, Ð¼Ð¾Ñ‚Ð¸Ð²Ð°Ñ†Ð¸Ñ, ÑÐ¾Ð¼Ð½ÐµÐ½Ð¸Ñ) â€” Ð¼Ð¾Ð¶Ð½Ð¾ Ð½ÐµÐ½Ð°Ð´Ð¾Ð»Ð³Ð¾ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶Ð°Ñ‚ÑŒ Ñ€Ð°Ð·Ð³Ð¾Ð²Ð¾Ñ€ Ð¸ Ð¼ÑÐ³ÐºÐ¾ Ð¿ÐµÑ€ÐµÐ²ÐµÑÑ‚Ð¸ Ðº Ð²Ñ‹Ð±Ð¾Ñ€Ñƒ Ð½Ð°Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ Ð¸ Ð·Ð°Ð¿Ð¸ÑÐ¸.

Ð•ÑÐ»Ð¸ Ð²Ð¾Ð¿Ñ€Ð¾Ñ Ð²Ð¾Ð¾Ð±Ñ‰Ðµ Ð½Ðµ Ð¿Ñ€Ð¾ Ñ‚Ð°Ð½Ñ†Ñ‹ Ð¸ Ð½Ðµ Ð¿Ñ€Ð¾ ÑÑ‚ÑƒÐ´Ð¸ÑŽ:
- Ð²ÐµÐ¶Ð»Ð¸Ð²Ð¾ Ð½Ð°Ð¿Ð¸ÑˆÐ¸, Ñ‡Ñ‚Ð¾ Ñ‚Ñ‹ Ð¼Ð¾Ð¶ÐµÑˆÑŒ Ð¾Ñ‚Ð²ÐµÑ‡Ð°Ñ‚ÑŒ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¿Ñ€Ð¾ CosmoDance, Ð¸ Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶Ð¸ Ð·Ð°Ð´Ð°Ñ‚ÑŒ Ð²Ð¾Ð¿Ñ€Ð¾Ñ Ð¿Ð¾ ÑÑ‚ÑƒÐ´Ð¸Ð¸.

Ð•ÑÐ»Ð¸ Ñ‚ÐµÐ±Ðµ Ð¿Ð¾ ÐºÐ°ÐºÐ¾Ð¹-Ñ‚Ð¾ Ð¿Ñ€Ð¸Ñ‡Ð¸Ð½Ðµ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ Ð½ÐµÑ‡ÐµÐ³Ð¾ Ð¾Ñ‚Ð²ÐµÑ‚Ð¸Ñ‚ÑŒ (Ð½ÐµÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð² Ð±Ð°Ð·Ðµ, Ð½ÐµÐ¿Ð¾Ð½ÑÑ‚Ð½Ñ‹Ð¹ Ð²Ð¾Ð¿Ñ€Ð¾Ñ), Ð½Ð°Ð¿Ð¸ÑˆÐ¸:
"ÐŸÐ¾Ñ…Ð¾Ð¶Ðµ, Ñ‡Ñ‚Ð¾ Ð² Ð¼Ð¾ÐµÐ¹ Ð±Ð°Ð·Ðµ Ð½ÐµÑ‚ Ñ‚Ð¾Ñ‡Ð½Ð¾Ð³Ð¾ Ð¾Ñ‚Ð²ÐµÑ‚Ð° Ð½Ð° ÑÑ‚Ð¾Ñ‚ Ð²Ð¾Ð¿Ñ€Ð¾Ñ. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ, Ð¿Ð¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð¿ÐµÑ€ÐµÑ„Ð¾Ñ€Ð¼ÑƒÐ»Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ ÐµÐ³Ð¾ Ð¸Ð»Ð¸ ÑƒÑ‚Ð¾Ñ‡Ð½Ð¸Ñ‚ÑŒ, Ñ‡Ñ‚Ð¾ Ð¸Ð¼ÐµÐ½Ð½Ð¾ Ð²Ñ‹ Ñ…Ð¾Ñ‚Ð¸Ñ‚Ðµ ÑƒÐ·Ð½Ð°Ñ‚ÑŒ Ð¿Ñ€Ð¾ ÑÑ‚ÑƒÐ´Ð¸ÑŽ CosmoDance."
`;

// ============== Ð¥Ð ÐÐÐ˜Ð›Ð˜Ð©Ð• Ð‘ÐÐ—Ð« Ð—ÐÐÐÐ˜Ð™ ==============

let KNOWLEDGE_BASE = null;

// Ð²ÑÐ¿Ð¾Ð¼Ð¾Ð³Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð°Ñ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ñ: Ð¿Ñ€ÐµÐ²Ñ€Ð°Ñ‰Ð°ÐµÐ¼ Ð±Ð°Ð·Ñƒ Ð² Ñ‚ÐµÐºÑÑ‚
function buildKnowledgeText(base) {
  if (!base) return "";

  // Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ 1: Ð¼Ð°ÑÑÐ¸Ð² Q/A
  if (Array.isArray(base)) {
    const parts = base.map((item, i) => {
      const q = item.question || item.q || "";
      const a = item.answer || item.a || "";
      return `Q${i + 1}: ${q}\nA${i + 1}: ${a}`;
    });
    if (!parts.length) return "";
    return (
      "\n\nÐ’Ð¾Ñ‚ Ð±Ð°Ð·Ð° Ð·Ð½Ð°Ð½Ð¸Ð¹ CosmoDance (Ð²Ð¾Ð¿Ñ€Ð¾ÑÑ‹ Ð¸ Ð¾Ñ‚Ð²ÐµÑ‚Ñ‹, Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Ð¸Ñ… Ð¼Ð°ÐºÑÐ¸Ð¼Ð°Ð»ÑŒÐ½Ð¾ Ñ‚Ð¾Ñ‡Ð½Ð¾, Ð½Ð¾ ÑÐ²Ð¾Ð¸Ð¼Ð¸ ÑÐ»Ð¾Ð²Ð°Ð¼Ð¸):\n" +
      parts.join("\n\n")
    );
  }

  // Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ 2: { items: [...] }
  if (base.items && Array.isArray(base.items)) {
    const parts = base.items.map((item, i) => {
      const q = item.question || item.q || "";
      const a = item.answer || item.a || "";
      return `Q${i + 1}: ${q}\nA${i + 1}: ${a}`;
    });
    if (!parts.length) return "";
    return (
      "\n\nÐ’Ð¾Ñ‚ Ð±Ð°Ð·Ð° Ð·Ð½Ð°Ð½Ð¸Ð¹ CosmoDance (Ð²Ð¾Ð¿Ñ€Ð¾ÑÑ‹ Ð¸ Ð¾Ñ‚Ð²ÐµÑ‚Ñ‹, Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Ð¸Ñ… Ð¼Ð°ÐºÑÐ¸Ð¼Ð°Ð»ÑŒÐ½Ð¾ Ñ‚Ð¾Ñ‡Ð½Ð¾, Ð½Ð¾ ÑÐ²Ð¾Ð¸Ð¼Ð¸ ÑÐ»Ð¾Ð²Ð°Ð¼Ð¸):\n" +
      parts.join("\n\n")
    );
  }

  return "";
}

// ================== ÐžÐ¢Ð”ÐÐ¢Ð¬ Ð§ÐÐ¢-Ð¡Ð¢Ð ÐÐÐ˜Ð¦Ð£ ==================

app.get("/", (req, res) => {
  res.sendFile(path.join(__dirname, "index.html"), {
    headers: { "Content-Type": "text/html; charset=utf-8" },
  });
});

// ================== ÐŸÐ Ð˜ÐÐœ Ð‘ÐÐ—Ð« /upload ==================

app.post("/upload", (req, res) => {
  try {
    let body = req.body;

    // ÐµÑÐ»Ð¸ Ð¿Ñ€Ð¸ÑˆÑ‘Ð» ÑÑ‹Ñ€Ð¾Ð¹ Ñ‚ÐµÐºÑÑ‚ â€” Ð¿Ñ€Ð¾Ð±ÑƒÐµÐ¼ Ñ€Ð°ÑÐ¿Ð°Ñ€ÑÐ¸Ñ‚ÑŒ ÐºÐ°Ðº JSON
    if (typeof body === "string") {
      try {
        body = JSON.parse(body);
      } catch {
        return res.status(400).json({
          status: "error",
          message: "ÐÐµÐ²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ Ñ€Ð°Ð·Ð¾Ð±Ñ€Ð°Ñ‚ÑŒ Ñ‚ÐµÐ»Ð¾ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ° ÐºÐ°Ðº JSON",
        });
      }
    }

    if (!body) {
      return res
        .status(400)
        .json({ status: "error", message: "ÐŸÑƒÑÑ‚Ð¾Ðµ Ñ‚ÐµÐ»Ð¾ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ°" });
    }

    KNOWLEDGE_BASE = body;

    let count = null;
    if (Array.isArray(body)) count = body.length;
    else if (body.items && Array.isArray(body.items)) count = body.items.length;

    console.log(
      "Ð‘Ð°Ð·Ð° Ð·Ð½Ð°Ð½Ð¸Ð¹ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð°, Ð·Ð°Ð¿Ð¸ÑÐµÐ¹:",
      count !== null ? count : "Ð½ÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ð¾"
    );

    res.json({ status: "ok", message: "Ð‘Ð°Ð·Ð° Ð¿Ñ€Ð¸Ð½ÑÑ‚Ð° Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ", count });
  } catch (e) {
    console.error("ÐžÑˆÐ¸Ð±ÐºÐ° Ð² /upload:", e);
    res
      .status(500)
      .json({ status: "error", message: "ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐµ Ð±Ð°Ð·Ñ‹" });
  }
});

// ================== Ð§ÐÐ¢ /chat ==================

app.post("/chat", async (req, res) => {
  try {
    let body = req.body;

    // ÐµÑÐ»Ð¸ Ð²Ð´Ñ€ÑƒÐ³ Ð¿Ñ€Ð¸ÑˆÑ‘Ð» Ñ‚ÐµÐºÑÑ‚Ð¾Ð¼ â€” Ð¿Ñ€Ð¾Ð±ÑƒÐµÐ¼ Ñ€Ð°ÑÐ¿Ð°Ñ€ÑÐ¸Ñ‚ÑŒ
    if (typeof body === "string") {
      try {
        body = JSON.parse(body);
      } catch {
        body = { text: body };
      }
    }

    body = body || {};

    // Ð¿Ñ€Ð¸Ð½Ð¸Ð¼Ð°ÐµÐ¼ Ñ€Ð°Ð·Ð½Ñ‹Ðµ Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚Ñ‹ Ð¸Ð¼ÐµÐ½Ð¸ Ð¿Ð¾Ð»Ñ
    let userMessage =
      body.userMessage ||
      body.message ||
      body.question ||
      body.text ||
      body.q ||
      "";

    if (typeof userMessage !== "string") {
      userMessage = String(userMessage || "");
    }

    userMessage = userMessage.trim();

    if (!userMessage) {
      // Ð·Ð´ÐµÑÑŒ Ð½Ðµ ÑÑ‡Ð¸Ñ‚Ð°ÐµÐ¼ ÑÑ‚Ð¾ Ð¾ÑˆÐ¸Ð±ÐºÐ¾Ð¹, Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ð¼ÑÐ³ÐºÐ¸Ð¹ Ð¾Ñ‚Ð²ÐµÑ‚
      return res.status(200).json({
        reply: "ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð½Ð°Ð¿Ð¸ÑˆÐ¸Ñ‚Ðµ Ð²Ð°Ñˆ Ð²Ð¾Ð¿Ñ€Ð¾Ñ Ð¾ ÑÑ‚ÑƒÐ´Ð¸Ð¸ CosmoDance ðŸ˜Š",
      });
    }

    // Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ñ Ð´Ð¸Ð°Ð»Ð¾Ð³Ð° (ÐµÑÐ»Ð¸ Ñ„Ñ€Ð¾Ð½Ñ‚ÐµÐ½Ð´ ÐµÑ‘ ÑˆÐ»Ñ‘Ñ‚)
    const history = Array.isArray(body.history) ? body.history : [];

    const knowledgeText = buildKnowledgeText(KNOWLEDGE_BASE);

    const messages = [
      {
        role: "system",
        content: SYSTEM_PROMPT + knowledgeText,
      },
      // Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ñ: Ð¾Ð¶Ð¸Ð´Ð°ÐµÐ¼ Ð¾Ð±ÑŠÐµÐºÑ‚Ñ‹ Ð²Ð¸Ð´Ð° { role: "user" | "assistant", content: "..." }
      ...history
        .filter(
          (m) =>
            m &&
            typeof m.content === "string" &&
            (m.role === "user" || m.role === "assistant")
        )
        .map((m) => ({
          role: m.role,
          content: m.content,
        })),
      {
        role: "user",
        content: userMessage,
      },
    ];

    const completion = await client.chat.completions.create({
      model: "gpt-4.1-mini",
      messages,
      temperature: 0.5,
      max_tokens: 800,
    });

    const reply =
      completion.choices?.[0]?.message?.content?.trim() ||
      "ÐŸÐ¾Ñ…Ð¾Ð¶Ðµ, Ð¼Ð½Ðµ Ð½Ðµ Ñ…Ð²Ð°Ñ‚Ð°ÐµÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ…, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ñ‚Ð¾Ñ‡Ð½Ð¾ Ð¾Ñ‚Ð²ÐµÑ‚Ð¸Ñ‚ÑŒ. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð½ÐµÐ¼Ð½Ð¾Ð³Ð¾ Ð¿ÐµÑ€ÐµÑ„Ð¾Ñ€Ð¼ÑƒÐ»Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð²Ð¾Ð¿Ñ€Ð¾Ñ Ð¿Ñ€Ð¾ ÑÑ‚ÑƒÐ´Ð¸ÑŽ CosmoDance.";

    res.json({ reply });
  } catch (error) {
    console.error("ÐžÑˆÐ¸Ð±ÐºÐ° Ð² /chat:", error);
    // Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÐ¼ 200, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ñ„Ñ€Ð¾Ð½Ñ‚ÐµÐ½Ð´ Ð½Ðµ Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°Ð» "ÑÐµÑ€Ð²ÐµÑ€ Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½"
    res.status(200).json({
      reply:
        "Ð¡ÐµÐ¹Ñ‡Ð°Ñ Ñƒ Ð¼ÐµÐ½Ñ Ð½ÐµÐ±Ð¾Ð»ÑŒÑˆÐ°Ñ Ñ‚ÐµÑ…Ð½Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ð¿Ð°ÑƒÐ·Ð°. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð·Ð°Ð´Ð°Ñ‚ÑŒ Ð²Ð¾Ð¿Ñ€Ð¾Ñ ÐµÑ‰Ñ‘ Ñ€Ð°Ð· Ð¸Ð»Ð¸ Ñ‡ÑƒÑ‚ÑŒ-Ñ‡ÑƒÑ‚ÑŒ Ð¿ÐµÑ€ÐµÑ„Ð¾Ñ€Ð¼ÑƒÐ»Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ ÐµÐ³Ð¾. Ð•ÑÐ»Ð¸ Ð¾ÑˆÐ¸Ð±ÐºÐ° Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€ÑÐµÑ‚ÑÑ, Ð»ÑƒÑ‡ÑˆÐµ Ð½Ð°Ð¿Ð¸ÑÐ°Ñ‚ÑŒ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ñƒ ÑÑ‚ÑƒÐ´Ð¸Ð¸.",
    });
  }
});

// ================== Ð—ÐÐŸÐ£Ð¡Ðš Ð¡Ð•Ð Ð’Ð•Ð Ð ==================

const port = process.env.PORT || 10000;

app.listen(port, () => {
  console.log(`CosmoDance server listening on port ${port}`);
});
