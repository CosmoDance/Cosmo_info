// server.js ‚Äî –ø–æ–ª–Ω–∞—è –≤–µ—Ä—Å–∏—è

import path from "path";
import { fileURLToPath } from "url";
import fs from "fs";

import express from "express";
import cors from "cors";
import dotenv from "dotenv";
import OpenAI from "openai";

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

dotenv.config();

const app = express();
app.use(cors());
app.use(express.json({ limit: "2mb" })); // –ø—Ä–∏–Ω–∏–º–∞–µ–º JSON –¥–æ 2 –ú–ë

// -------- OpenAI –∫–ª–∏–µ–Ω—Ç --------
const client = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});

// -------- –∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ –±–∞–∑—ã –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ --------

let KNOWLEDGE_FILE = null; // –æ–±—â–∞—è —Ç–µ–∫—Å—Ç–æ–≤–∞—è –±–∞–∑–∞ (–æ—Ç–≤–µ—Ç—ã, –ø—Ä–∞–≤–∏–ª–∞, —Ü–µ–Ω—ã –∏ —Ç.–ø.)
let SCHEDULE_FILE = null;  // —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –≤—Å–µ—Ö —Ñ–∏–ª–∏–∞–ª–æ–≤

function safeReadJSON(relativePath) {
  try {
    const fullPath = path.join(__dirname, relativePath);
    if (!fs.existsSync(fullPath)) return null;
    const text = fs.readFileSync(fullPath, "utf8");
    return JSON.parse(text);
  } catch (e) {
    console.error(`–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å ${relativePath}:`, e.message);
    return null;
  }
}

function loadKnowledge() {
  KNOWLEDGE_FILE = safeReadJSON("knowledge.json");
  SCHEDULE_FILE = safeReadJSON("cosmo_schedule_all_branches_ready.json");
  console.log("–ë–∞–∑–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞:",
    "knowledge.json:", !!KNOWLEDGE_FILE,
    "cosmo_schedule_all_branches_ready.json:", !!SCHEDULE_FILE
  );
}

loadKnowledge();

// -------- —Å–∏—Å—Ç–µ–º–Ω–∞—è –ø–æ–¥—Å–∫–∞–∑–∫–∞ --------

function buildSystemPrompt() {
  // –ó–¥–µ—Å—å –º—ã –æ–ø–∏—Å—ã–≤–∞–µ–º –ø–æ–≤–µ–¥–µ–Ω–∏–µ –±–æ—Ç–∞. –≠—Ç–æ –º–æ–∂–Ω–æ –¥–æ–ø–æ–ª–Ω—è—Ç—å —Ç–µ–∫—Å—Ç–æ–º ‚Äî
  // –º–æ–¥–µ–ª—å –±—É–¥–µ—Ç —Å–ª–µ–¥–æ–≤–∞—Ç—å —ç—Ç–∏–º –ø—Ä–∞–≤–∏–ª–∞–º.
  return `
–¢—ã ‚Äî –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç —Å—Ç—É–¥–∏–∏ —Ç–∞–Ω—Ü–µ–≤ CosmoDance (—Ñ–∏–ª–∏–∞–ª—ã: –ó–≤—ë–∑–¥–Ω–∞—è, –û–∑–µ—Ä–∫–∏, –î—ã–±–µ–Ω–∫–æ, –ö—É–ø—á–∏–Ω–æ).
–û—Ç–≤–µ—á–∞–π —Ç–æ–ª—å–∫–æ –ø–æ —Ç–µ–º–µ —Å—Ç—É–¥–∏–∏: –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è, —Ñ–∏–ª–∏–∞–ª—ã, —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ, –≥—Ä—É–ø–ø—ã, —Ü–µ–Ω—ã, –∞–±–æ–Ω–µ–º–µ–Ω—Ç—ã,
–ø—Ä–æ–±–Ω—ã–µ –∑–∞–Ω—è—Ç–∏—è, –ø—Ä–∞–≤–∏–ª–∞ —Å—Ç—É–¥–∏–∏, —É—Ä–æ–≤–Ω–∏ (–Ω–æ–≤–∏—á–æ–∫/–ø—Ä–æ–¥–æ–ª–∂–∞—é—â–∏–µ), –≤–æ–∑—Ä–∞—Å—Ç–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∏ —Ç.–¥.

1. –û–ë–©–ò–ô –°–¢–ò–õ–¨
- –û–±—â–∞–π—Å—è –Ω–∞ ¬´–≤—ã¬ª, —Ç–µ–ø–ª–æ –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–µ.
- –ü–∏—à–∏ –ø—Ä–æ—Å—Ç—ã–º–∏ —Ñ—Ä–∞–∑–∞–º–∏, –±–µ–∑ –∫–∞–Ω—Ü–µ–ª—è—Ä–∏—Ç–∞.
- –í—Å–µ–≥–¥–∞ —Å—Ç–∞—Ä–∞–π—Å—è –ø–æ–º–æ—á—å —á–µ–ª–æ–≤–µ–∫—É —Å–¥–µ–ª–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥: –ø–æ–¥–æ–±—Ä–∞—Ç—å –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ, –≥—Ä—É–ø–ø—É,
  –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –ø—Ä–æ–±–Ω–æ–µ –∑–∞–Ω—è—Ç–∏–µ –∏ —Ç.–ø.
- –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —Å–ª–æ–∂–Ω—ã–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ç–µ—Ä–º–∏–Ω—ã –∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏.

2. –ü–†–ò–í–ï–¢–°–¢–í–ò–Ø
- –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–π –ª—é–±—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–π: ¬´–ø—Ä–∏–≤–µ—Ç¬ª, ¬´–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ¬ª, ¬´–¥–æ–±—Ä—ã–π –≤–µ—á–µ—Ä¬ª,
  ¬´—Ö–∞–π¬ª, ¬´–π–æ—É¬ª, ¬´–¥–æ–±—Ä–æ–µ —É—Ç—Ä–æ¬ª –∏ —Ç.–ø., –¥–∞–∂–µ —Å –æ—à–∏–±–∫–∞–º–∏.
- –í –æ—Ç–≤–µ—Ç –∫–æ—Ä–æ—Ç–∫–æ –ø–æ–∑–¥–æ—Ä–æ–≤–∞–π—Å—è –∏ —Å—Ä–∞–∑—É –ø–æ–¥—Å–∫–∞–∂–∏, —á–µ–º –º–æ–∂–µ—à—å –ø–æ–º–æ—á—å
  (–Ω–∞–ø—Ä–∏–º–µ—Ä: ¬´–ú–æ–≥—É —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å –ø—Ä–æ —Ñ–∏–ª–∏–∞–ª—ã, –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ, –ø–æ–º–æ—á—å –ø–æ–¥–æ–±—Ä–∞—Ç—å
   –≥—Ä—É–ø–ø—É –∏ –∑–∞–ø–∏—Å–∞—Ç—å –Ω–∞ –ø—Ä–æ–±–Ω–æ–µ –∑–∞–Ω—è—Ç–∏–µ¬ª).

3. –ö–û–ù–¢–ï–ö–°–¢ –ò –ò–°–¢–û–†–ò–Ø –î–ò–ê–õ–û–ì–ê
- –í–æ—Å–ø—Ä–∏–Ω–∏–º–∞–π –¥–∏–∞–ª–æ–≥ –∫–∞–∫ –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω—ã–π: —É—á–∏—Ç—ã–≤–∞–π –í–°–ï –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
- –ù–µ –∑–∞–¥–∞–≤–∞–π –ø–æ–≤—Ç–æ—Ä–Ω–æ –≤–æ–ø—Ä–æ—Å—ã, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ –µ—Å—Ç—å –æ—Ç–≤–µ—Ç –≤ –∏—Å—Ç–æ—Ä–∏–∏.
  –ï—Å–ª–∏ —á–µ–ª–æ–≤–µ–∫ —É–∂–µ —É–∫–∞–∑–∞–ª —Ñ–∏–ª–∏–∞–ª, –≤–æ–∑—Ä–∞—Å—Ç, —É—Ä–æ–≤–µ–Ω—å, —Ü–µ–ª—å ‚Äî –Ω–µ —Å–ø—Ä–∞—à–∏–≤–∞–π —ç—Ç–æ –µ—â—ë —Ä–∞–∑.
- –ï—Å–ª–∏ —á–µ–ª–æ–≤–µ–∫ –æ—Ç–≤–µ—á–∞–µ—Ç —Ñ—Ä–∞–∑–æ–π –≤ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–µ, –Ω–∞–ø—Ä–∏–º–µ—Ä:
    ¬´5 –ª–µ—Ç –∑–≤–µ–∑–¥–Ω–∞—è¬ª
  ‚Äî –ø–æ—Å—Ç–∞—Ä–∞–π—Å—è –≤—ã—Ç–∞—â–∏—Ç—å –∏–∑ –Ω–µ—ë —Å—Ä–∞–∑—É –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤:
    –≤–æ–∑—Ä–∞—Å—Ç = 5 –ª–µ—Ç, —Ñ–∏–ª–∏–∞–ª = –ó–≤—ë–∑–¥–Ω–∞—è.
- –ò–≥–Ω–æ—Ä–∏—Ä—É–π —Ä–µ–≥–∏—Å—Ç—Ä, –±—É–∫–≤—ã ¬´—ë/–µ¬ª, –º–µ–ª–∫–∏–µ –æ–ø–µ—á–∞—Ç–∫–∏ –∏ –ø–∞–¥–µ–∂–∏, –µ—Å–ª–∏ —Å–º—ã—Å–ª –ø–æ–Ω—è—Ç–µ–Ω.

4. –î–ï–¢–ò / –í–ó–†–û–°–õ–´–ï –ò –í–´–ë–û–† –ì–†–£–ü–ü
- –°–Ω–∞—á–∞–ª–∞ –≤—ã—è—Å–Ω–∏:
  1) –î–ª—è –∫–æ–≥–æ –∑–∞–Ω—è—Ç–∏—è ‚Äî –¥–ª—è –≤–∑—Ä–æ—Å–ª–æ–≥–æ –∏–ª–∏ –¥–ª—è —Ä–µ–±—ë–Ω–∫–∞?
  2) –ö–∞–∫–æ–π —Ñ–∏–ª–∏–∞–ª —É–¥–æ–±–Ω–µ–µ –ø–æ—Å–µ—â–∞—Ç—å (–ó–≤—ë–∑–¥–Ω–∞—è, –û–∑–µ—Ä–∫–∏, –î—ã–±–µ–Ω–∫–æ, –ö—É–ø—á–∏–Ω–æ)?
- –î–ª—è —Ä–µ–±—ë–Ω–∫–∞:
  - —Å–ø—Ä–æ—Å–∏ –≤–æ–∑—Ä–∞—Å—Ç;
  - —Å–ø—Ä–æ—Å–∏, –µ—Å—Ç—å –ª–∏ —Ç–∞–Ω—Ü–µ–≤–∞–ª—å–Ω—ã–π –æ–ø—ã—Ç (–Ω–æ–≤–∏—á–æ–∫ / –Ω–µ–º–Ω–æ–≥–æ –∑–∞–Ω–∏–º–∞–ª–∏—Å—å / –æ–ø—ã—Ç–Ω—ã–π);
  - —É—Ç–æ—á–Ω–∏ –æ–∂–∏–¥–∞–Ω–∏—è —Ä–æ–¥–∏—Ç–µ–ª—è (–æ–±—â–∞—è —Ñ–∏–∑–∏—á–µ—Å–∫–∞—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞, —Ä–∞–∑–≤–∏—Ç–∏–µ –ø–ª–∞—Å—Ç–∏–∫–∏, —Å—Ü–µ–Ω–∞ –∏ –≤—ã—Å—Ç—É–ø–ª–µ–Ω–∏—è –∏ —Ç.–ø.).
- –î–ª—è –≤–∑—Ä–æ—Å–ª–æ–≥–æ:
  - –º–æ–∂–Ω–æ —Å–ø—Ä–æ—Å–∏—Ç—å, —Ö–æ—á–µ—Ç—Å—è –ª–∏ –±–æ–ª—å—à–µ –ø—Ä–æ –ø–ª–∞—Å—Ç–∏–∫—É, —Ñ–∏—Ç–Ω–µ—Å-–Ω–∞–≥—Ä—É–∑–∫—É, —Ö–∏–ø-—Ö–æ–ø/—Å—Ç—Ä–∏—Ç –∏–ª–∏ –ª–∞—Ç–∏–Ω—É –∏ —Ç.–ø.;
  - –ø–æ –∂–µ–ª–∞–Ω–∏—é ‚Äî –ø—Ä–æ –≤–æ–∑—Ä–∞—Å—Ç –∏ —Ç–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (–Ω–æ –∞–∫–∫—É—Ä–∞—Ç–Ω–æ –∏ –±–µ–∑ –¥–∞–≤–ª–µ–Ω–∏—è).

5. –ù–û–í–ò–ß–ö–ò –ò –ü–°–ò–•–û–õ–û–ì–ò–ß–ï–°–ö–ê–Ø –ü–û–î–î–ï–†–ñ–ö–ê
- –ï—Å–ª–∏ —á–µ–ª–æ–≤–µ–∫ –∏–ª–∏ —Ä–µ–±—ë–Ω–æ–∫ –Ω–æ–≤–∏—á–æ–∫, –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø–æ–¥–¥–µ—Ä–∂–∏:
  - –æ–±—ä—è—Å–Ω–∏, —á—Ç–æ –≤ –≥—Ä—É–ø–ø–∞—Ö –Ω–æ–≤–∏—á–∫–æ–≤ –≤—Å—ë –∏–¥—ë—Ç —Å –Ω—É–ª—è;
  - —Ö–æ—Ä–µ–æ–≥—Ä–∞—Ñ –ø–æ–º–æ–≥–∞–µ—Ç –∏ –ø–æ–¥—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –ø–æ–¥ —Ç–µ–º–ø –≥—Ä—É–ø–ø—ã;
  - –º–æ–∂–Ω–æ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –≤ –≥—Ä—É–ø–ø—É –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç, –ø—Ä–æ–≥—Ä–∞–º–º–∞ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–∞.
- –ï—Å–ª–∏ —á–µ–ª–æ–≤–µ–∫–∞ –≤–æ–ª–Ω—É–µ—Ç –≤–æ–∑—Ä–∞—Å—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, ¬´–∞ –µ—Å–ª–∏ –º–Ω–µ 40?¬ª –¥–ª—è –≥—Ä—É–ø–ø—ã 16+):
  - –æ–±—ä—è—Å–Ω–∏, —á—Ç–æ ¬´16+¬ª –æ–∑–Ω–∞—á–∞–µ—Ç –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –≤–æ–∑—Ä–∞—Å—Ç, –∞ –≤–µ—Ä—Ö–Ω—è—è –≥—Ä–∞–Ω–∏—Ü–∞ –æ—Ç–∫—Ä—ã—Ç–∞—è;
  - –≤ —Ç–∞–∫–∏—Ö –≥—Ä—É–ø–ø–∞—Ö –æ–±—ã—á–Ω–æ –∑–∞–Ω–∏–º–∞—é—Ç—Å—è –ª—é–¥–∏ —Ä–∞–∑–Ω–æ–≥–æ –≤–æ–∑—Ä–∞—Å—Ç–∞;
  - –º–æ–∂–Ω–æ –ø—Ä–∏–π—Ç–∏ –Ω–∞ –ø—Ä–æ–±–Ω–æ–µ –∑–∞–Ω—è—Ç–∏–µ –∏ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å, –∫–æ–º—Ñ–æ—Ä—Ç–Ω–æ –ª–∏ –≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –≥—Ä—É–ø–ø–µ.

6. –í–û–ó–†–ê–°–¢–ù–´–ï –û–ì–†–ê–ù–ò–ß–ï–ù–ò–Ø
- –û–±–æ–∑–Ω–∞—á–µ–Ω–∏—è –≤–∏–¥–∞ ¬´16+¬ª –∏–ª–∏ ¬´12+¬ª –Ω–µ –Ω—É–∂–Ω–æ –ø–æ–¥—á—ë—Ä–∫–∏–≤–∞—Ç—å –≤ –æ–±—ã—á–Ω—ã—Ö –æ—Ç–≤–µ—Ç–∞—Ö.
  –õ—É—á—à–µ –ø–∏—Å–∞—Ç—å –ø–æ-—á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏: ¬´–≥—Ä—É–ø–ø–∞ –¥–ª—è –≤–∑—Ä–æ—Å–ª—ã—Ö –æ—Ç 16 –ª–µ—Ç –∏ —Å—Ç–∞—Ä—à–µ¬ª.
- –ï—Å–ª–∏ —á–µ–ª–æ–≤–µ–∫ —Å—Ç–∞—Ä—à–µ 60‚Äì70 –ª–µ—Ç, –Ω–µ –ø—Ä–µ–¥–ª–∞–≥–∞–π –∂—ë—Å—Ç–∫–∏–µ –º–æ–ª–æ–¥—ë–∂–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã —Ç–∏–ø–∞
  —Å—Ç—Ä–∏–ø/heels/–∂—ë—Å—Ç–∫–∏–π —Ö–∏–ø-—Ö–æ–ø. –õ—É—á—à–µ –ø—Ä–µ–¥–ª–∞–≥–∞–π –º—è–≥–∫–∏–µ –∏–ª–∏ –∫–æ–º—Ñ–æ—Ä—Ç–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã:
  –∑—É–º–±–∞, –ª–∞—Ç–∏–Ω–∞/–ª–∞—Ç–∏–Ω –º–∏–∫—Å, –º—è–≥–∫–∏–µ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–ª–∏ —Ä–∞—Å—Ç—è–∂–∫–∞,
  –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–æ–≥–æ, —á—Ç–æ –æ–Ω —Ö–æ—á–µ—Ç.

7. –†–ê–°–ü–ò–°–ê–ù–ò–ï –ò –§–ò–õ–ò–ê–õ–´
- –£ –∫–∞–∂–¥–æ–π –≥—Ä—É–ø–ø—ã —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –ø–æ –¥–Ω—è–º –Ω–µ–¥–µ–ª–∏ –∏ –≤—Ä–µ–º–µ–Ω–∏.
- –ù–µ —Å–æ–∑–¥–∞–≤–∞–π ¬´–ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–µ¬ª –≤—Ä–µ–º—è. –í—Å–µ–≥–¥–∞ –æ–ø–∏—Ä–∞–π—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ –¥–∞–Ω–Ω—ã–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è,
  –∫–æ—Ç–æ—Ä–æ–µ –ø–µ—Ä–µ–¥–∞–Ω–æ –≤ –±–∞–∑–µ (SCHEDULE_FILE).
- –ì—Ä—É–ø–ø–æ–≤—ã–µ –∑–∞–Ω—è—Ç–∏—è –∏–¥—É—Ç –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é (–æ–±—ã—á–Ω–æ 2‚Äì3 —Ä–∞–∑–∞ –≤ –Ω–µ–¥–µ–ª—é).
  –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –∑–∞–Ω—è—Ç–∏—è ‚Äî –ø–æ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—é —Å —Ç—Ä–µ–Ω–µ—Ä–æ–º –∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.
- –ï—Å–ª–∏ —á–µ–ª–æ–≤–µ–∫ –≤—ã–±–∏—Ä–∞–µ—Ç –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏ —Ñ–∏–ª–∏–∞–ª, –ø—Ä–µ–¥–ª–æ–∂–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –≥—Ä—É–ø–ø—ã —Å –∏—Ö
  —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ–º (–¥–Ω–∏ –Ω–µ–¥–µ–ª–∏ –∏ –≤—Ä–µ–º—è –ø–æ–ª–Ω–æ—Å—Ç—å—é: ¬´–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫, 19:00‚Äì20:00¬ª,
  –∞ –Ω–µ —Å–æ–∫—Ä–∞—â—ë–Ω–Ω–æ ¬´–ü–Ω¬ª).

8. –û–¢–õ–ò–ß–ï–ù–ò–ï ¬´–ö–û–ú–ê–ù–î–ê¬ª –ò ¬´–ù–ê–ß–ò–ù–ê–Æ–©–ò–ï¬ª
- –í —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–∏ –º–æ–≥—É—Ç –±—ã—Ç—å –≥—Ä—É–ø–ø—ã —Å –ø—Ä–∏–∑–Ω–∞–∫–æ–º ¬´–∫–æ–º–∞–Ω–¥–∞¬ª ‚Äî —ç—Ç–æ –±–æ–ª–µ–µ —Å–∏–ª—å–Ω—ã–µ/—Å–±–æ—Ä–Ω—ã–µ –≥—Ä—É–ø–ø—ã,
  –∫—É–¥–∞ –æ–±—ã—á–Ω–æ –ø–æ–ø–∞–¥–∞—é—Ç –ø–æ –∫–∞—Å—Ç–∏–Ω–≥—É –∏ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –æ–ø—ã—Ç–∞.
- –î–ª—è –Ω–æ–≤–∏—á–∫–∞ –ø—Ä–µ–¥–ª–∞–≥–∞–π –≥—Ä—É–ø–ø—ã —É—Ä–æ–≤–Ω—è ¬´–Ω–∞—á–∏–Ω–∞—é—â–∏–µ¬ª, ¬´–±–∞–∑–æ–≤—ã–π¬ª –∏ —Ç.–ø.
- –ï—Å–ª–∏ —á–µ–ª–æ–≤–µ–∫ –ø–∏—à–µ—Ç, —á—Ç–æ —É –Ω–µ–≥–æ –æ–ø—ã—Ç, –º–æ–∂–Ω–æ –∞–∫–∫—É—Ä–∞—Ç–Ω–æ —É–ø–æ–º—è–Ω—É—Ç—å –∫–æ–º–∞–Ω–¥—É, –Ω–æ –≤—Å—ë —Ä–∞–≤–Ω–æ
  –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –ø—Ä–æ–±–Ω–æ–µ –∑–∞–Ω—è—Ç–∏–µ, —á—Ç–æ–±—ã –ø–µ–¥–∞–≥–æ–≥ –æ—Ü–µ–Ω–∏–ª —É—Ä–æ–≤–µ–Ω—å.

9. –§–û–†–ú–ê –ó–ê–Ø–í–ö–ò
- –ö–æ–≥–¥–∞ —á–µ–ª–æ–≤–µ–∫ —É–∂–µ –æ–ø—Ä–µ–¥–µ–ª–∏–ª—Å—è:
  - —Ñ–∏–ª–∏–∞–ª,
  - –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ,
  - –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è –≥—Ä—É–ø–ø–∞/—Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ,
  –∏ –≥–æ–≤–æ—Ä–∏—Ç, —á—Ç–æ —Ö–æ—á–µ—Ç –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –ø—Ä–æ–±–Ω–æ–µ, —Å–¥–µ–ª–∞–π —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —à–∞–≥:
    1) —É—Ç–æ—á–Ω–∏ –∏–º—è –∏ —Ñ–∞–º–∏–ª–∏—é,
    2) –ø–æ–ø—Ä–æ—Å–∏ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞.
- –°—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π –∏—Ç–æ–≥–æ–≤—É—é –º–∏–Ω–∏-–∑–∞—è–≤–∫—É (—á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏–º —Ç–µ–∫—Å—Ç–æ–º), —á—Ç–æ–±—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –±—ã–ª–æ –ø–æ–Ω—è—Ç–Ω–æ:
  –∫—Ç–æ, –≤ –∫–∞–∫–æ–π —Ñ–∏–ª–∏–∞–ª, –Ω–∞ –∫–∞–∫–æ–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ/–≥—Ä—É–ø–ø—É –∏ –≤ –∫–∞–∫–∏–µ –¥–Ω–∏/–≤—Ä–µ–º—è —Ö–æ—á–µ—Ç —Ö–æ–¥–∏—Ç—å.

10. –ï–°–õ–ò –ß–¢–û-–¢–û –ù–ï–ò–ó–í–ï–°–¢–ù–û
- –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –Ω–µ –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ —Å—Ç—É–¥–∏–∏ –∏–ª–∏ –≤–æ–æ–±—â–µ –Ω–µ–ø–æ–Ω—è—Ç–µ–Ω, –º—è–≥–∫–æ –æ–±—ä—è—Å–Ω–∏, —á—Ç–æ —Ç—ã –æ—Ç–≤–µ—á–∞–µ—à—å
  —Ç–æ–ª—å–∫–æ –ø–æ CosmoDance, –∏ –ø—Ä–µ–¥–ª–æ–∂–∏ –∑–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å –ø–æ —Å—Ç—É–¥–∏–∏.
- –ï—Å–ª–∏ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∏–∑ –±–∞–∑—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–µ—Ç —Ç–æ—á–Ω–æ–≥–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è),
  —á–µ—Å—Ç–Ω–æ —Å–∫–∞–∂–∏ –æ–± —ç—Ç–æ–º –∏ –ø—Ä–µ–¥–ª–æ–∂–∏ –æ—Å—Ç–∞–≤–∏—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω –¥–ª—è —Å–≤—è–∑–∏ —Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.
- –ù–µ –ø–∏—à–∏ —Å—Ä–∞–∑—É –ø—Ä–æ ¬´—Ç–µ—Ö–Ω–∏—á–µ—Å–∫—É—é –ø–∞—É–∑—É¬ª. –°–Ω–∞—á–∞–ª–∞ –ø–æ—Å—Ç–∞—Ä–∞–π—Å—è –ª–æ–≥–∏—á–Ω–æ –æ—Ç–≤–µ—Ç–∏—Ç—å, –∏—Å—Ö–æ–¥—è –∏–∑
  –∏–º–µ—é—â–∏—Ö—Å—è –¥–∞–Ω–Ω—ã—Ö. –°–æ–æ–±—â–µ–Ω–∏–µ –≤–∏–¥–∞ ¬´—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ø–∞—É–∑–∞¬ª –∏—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤–Ω—É—Ç—Ä–∏
  –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –∏ —Ç—ã –Ω–µ –º–æ–∂–µ—à—å –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –æ—Ç–≤–µ—Ç.
`;
}

// -------- –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è: —Å–æ–±–∏—Ä–∞–µ–º —Ç–µ–∫—Å—Ç –∏–∑ –±–∞–∑—ã --------

function buildKnowledgeText() {
  let parts = [];

  if (KNOWLEDGE_FILE) {
    parts.push("–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å—Ç—É–¥–∏–∏ CosmoDance –∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π:\n");
    parts.push(JSON.stringify(KNOWLEDGE_FILE, null, 2));
  }

  if (SCHEDULE_FILE && Array.isArray(SCHEDULE_FILE.groups)) {
    // –ö—Ä–∞—Ç–∫–æ –æ–ø–∏—Å—ã–≤–∞–µ–º —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ, –±–µ–∑ –ª–∏—à–Ω–∏—Ö –¥–µ—Ç–∞–ª–µ–π
    const lines = SCHEDULE_FILE.groups.map((g, i) => {
      const days = g.schedule || {};
      const prettyDays = Object.entries(days)
        .filter(([_, v]) => v && String(v).trim() !== "")
        .map(([d, v]) => `${d}: ${v}`)
        .join("; ");

      return `${i + 1}. –§–∏–ª–∏–∞–ª: ${g.branch}. –ì—Ä—É–ø–ø–∞: ${g.group_name}${
        g.level ? " (" + g.level + ")" : ""
      }${g.teacher ? ", –ø–µ–¥–∞–≥–æ–≥: " + g.teacher : ""}${
        prettyDays ? ". –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ: " + prettyDays : ""
      }`;
    });

    parts.push(
      "\n–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –≥—Ä—É–ø–ø –ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º (–∏—Å–ø–æ–ª—å–∑—É–π —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ, –Ω–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π –Ω–æ–≤–æ–µ –≤—Ä–µ–º—è):\n" +
        lines.join("\n")
    );
  }

  return parts.length ? "\n\n" + parts.join("\n\n") : "";
}

// -------- –º–∞—Ä—à—Ä—É—Ç—ã --------

// –û—Ç–¥–∞—ë–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–∞—Ç–∞
app.get("/", (req, res) => {
  res.sendFile(path.join(__dirname, "index.html"), {
    headers: { "Content-Type": "text/html; charset=utf-8" },
  });
});

// –ó–¥–æ—Ä–æ–≤—å–µ —Å–µ—Ä–≤–∏—Å–∞ (–¥–ª—è Render)
app.get("/health", (req, res) => {
  res.send("ok");
});

// –ü—Ä–∏—ë–º –æ–±–Ω–æ–≤–ª—ë–Ω–Ω–æ–π –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π / —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è —Å –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ upload.js
app.post("/upload", (req, res) => {
  try {
    const body = req.body;
    if (!body) {
      return res
        .status(400)
        .json({ status: "error", message: "–ü—É—Å—Ç–æ–µ —Ç–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞" });
    }

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∫ knowledge.json (–º–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å –ø–æ–¥ —Å–µ–±—è)
    const targetPath = path.join(__dirname, "knowledge.json");
    fs.writeFileSync(targetPath, JSON.stringify(body, null, 2), "utf8");

    KNOWLEDGE_FILE = body;

    console.log(
      "–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π –æ–±–Ω–æ–≤–ª–µ–Ω–∞ —á–µ—Ä–µ–∑ /upload, —Ä–∞–∑–º–µ—Ä:",
      JSON.stringify(body).length,
      "–±–∞–π—Ç"
    );
    return res.json({
      status: "ok",
      message: "–ë–∞–∑–∞ –ø—Ä–∏–Ω—è—Ç–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ",
    });
  } catch (e) {
    console.error("–û—à–∏–±–∫–∞ –≤ /upload:", e);
    return res.status(500).json({
      status: "error",
      message: "–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –±–∞–∑—ã",
    });
  }
});

// –û—Å–Ω–æ–≤–Ω–æ–π —á–∞—Ç
app.post("/chat", async (req, res) => {
  try {
    // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å —Ä–∞–∑–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã —Ç–µ–ª–∞, —á—Ç–æ–±—ã –Ω–µ –ø–∞–¥–∞—Ç—å
    const body = req.body || {};

    // –í–∞—Ä–∏–∞–Ω—Ç 1: —Ñ—Ä–æ–Ω—Ç –ø—Ä–∏—Å—ã–ª–∞–µ—Ç –≥–æ—Ç–æ–≤—ã–π –º–∞—Å—Å–∏–≤ messages [{role, content}, ...]
    let clientMessages = Array.isArray(body.messages) ? body.messages : null;

    // –í–∞—Ä–∏–∞–Ω—Ç 2: –æ–¥–∏–Ω –≤–æ–ø—Ä–æ—Å + –∏—Å—Ç–æ—Ä–∏—è –≤ —Å–≤–æ—ë–º —Ñ–æ—Ä–º–∞—Ç–µ
    const userMessage = body.userMessage || body.message || body.text;
    const history = Array.isArray(body.history) ? body.history : null;

    let messages = [];

    const system = buildSystemPrompt() + buildKnowledgeText();
    messages.push({ role: "system", content: system });

    if (clientMessages && clientMessages.length > 0) {
      // –°—á–∏—Ç–∞–µ–º, —á—Ç–æ –∫–ª–∏–µ–Ω—Ç —É–∂–µ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–ª –¥–∏–∞–ª–æ–≥
      messages = [{ role: "system", content: system }, ...clientMessages];
    } else {
      // –°–æ–±–∏—Ä–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –≤—Ä—É—á–Ω—É—é, –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å
      if (history) {
        for (const msg of history) {
          if (!msg) continue;
          const role =
            msg.role === "assistant" || msg.role === "bot"
              ? "assistant"
              : "user";
          if (!msg.content) continue;
          messages.push({ role, content: String(msg.content) });
        }
      }

      if (userMessage) {
        messages.push({ role: "user", content: String(userMessage) });
      }
    }

    // –ï—Å–ª–∏ –ø–æ—Å–ª–µ –≤—Å–µ–≥–æ —É –Ω–∞—Å —Ç–æ–ª—å–∫–æ system ‚Äî –∑–Ω–∞—á–∏—Ç, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–ø–∏—Å–∞–ª
    if (messages.length <= 1) {
      return res.json({
        reply:
          "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å –æ —Å—Ç—É–¥–∏–∏ CosmoDance üòä –Ø –ø–æ–º–æ–≥—É —Å —Ñ–∏–ª–∏–∞–ª–∞–º–∏, –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º–∏ –∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ–º.",
      });
    }

    const completion = await client.chat.completions.create({
      model: "gpt-4.1-mini",
      messages,
      temperature: 0.6,
      max_tokens: 900,
    });

    const reply =
      completion.choices?.[0]?.message?.content?.trim() ||
      "–ò–∑–≤–∏–Ω–∏—Ç–µ, —É –º–µ–Ω—è –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å —á—É—Ç—å –∏–Ω–∞—á–µ –∏–ª–∏ –∑–∞–¥–∞–π—Ç–µ –¥—Ä—É–≥–æ–π –≤–æ–ø—Ä–æ—Å –ø–æ —Å—Ç—É–¥–∏–∏.";

    return res.json({ reply });
  } catch (e) {
    console.error("–û—à–∏–±–∫–∞ –≤ /chat:", e);

    // –í–ê–ñ–ù–û: –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º 200 –∏ –Ω–æ—Ä–º–∞–ª—å–Ω—ã–π JSON, —á—Ç–æ–±—ã
    // —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–ª –∫—Ä–∞—Å–Ω—É—é –æ—à–∏–±–∫—É ¬´–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞¬ª.
    return res.status(200).json({
      reply:
        "–ò–∑–≤–∏–Ω–∏—Ç–µ, —Å–µ–π—á–∞—Å —É –º–µ–Ω—è –Ω–µ–±–æ–ª—å—à–∞—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ø–∞—É–∑–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å –µ—â—ë —Ä–∞–∑ –∏–ª–∏ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –µ–≥–æ. –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è, –º–æ–∂–Ω–æ –Ω–∞–ø–∏—Å–∞—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É —Å—Ç—É–¥–∏–∏.",
    });
  }
});

// –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞ (Render –≤–æ–∑—å–º—ë—Ç PORT –∏–∑ –æ–∫—Ä—É–∂–µ–Ω–∏—è)
const port = process.env.PORT || 10000;
app.listen(port, () => {
  console.log(`CosmoDance server listening on port ${port}`);
});
