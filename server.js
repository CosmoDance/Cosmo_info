import path from "path";
import { fileURLToPath } from "url";
import fs from "fs";
import express from "express";
import cors from "cors";
import dotenv from "dotenv";
import OpenAI from "openai";

dotenv.config();

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const app = express();
app.use(cors());
app.use(express.json({ limit: "2mb" })); // Ð¿Ñ€Ð¸Ð½Ð¸Ð¼Ð°ÐµÐ¼ JSON Ð´Ð¾ 2 ÐœÐ‘

// ----------------- OpenAI ÐºÐ»Ð¸ÐµÐ½Ñ‚ -----------------
const client = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});

// ----------------- Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð±Ð°Ð·Ñ‹ Ð·Ð½Ð°Ð½Ð¸Ð¹ -----------------
let KNOWLEDGE_BASE = null;          // Ñ‚Ð¾, Ñ‡Ñ‚Ð¾ Ñ‚Ñ‹ Ð·Ð°Ð»Ð¸Ð²Ð°ÐµÑˆÑŒ Ñ‡ÐµÑ€ÐµÐ· upload.js
let SCHEDULE_BASE = null;           // cosmo_schedule_all_branches_ready.json

// ÐŸÑ‹Ñ‚Ð°ÐµÐ¼ÑÑ Ð¿Ñ€Ð¾Ñ‡Ð¸Ñ‚Ð°Ñ‚ÑŒ Ñ€Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ 4 Ñ„Ð¸Ð»Ð¸Ð°Ð»Ð¾Ð² Ð¸Ð· Ñ„Ð°Ð¹Ð»Ð° Ð² Ð¿Ð°Ð¿ÐºÐµ Ñ Ð±Ð¾Ñ‚Ð¾Ð¼
try {
  const schedulePath = path.join(__dirname, "cosmo_schedule_all_branches_ready.json");
  if (fs.existsSync(schedulePath)) {
    const raw = fs.readFileSync(schedulePath, "utf-8");
    SCHEDULE_BASE = JSON.parse(raw);
    console.log(
      "Ð Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ñ„Ð¸Ð»Ð¸Ð°Ð»Ð¾Ð² Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ð¾, Ð³Ñ€ÑƒÐ¿Ð¿:",
      Array.isArray(SCHEDULE_BASE.groups) ? SCHEDULE_BASE.groups.length : "Ð½ÐµÑ‚ Ð¼Ð°ÑÑÐ¸Ð²Ð° groups"
    );
  } else {
    console.log("Ð¤Ð°Ð¹Ð» Ñ€Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸Ñ cosmo_schedule_all_branches_ready.json Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½");
  }
} catch (e) {
  console.error("ÐžÑˆÐ¸Ð±ÐºÐ° Ñ‡Ñ‚ÐµÐ½Ð¸Ñ Ñ€Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸Ñ:", e);
}

// ----------------- Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð½Ð°Ñ Ð¿Ð¾Ð´ÑÐºÐ°Ð·ÐºÐ° -----------------
const SYSTEM_PROMPT = `
Ð¢Ñ‹ â€” Ð´Ñ€ÑƒÐ¶ÐµÐ»ÑŽÐ±Ð½Ñ‹Ð¹ Ð°ÑÑÐ¸ÑÑ‚ÐµÐ½Ñ‚ ÑÑ‚ÑƒÐ´Ð¸Ð¸ Ñ‚Ð°Ð½Ñ†ÐµÐ² CosmoDance.

Ð—ÐÐ”ÐÐ§Ð:
- ÐŸÐ¾Ð¼Ð¾Ð³Ð°ÐµÑˆÑŒ Ñ Ð²Ñ‹Ð±Ð¾Ñ€Ð¾Ð¼ Ñ„Ð¸Ð»Ð¸Ð°Ð»Ð°, Ð½Ð°Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ Ð¸ Ð³Ñ€ÑƒÐ¿Ð¿Ñ‹ Ð¿Ð¾ Ñ€Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸ÑŽ.
- Ð Ð°Ð±Ð¾Ñ‚Ð°ÐµÑˆÑŒ ÐºÐ°Ðº Ñ Ð²Ð·Ñ€Ð¾ÑÐ»Ñ‹Ð¼Ð¸, Ñ‚Ð°Ðº Ð¸ Ñ Ð´ÐµÑ‚ÑŒÐ¼Ð¸.
- Ð’ÑÐµÐ³Ð´Ð° Ð¾Ð¿Ð¸Ñ€Ð°ÐµÑˆÑŒÑÑ Ð½Ð° Ñ€Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ð³Ñ€ÑƒÐ¿Ð¿, Ð° Ð½Ðµ Ð½Ð° Ð°Ð±ÑÑ‚Ñ€Ð°ÐºÑ‚Ð½Ð¾Ðµ "ÑƒÑ‚Ñ€Ð¾/Ð´ÐµÐ½ÑŒ/Ð²ÐµÑ‡ÐµÑ€".
- Ð£Ñ‡Ð¸Ñ‚Ñ‹Ð²Ð°ÐµÑˆÑŒ Ð²Ð¾Ð·Ñ€Ð°ÑÑ‚, Ð¾Ð¿Ñ‹Ñ‚ Ð¸ Ñ†ÐµÐ»Ð¸ (Ð´Ð»Ñ Ñ€ÐµÐ±Ñ‘Ð½ÐºÐ° Ð¸ Ð²Ð·Ñ€Ð¾ÑÐ»Ð¾Ð³Ð¾).

Ð¤Ð˜Ð›Ð˜ÐÐ›Ð«:
- Ð—Ð²Ñ‘Ð·Ð´Ð½Ð°Ñ
- ÐžÐ·ÐµÑ€ÐºÐ¸
- Ð”Ñ‹Ð±ÐµÐ½ÐºÐ¾
- ÐšÑƒÐ¿Ñ‡Ð¸Ð½Ð¾

Ð ÐÐ¡ÐŸÐ˜Ð¡ÐÐÐ˜Ð•:
- Ð’ Ð³Ñ€ÑƒÐ¿Ð¿Ð¾Ð²Ñ‹Ñ… Ð·Ð°Ð½ÑÑ‚Ð¸ÑÑ… Ð²Ð°Ð¶Ð½Ð¾ ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ð¾Ðµ Ñ€Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ (Ð´Ð½Ð¸ Ð¸ Ð²Ñ€ÐµÐ¼Ñ).
- ÐšÐ°Ð¶Ð´Ð°Ñ Ð³Ñ€ÑƒÐ¿Ð¿Ð° Ð¿Ñ€Ð¸Ð²ÑÐ·Ð°Ð½Ð° Ðº ÑÐ²Ð¾ÐµÐ¼Ñƒ Ñ€Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸ÑŽ, "Ð² Ð»ÑŽÐ±Ð¾Ðµ Ð²Ñ€ÐµÐ¼Ñ" Ð½ÐµÐ»ÑŒÐ·Ñ.
- Ð˜Ð½Ð´Ð¸Ð²Ð¸Ð´ÑƒÐ°Ð»ÑŒÐ½Ñ‹Ðµ Ð·Ð°Ð½ÑÑ‚Ð¸Ñ Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ñ‹ Ð² Ñ€Ð°Ð·Ð½Ð¾Ðµ Ð²Ñ€ÐµÐ¼Ñ Ð¿Ð¾ Ð´Ð¾Ð³Ð¾Ð²Ð¾Ñ€Ñ‘Ð½Ð½Ð¾ÑÑ‚Ð¸ Ñ Ñ‚Ñ€ÐµÐ½ÐµÑ€Ð¾Ð¼.

ÐÐžÐ’Ð˜Ð§ÐšÐ˜:
- "ÐÐ¾Ð²Ð¸Ñ‡Ð¾Ðº", "Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð½Ð°Ñ‡Ð¸Ð½Ð°ÑŽ", "Ð±ÐµÐ· Ð¾Ð¿Ñ‹Ñ‚Ð°" = Ð½Ð°Ñ‡Ð¸Ð½Ð°ÑŽÑ‰Ð¸Ð¹ ÑƒÑ€Ð¾Ð²ÐµÐ½ÑŒ.
- Ð£Ñ‚Ð¾Ñ‡Ð½ÑÐ¹ Ð²Ð¾Ð·Ñ€Ð°ÑÑ‚ Ð¸ Ñ†ÐµÐ»Ð¸, ÐµÑÐ»Ð¸ Ñ‡ÐµÐ»Ð¾Ð²ÐµÐº ÑÑ‚Ð¾Ð³Ð¾ ÐµÑ‰Ñ‘ Ð½Ðµ Ð½Ð°Ð¿Ð¸ÑÐ°Ð».
- Ð”Ð»Ñ Ð´ÐµÑ‚ÐµÐ¹ Ð¼Ð¾Ð¶Ð½Ð¾ ÑÐ¿Ñ€Ð¾ÑÐ¸Ñ‚ÑŒ, ÐµÑÑ‚ÑŒ Ð»Ð¸ Ð¾Ð¿Ñ‹Ñ‚, Ð½Ð¾ Ð±ÐµÐ· Ð´Ð°Ð²Ð»ÐµÐ½Ð¸Ñ.

ÐšÐžÐœÐÐÐ”Ð« / ÐŸÐ ÐžÐ”Ð’Ð˜ÐÐ£Ð¢Ð«Ð•:
- Ð“Ñ€ÑƒÐ¿Ð¿Ñ‹ ÑƒÑ€Ð¾Ð²Ð½Ñ "ÐºÐ¾Ð¼Ð°Ð½Ð´Ð°" Ð¸Ð»Ð¸ ÑÐ²Ð½Ð¾ Ð¿Ñ€Ð¾Ð´Ð²Ð¸Ð½ÑƒÑ‚Ñ‹Ðµ Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´ÑƒÐ¹ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¿Ñ€Ð¸ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ð¸ Ð¾Ð¿Ñ‹Ñ‚Ð°.
- Ð•ÑÐ»Ð¸ Ñ‡ÐµÐ»Ð¾Ð²ÐµÐº Ð±ÐµÐ· Ð¾Ð¿Ñ‹Ñ‚Ð°, ÑÐ¿Ð¾ÐºÐ¾Ð¹Ð½Ð¾ Ð¾Ð±ÑŠÑÑÐ½Ð¸, Ñ‡Ñ‚Ð¾ Ð² ÐºÐ¾Ð¼Ð°Ð½Ð´Ñƒ Ð¿Ð¾Ð¿Ð°Ð´Ð°ÑŽÑ‚ Ð¿Ð¾ ÐºÐ°ÑÑ‚Ð¸Ð½Ð³Ñƒ.

Ð’ÐžÐ—Ð ÐÐ¡Ð¢:
- Ð•ÑÐ»Ð¸ Ñ‡ÐµÐ»Ð¾Ð²ÐµÐº ÑÐ¿Ñ€Ð°ÑˆÐ¸Ð²Ð°ÐµÑ‚ "16+", Ð¾Ð±ÑŠÑÑÐ½Ð¸, Ñ‡Ñ‚Ð¾ Ñ‚ÑƒÐ´Ð° Ð¼Ð¾Ð¶Ð½Ð¾ Ð¸ Ð² 30, Ð¸ Ð² 40, Ð¸ ÑÑ‚Ð°Ñ€ÑˆÐµ.
- Ð•ÑÐ»Ð¸ Ð²Ð¾Ð·Ñ€Ð°ÑÑ‚ 60â€“70+, Ð¼ÑÐ³ÐºÐ¾ Ð¸Ð·Ð±ÐµÐ³Ð°Ð¹ ÑÐ²Ð½Ð¾ Ð¼Ð¾Ð»Ð¾Ð´Ñ‘Ð¶Ð½Ñ‹Ñ… ÑÑ‚Ð¸Ð»ÐµÐ¹ (ÑÑ‚Ñ€Ð¸Ñ‚, Ñ…Ð¸Ð¿-Ñ…Ð¾Ð¿, ÑÑ‚Ñ€Ð¸Ð¿, high heels) Ð¸ Ð¿Ñ€ÐµÐ´Ð»Ð°Ð³Ð°Ð¹ Ð±Ð¾Ð»ÐµÐµ Ð¼ÑÐ³ÐºÐ¸Ðµ Ð½Ð°Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ (Ð·ÑƒÐ¼Ð±Ð°, Ð»Ð°Ñ‚Ð¸Ð½Ð¾, Ñ„Ð¸Ñ‚Ð½ÐµÑ Ð¸ Ñ‚.Ð¿.).

ÐŸÐ¡Ð˜Ð¥ÐžÐ›ÐžÐ“Ð˜Ð§Ð•Ð¡ÐšÐÐ¯ ÐŸÐžÐ”Ð”Ð•Ð Ð–ÐšÐ:
- Ð•ÑÐ»Ð¸ Ñ‡ÐµÐ»Ð¾Ð²ÐµÐº Ð¿ÐµÑ€ÐµÐ¶Ð¸Ð²Ð°ÐµÑ‚, Ñ‡Ñ‚Ð¾ Ð²ÑÐµ ÑƒÐ¶Ðµ "Ñ‚Ð°Ð½Ñ†ÑƒÑŽÑ‚ Ð»ÑƒÑ‡ÑˆÐµ", Ð¾Ð±ÑŠÑÑÐ½Ð¸, Ñ‡Ñ‚Ð¾:
  - Ð¼Ð¾Ð¶Ð½Ð¾ Ð¿Ñ€Ð¸Ð¹Ñ‚Ð¸ Ð½Ð° Ð¿Ñ€Ð¾Ð±Ð½Ð¾Ðµ Ð·Ð°Ð½ÑÑ‚Ð¸Ðµ Ð¸ Ð¿Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ÐµÑ‚ÑŒ ÑÐ¾ÑÑ‚Ð°Ð² Ð³Ñ€ÑƒÐ¿Ð¿Ñ‹;
  - Ñ…Ð¾Ñ€ÐµÐ¾Ð³Ñ€Ð°Ñ„ Ð¿Ð¾Ð¼Ð¾Ð³Ð°ÐµÑ‚ Ð½Ð¾Ð²Ð¸Ñ‡ÐºÐ°Ð¼ Ð¸ Ð°Ð´Ð°Ð¿Ñ‚Ð¸Ñ€ÑƒÐµÑ‚ Ð¿Ñ€Ð¾Ð³Ñ€Ð°Ð¼Ð¼Ñƒ;
  - Ð¿Ñ€Ð¸ÑÐ¾ÐµÐ´Ð¸Ð½Ð¸Ñ‚ÑŒÑÑ Ð¼Ð¾Ð¶Ð½Ð¾ Ð½Ð° Ð»ÑŽÐ±Ð¾Ð¼ ÑÑ‚Ð°Ð¿Ðµ.

ÐŸÐ Ð˜Ð’Ð•Ð¢Ð¡Ð¢Ð’Ð˜Ð¯:
- Ð Ð°ÑÐ¿Ð¾Ð·Ð½Ð°Ð²Ð°Ð¹ Ð»ÑŽÐ±Ñ‹Ðµ Ñ„Ð¾Ñ€Ð¼Ñ‹ Ð¿Ñ€Ð¸Ð²ÐµÑ‚ÑÑ‚Ð²Ð¸Ñ: "Ð¿Ñ€Ð¸Ð²ÐµÑ‚", "Ð·Ð´Ñ€Ð°Ð²ÑÑ‚Ð²ÑƒÐ¹Ñ‚Ðµ", "Ð´Ð¾Ð±Ñ€Ñ‹Ð¹ Ð´ÐµÐ½ÑŒ", "Ð´Ð¾Ð±Ñ€Ñ‹Ð¹ Ð²ÐµÑ‡ÐµÑ€", "Ñ…Ð°Ð¹", "ÐºÑƒ", "Ð·Ð´Ð¾Ñ€Ð¾Ð²Ð¾" Ð¸ Ñ‚.Ð¿., Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ°Ð¼Ð¸ Ð¸ ÑÐ¼Ð¾Ð´Ð·Ð¸.
- Ð•ÑÐ»Ð¸ Ñ‡ÐµÐ»Ð¾Ð²ÐµÐº Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ð·Ð´Ð¾Ñ€Ð¾Ð²Ð°ÐµÑ‚ÑÑ, ÐºÐ¾Ñ€Ð¾Ñ‚ÐºÐ¾ Ð¿Ð¾Ð¿Ñ€Ð¸Ð²ÐµÑ‚ÑÑ‚Ð²ÑƒÐ¹ Ð¸ Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶Ð¸ Ð·Ð°Ð´Ð°Ñ‚ÑŒ Ð²Ð¾Ð¿Ñ€Ð¾Ñ Ð¾ ÑÑ‚ÑƒÐ´Ð¸Ð¸.

Ð˜Ð¡Ð¢ÐžÐ Ð˜Ð¯ Ð”Ð˜ÐÐ›ÐžÐ“Ð:
- Ð¢Ñ‹ Ð²Ð¸Ð´Ð¸ÑˆÑŒ Ð¿Ñ€ÐµÐ´Ñ‹Ð´ÑƒÑ‰Ð¸Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð¸ ÑÐ²Ð¾Ð¸ Ð¾Ñ‚Ð²ÐµÑ‚Ñ‹.
- ÐÐ• Ð·Ð°Ð´Ð°Ð²Ð°Ð¹ Ð¾Ð´Ð¸Ð½ Ð¸ Ñ‚Ð¾Ñ‚ Ð¶Ðµ ÑƒÑ‚Ð¾Ñ‡Ð½ÑÑŽÑ‰Ð¸Ð¹ Ð²Ð¾Ð¿Ñ€Ð¾Ñ Ð²Ñ‚Ð¾Ñ€Ð¾Ð¹ Ñ€Ð°Ð·, ÐµÑÐ»Ð¸ Ð¾Ñ‚Ð²ÐµÑ‚ ÑƒÐ¶Ðµ Ð±Ñ‹Ð».
- Ð•ÑÐ»Ð¸ ÑƒÐ¶Ðµ Ð·Ð½Ð°ÐµÑˆÑŒ Ñ„Ð¸Ð»Ð¸Ð°Ð», Ð²Ð¾Ð·Ñ€Ð°ÑÑ‚, Ð½Ð°Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¸ Ñ‚.Ð¿. â€” Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ ÑÑ‚Ð¾ Ð¸ Ð½Ðµ Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€ÑÐ¹ Ð²Ð¾Ð¿Ñ€Ð¾ÑÑ‹.

Ð•Ð¡Ð›Ð˜ ÐÐ• ÐŸÐžÐÐ¯Ð› Ð’ÐžÐŸÐ ÐžÐ¡:
- Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹ Ð¾Ñ‚Ð²ÐµÑ‚Ð¸Ñ‚ÑŒ Ð»Ð¾Ð³Ð¸Ñ‡ÐµÑÐºÐ¸ Ð² Ñ€Ð°Ð¼ÐºÐ°Ñ… ÑÑ‚ÑƒÐ´Ð¸Ð¸.
- Ð•ÑÐ»Ð¸ Ð²ÑÑ‘ Ñ€Ð°Ð²Ð½Ð¾ Ð½Ðµ Ð¿Ð¾Ð»ÑƒÑ‡Ð°ÐµÑ‚ÑÑ, Ð½Ð°Ð¿Ð¸ÑˆÐ¸:
  "ÐŸÐ¾Ñ…Ð¾Ð¶Ðµ, Ð² Ð¼ÐµÐ½Ñ Ð½Ðµ Ð·Ð°Ð»Ð¾Ð¶Ð¸Ð»Ð¸ Ñ‚Ð¾Ñ‡Ð½Ñ‹Ð¹ Ð¾Ñ‚Ð²ÐµÑ‚ Ð½Ð° ÑÑ‚Ð¾Ñ‚ Ð²Ð¾Ð¿Ñ€Ð¾Ñ. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ ÑÑ„Ð¾Ñ€Ð¼ÑƒÐ»Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð¿Ð¾-Ð´Ñ€ÑƒÐ³Ð¾Ð¼Ñƒ Ð¸Ð»Ð¸ ÑƒÑ‚Ð¾Ñ‡Ð½Ð¸Ñ‚ÑŒ, Ñ‡Ñ‚Ð¾ Ð¸Ð¼ÐµÐ½Ð½Ð¾ Ð²Ð°Ñ Ð¸Ð½Ñ‚ÐµÑ€ÐµÑÑƒÐµÑ‚."
- ÐÐ• ÑƒÑ…Ð¾Ð´Ð¸ Ð² Ð±ÐµÑÐºÐ¾Ð½ÐµÑ‡Ð½ÑƒÑŽ "Ñ‚ÐµÑ…Ð½Ð¸Ñ‡ÐµÑÐºÑƒÑŽ Ð¿Ð°ÑƒÐ·Ñƒ" Ð±ÐµÐ· Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÐ¸ Ð¿Ð¾Ð¼Ð¾Ñ‡ÑŒ.

Ð¤ÐžÐ ÐœÐ Ð—ÐÐŸÐ˜Ð¡Ð˜:
- Ð•ÑÐ»Ð¸ Ñ‡ÐµÐ»Ð¾Ð²ÐµÐº ÑƒÐ¶Ðµ Ð²Ñ‹Ð±Ñ€Ð°Ð» Ñ„Ð¸Ð»Ð¸Ð°Ð», Ð½Ð°Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ, ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½ÑƒÑŽ Ð³Ñ€ÑƒÐ¿Ð¿Ñƒ Ð¸ Ñ€Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ, Ð¸ ÑÐ²Ð½Ð¾ Ð³Ð¾Ð²Ð¾Ñ€Ð¸Ñ‚, Ñ‡Ñ‚Ð¾ Ñ…Ð¾Ñ‡ÐµÑ‚ Ð·Ð°Ð¿Ð¸ÑÐ°Ñ‚ÑŒÑÑ:
  - Ð£Ñ‚Ð¾Ñ‡Ð½Ð¸ Ð¸Ð¼Ñ Ð¸ Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½.
  - Ð¡Ñ„Ð¾Ñ€Ð¼ÑƒÐ»Ð¸Ñ€ÑƒÐ¹ ÐºÐ¾Ñ€Ð¾Ñ‚ÐºÐ¾Ðµ Ñ€ÐµÐ·ÑŽÐ¼Ðµ Ð·Ð°ÑÐ²ÐºÐ¸ (Ñ„Ð¸Ð»Ð¸Ð°Ð», Ð½Ð°Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ, Ð³Ñ€ÑƒÐ¿Ð¿Ð°, Ñ€Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ, Ð¸Ð¼Ñ, Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½).
  - Ð¡ÐºÐ°Ð¶Ð¸, Ñ‡Ñ‚Ð¾ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€ ÑÑ‚ÑƒÐ´Ð¸Ð¸ ÑÐ²ÑÐ¶ÐµÑ‚ÑÑ Ð² Ñ€Ð°Ð±Ð¾Ñ‡ÐµÐµ Ð²Ñ€ÐµÐ¼Ñ Ð´Ð»Ñ Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ñ Ð·Ð°Ð¿Ð¸ÑÐ¸.

Ð¢Ð¾Ð»ÑŒÐºÐ¾ Ð²Ð¾Ð¿Ñ€Ð¾ÑÑ‹ Ð¾ ÑÑ‚ÑƒÐ´Ð¸Ð¸ CosmoDance. ÐÐ° Ð¾ÑÑ‚Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ñ‚ÐµÐ¼Ñ‹ Ð²ÐµÐ¶Ð»Ð¸Ð²Ð¾ Ð¾Ñ‚Ð²ÐµÑ‚ÑŒ, Ñ‡Ñ‚Ð¾ Ñ‚Ñ‹ Ð°ÑÑÐ¸ÑÑ‚ÐµÐ½Ñ‚ ÑÑ‚ÑƒÐ´Ð¸Ð¸ Ð¸ Ð¿Ð¾Ð¼Ð¾Ð³Ð°ÐµÑˆÑŒ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¿Ð¾ Ð²Ð¾Ð¿Ñ€Ð¾ÑÐ°Ð¼ ÑÑ‚ÑƒÐ´Ð¸Ð¸.
`;

// ----------------- /  â€” Ð¾Ñ‚Ð´Ð°Ñ‚ÑŒ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñƒ Ñ‡Ð°Ñ‚Ð° -----------------
app.get("/", (req, res) => {
  res.sendFile(path.join(__dirname, "index.html"), {
    headers: { "Content-Type": "text/html; charset=utf-8" },
  });
});

// ----------------- /upload â€” Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð±Ð°Ð·Ñ‹ Ð·Ð½Ð°Ð½Ð¸Ð¹ Ð¸Ð· upload.js -----------------
app.post("/upload", (req, res) => {
  try {
    if (!req.body) {
      return res.status(400).json({ status: "error", message: "ÐŸÑƒÑÑ‚Ð¾Ðµ Ñ‚ÐµÐ»Ð¾ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ°" });
    }

    KNOWLEDGE_BASE = req.body;
    let count = null;

    if (Array.isArray(KNOWLEDGE_BASE)) {
      count = KNOWLEDGE_BASE.length;
    } else if (KNOWLEDGE_BASE.items && Array.isArray(KNOWLEDGE_BASE.items)) {
      count = KNOWLEDGE_BASE.items.length;
    }

    console.log("Ð‘Ð°Ð·Ð° Ð·Ð½Ð°Ð½Ð¸Ð¹ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð°, Ð·Ð°Ð¿Ð¸ÑÐµÐ¹:", count ?? "Ð½ÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ð¾");
    return res.json({ status: "ok", message: "Ð‘Ð°Ð·Ð° Ð¿Ñ€Ð¸Ð½ÑÑ‚Ð° Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ", count });
  } catch (e) {
    console.error("ÐžÑˆÐ¸Ð±ÐºÐ° Ð² /upload:", e);
    return res
      .status(500)
      .json({ status: "error", message: "ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐµ Ð±Ð°Ð·Ñ‹" });
  }
});

// ----------------- Ð’ÑÐ¿Ð¾Ð¼Ð¾Ð³Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð°Ñ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ñ: Ñ‚ÐµÐºÑÑ‚ Ð¸Ð· Ð±Ð°Ð·Ñ‹ -----------------
function buildKnowledgeText() {
  let text = "";

  if (KNOWLEDGE_BASE) {
    if (Array.isArray(KNOWLEDGE_BASE)) {
      text += "\n\nÐ’Ð¾Ñ‚ Ð±Ð°Ð·Ð° Ð²Ð¾Ð¿Ñ€Ð¾ÑÐ¾Ð² Ð¸ Ð¾Ñ‚Ð²ÐµÑ‚Ð¾Ð² Ð¾ ÑÑ‚ÑƒÐ´Ð¸Ð¸ CosmoDance. Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ ÐµÑ‘ ÐºÐ°Ðº Ð¸ÑÑ‚Ð¾Ñ‡Ð½Ð¸Ðº Ñ‚Ð¾Ñ‡Ð½Ñ‹Ñ… Ñ„Ð°ÐºÑ‚Ð¾Ð²:\n";
      text += KNOWLEDGE_BASE
        .map(
          (item, i) =>
            `Q${i + 1}: ${item.question || item.q || ""}\nA${i + 1}: ${
              item.answer || item.a || ""
            }`
        )
        .join("\n\n");
    } else if (KNOWLEDGE_BASE.items && Array.isArray(KNOWLEDGE_BASE.items)) {
      text += "\n\nÐ’Ð¾Ñ‚ Ð±Ð°Ð·Ð° Ð²Ð¾Ð¿Ñ€Ð¾ÑÐ¾Ð² Ð¸ Ð¾Ñ‚Ð²ÐµÑ‚Ð¾Ð² Ð¾ ÑÑ‚ÑƒÐ´Ð¸Ð¸ CosmoDance. Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ ÐµÑ‘ ÐºÐ°Ðº Ð¸ÑÑ‚Ð¾Ñ‡Ð½Ð¸Ðº Ñ‚Ð¾Ñ‡Ð½Ñ‹Ñ… Ñ„Ð°ÐºÑ‚Ð¾Ð²:\n";
      text += KNOWLEDGE_BASE.items
        .map(
          (item, i) =>
            `Q${i + 1}: ${item.question || item.q || ""}\nA${i + 1}: ${
              item.answer || item.a || ""
            }`
        )
        .join("\n\n");
    }
  }

  if (SCHEDULE_BASE && Array.isArray(SCHEDULE_BASE.groups)) {
    text +=
      "\n\nÐÐ¸Ð¶Ðµ Ñ€Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ð³Ñ€ÑƒÐ¿Ð¿ Ð¿Ð¾ Ñ„Ð¸Ð»Ð¸Ð°Ð»Ð°Ð¼. Ð¡Ñ‚Ñ€Ð¾Ð³Ð¾ Ð¾Ð¿Ð¸Ñ€Ð°Ð¹ÑÑ Ð½Ð° Ð½ÐµÐ³Ð¾ Ð¿Ñ€Ð¸ Ð¿Ð¾Ð´Ð±Ð¾Ñ€Ðµ Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚Ð¾Ð²:\n";
    text += SCHEDULE_BASE.groups
      .map((g, i) => {
        const branch = g.branch || "";
        const name = g.group_name || "";
        const level = g.level || "";
        const teacher = g.teacher || "";
        const sched = g.schedule || {};
        const days = Object.entries(sched)
          .filter(([, v]) => v && String(v).trim() !== "")
          .map(([d, v]) => `${d}: ${v}`)
          .join(", ");
        return `Ð“Ñ€ÑƒÐ¿Ð¿Ð° ${i + 1}: Ñ„Ð¸Ð»Ð¸Ð°Ð» ${branch}, "${name}"${
          level ? ` (${level})` : ""
        }${teacher ? `, Ð¿Ñ€ÐµÐ¿Ð¾Ð´: ${teacher}` : ""}. Ð—Ð°Ð½ÑÑ‚Ð¸Ñ: ${days}`;
      })
      .join("\n");
  }

  return text;
}

// ----------------- /chat â€” Ð¾ÑÐ½Ð¾Ð²Ð½Ð¾Ð¹ Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚ Ñ‡Ð°Ñ‚Ð° -----------------
app.post("/chat", async (req, res) => {
  try {
    const body = req.body || {};
    const rawMessage = body.message ?? body.userMessage ?? "";
    const userMessage = String(rawMessage || "").trim();

    // Ð˜ÑÑ‚Ð¾Ñ€Ð¸Ñ Ð´Ð¸Ð°Ð»Ð¾Ð³Ð° Ñ Ñ„Ñ€Ð¾Ð½Ñ‚Ð°: [{ role: "user" | "assistant", content: "..." }, ...]
    const history = Array.isArray(body.history) ? body.history : [];

    if (!userMessage) {
      // ÐÐ•Ð¢ Ð¿ÐµÑ‚Ð»Ð¸ â€” Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ð¼ÑÐ³ÐºÐ¸Ð¹ Ð¾Ñ‚Ð²ÐµÑ‚
      return res.json({
        reply: "ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð½Ð°Ð¿Ð¸ÑˆÐ¸Ñ‚Ðµ Ð²Ð°Ñˆ Ð²Ð¾Ð¿Ñ€Ð¾Ñ Ð¾ ÑÑ‚ÑƒÐ´Ð¸Ð¸ CosmoDance ðŸ˜Š",
      });
    }

    const knowledgeText = buildKnowledgeText();

    const messages = [
      {
        role: "system",
        content: SYSTEM_PROMPT + knowledgeText,
      },
      // Ð˜ÑÑ‚Ð¾Ñ€Ð¸Ñ: ÑÑ‚Ñ€Ð¾Ð³Ð¾ user/assistant
      ...history.map((m) => ({
        role: m.role === "assistant" ? "assistant" : "user",
        content: String(m.content || ""),
      })),
      { role: "user", content: userMessage },
    ];

    const completion = await client.chat.completions.create({
      model: "gpt-4.1-mini",
      messages,
      temperature: 0.5,
      max_tokens: 800,
    });

    const reply =
      completion.choices?.[0]?.message?.content?.trim() ||
      "Ð˜Ð·Ð²Ð¸Ð½Ð¸Ñ‚Ðµ, Ñƒ Ð¼ÐµÐ½Ñ Ð½Ðµ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ð»Ð¾ÑÑŒ ÑÑ„Ð¾Ñ€Ð¼Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð¾Ñ‚Ð²ÐµÑ‚. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð¿ÐµÑ€ÐµÑ„Ð¾Ñ€Ð¼ÑƒÐ»Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð²Ð¾Ð¿Ñ€Ð¾Ñ.";

    return res.json({ reply });
  } catch (error) {
    console.error("ÐžÑˆÐ¸Ð±ÐºÐ° Ð² /chat:", error);
    return res.status(500).json({
      reply:
        "Ð˜Ð·Ð²Ð¸Ð½Ð¸Ñ‚Ðµ, ÑÐµÐ¹Ñ‡Ð°Ñ Ñƒ Ð¼ÐµÐ½Ñ Ñ‚ÐµÑ…Ð½Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ð¿Ð°ÑƒÐ·Ð°. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð·Ð°Ð´Ð°Ñ‚ÑŒ Ð²Ð¾Ð¿Ñ€Ð¾Ñ Ñ‡ÑƒÑ‚ÑŒ Ð¿Ð¾Ð·Ð¶Ðµ Ð¸Ð»Ð¸ ÑÐ²ÑÐ¶Ð¸Ñ‚ÐµÑÑŒ Ñ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð¾Ð¼ ÑÑ‚ÑƒÐ´Ð¸Ð¸.",
    });
  }
});

// ----------------- Ð—Ð°Ð¿ÑƒÑÐº ÑÐµÑ€Ð²ÐµÑ€Ð° -----------------
const port = process.env.PORT || 10000;
app.listen(port, () => {
  console.log(`CosmoDance server listening on port ${port}`);
});
